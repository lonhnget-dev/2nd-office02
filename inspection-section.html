<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Inspection Management System</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- FileSaver for downloading files -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <!-- Docx for generating Word documents -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.1.0/docx.min.js"></script>
  <style>
    :root {
      --primary-color: #3498db;
      --success-color: #27ae60;
      --warning-color: #f39c12;
      --danger-color: #e74c3c;
    }
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
    }
    .page-header {
      background: #fff;
      color: #2c3e50;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
    }

    /* Statistics Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
      transition: transform 0.3s ease;
    }

    .stat-card:hover {
      transform: translateY(-5px);
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 5px;
    }

    .stat-inspections {
      color: var(--primary-color);
    }

    .stat-penalties {
      color: var(--warning-color);
    }

    .stat-fines {
      color: var(--danger-color);
    }

    .stat-followups {
      color: var(--success-color);
    }

    .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .stat-icon {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .icon-inspections {
      color: var(--primary-color);
    }

    .icon-penalties {
      color: var(--warning-color);
    }

    .icon-fines {
      color: var(--danger-color);
    }

    .icon-followups {
      color: var(--success-color);
    }

    /* Inspection Tabs */
    .inspection-tabs {
      background: #fff;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
      overflow: hidden;
    }

    .inspection-tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    .inspection-tab.active {
      background: #f8f9fa;
      border-bottom-color: var(--primary-color);
      font-weight: 600;
      color: var(--primary-color);
    }

    .inspection-tab:hover {
      background: #f8f9fa;
    }

    .inspection-content {
      display: none;
    }

    .inspection-content.active {
      display: block;
    }

    .control-section {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
    }

    .table-container {
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
    }

    .table-wrapper {
      overflow-x: auto;
    }

    /* Status badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b8e0e6;
    }
    .status-warning {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .status-success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    /* Penalty sections */
    .penalty-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      border: 1px solid #e1e5e9;
    }

    .penalty-options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    .penalty-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 2px solid #d1d9e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    .penalty-option.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    .penalty-details {
      display: none;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #e1e5e9;
    }
    .penalty-details.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    .company-info-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #e1e5e9;
    }
    .followup-info {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #2ecc71;
    }
    .document-flow {
      background: #e8f4fd;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #3498db;
    }
    .flow-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }

    .flow-step.completed {
      color: var(--success-color);
    }

    .flow-step.pending {
      color: var(--warning-color);
    }

    .document-format-section {
      background: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      margin: 15px 0;
      border: 1px dashed #3498db;
    }
    .format-preview {
      background: white;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #e1e5e9;
      margin-top: 10px;
      max-height: 300px;
      overflow-y: auto;
    }
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .btn-group-vertical .btn {
      margin-bottom: 5px;
    }
    .document-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .template-upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 5px;
      padding: 20px;
      text-align: center;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
    }
    .template-upload-area:hover {
      border-color: var(--primary-color);
      background: #e3f2fd;
    }
  </style>
</head>

<body>
  <div class="container-fluid">

    <!-- Inspection Management Section -->
    <section id="inspectionmanagement-section">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-search"></i> គ្រប់គ្រងអធិការកិច្ច</h1>
        <p class="text-muted mb-0">Inspection Management System</p>
      </header>

      <!-- Statistics Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon icon-inspections">
            <i class="bi bi-clipboard-check"></i>
          </div>
          <div class="stat-number stat-inspections" id="totalInspections">0</div>
          <div class="stat-label">ការត្រួតពិនិត្យសរុប</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-penalties">
            <i class="bi bi-exclamation-triangle"></i>
          </div>
          <div class="stat-number stat-penalties" id="inspectionsWithPenalties">0</div>
          <div class="stat-label">ការត្រួតពិនិត្យមានកំហិត</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-fines">
            <i class="bi bi-cash-coin"></i>
          </div>
          <div class="stat-number stat-fines" id="inspectionsWithFines">0</div>
          <div class="stat-label">ការត្រួតពិនិត្យមានផាក</div>
        </div>
        <div class="stat-card">
          <div class="stat-icon icon-followups">
            <i class="bi bi-arrow-repeat"></i>
          </div>
          <div class="stat-number stat-followups" id="totalFollowups">0</div>
          <div class="stat-label">ការតាមដានសរុប</div>
        </div>
      </div>

      <!-- Inspection Tabs -->
      <div class="inspection-tabs d-flex">
        <div class="inspection-tab active" data-tab="initial">
          <i class="bi bi-clipboard"></i>
          <span>ការត្រួតពិនិត្យដំបូង</span>
        </div>
        <div class="inspection-tab" data-tab="penalty-followup">
          <i class="bi bi-arrow-repeat"></i>
          <span>តាមដានកំហិត</span>
        </div>
        <div class="inspection-tab" data-tab="fine-followup">
          <i class="bi bi-file-earmark-text"></i>
          <span>តាមដានឯកសារផាក</span>
        </div>
        <div class="inspection-tab" data-tab="document-templates">
          <i class="bi bi-file-earmark-arrow-up"></i>
          <span>ទំរង់ឯកសារ</span>
        </div>
      </div>

      <!-- Initial Inspection Tab -->
      <div class="inspection-content active" id="initial-inspection">
        <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <button class="btn btn-primary" id="openInspectionForm">
            <i class="bi bi-plus-circle"></i> ការត្រួតពិនិត្យថ្មី
          </button>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="search" class="form-control" id="inspectionSearch" placeholder="ស្វែងរកការត្រួតពិនិត្យ..."
              style="width: auto;">
            <button class="btn btn-outline-secondary" id="exportInspectionExcel">
              <i class="bi bi-download"></i> ទាញយក Excel
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table class="table table-hover mb-0" id="inspectionTable">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>លេខចូល</th>
                  <th>រោងចក្រ</th>
                  <th>កាលបរិច្ឆេទ</th>
                  <th>កំហិត</th>
                  <th>ផាក</th>
                  <th>ស្ថានភាព</th>
                  <th>សកម្មភាព</th>
                </tr>
              </thead>
              <tbody id="inspectionTableBody">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <div class="loading"></div> កំពុងផ្ទុកទិន្នន័យ...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Penalty Follow-up Tab -->
      <div class="inspection-content" id="penalty-followup-inspection">
        <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <button class="btn btn-primary" id="openPenaltyFollowupForm">
            <i class="bi bi-plus-circle"></i> តាមដានកំហិតថ្មី
          </button>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="search" class="form-control" id="penaltyFollowupSearch" placeholder="ស្វែងរកការតាមដាន..."
              style="width: auto;">
            <button class="btn btn-outline-secondary" id="exportPenaltyFollowupExcel">
              <i class="bi bi-download"></i> ទាញយក Excel
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table class="table table-hover mb-0" id="penaltyFollowupTable">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>លេខចូល</th>
                  <th>រោងចក្រ</th>
                  <th>ក្រុម</th>
                  <th>កាលបរិច្ឆេទតាមដាន</th>
                  <th>កាលបរិច្ឆេទកំហិតដើម</th>
                  <th>ស្ថានភាពតាមដាន</th>
                  <th>សកម្មភាព</th>
                </tr>
              </thead>
              <tbody id="penaltyFollowupTableBody">
                <tr>
                  <td colspan="8" class="text-center text-muted py-4">
                    <div class="loading"></div> កំពុងផ្ទុកទិន្នន័យ...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Fine Document Follow-up Tab -->
      <div class="inspection-content" id="fine-followup-inspection">
        <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <button class="btn btn-primary" id="openFineFollowupForm">
            <i class="bi bi-plus-circle"></i> តាមដានឯកសារផាកថ្មី
          </button>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="search" class="form-control" id="fineFollowupSearch" placeholder="ស្វែងរកការតាមដានឯកសារ..."
              style="width: auto;">
            <button class="btn btn-outline-secondary" id="exportFineFollowupExcel">
              <i class="bi bi-download"></i> ទាញយក Excel
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table class="table table-hover mb-0" id="fineFollowupTable">
              <thead class="table-light">
                <tr>
                  <th>#</th>
                  <th>លេខចូល</th>
                  <th>រោងចក្រ</th>
                  <th>កាលបរិច្ឆេទ</th>
                  <th>ព័ត៌មានផាក</th>
                  <th>ស្ថានភាព</th>
                  <th>សកម្មភាព</th>
                </tr>
              </thead>
              <tbody id="fineFollowupTableBody">
                <tr>
                  <td colspan="7" class="text-center text-muted py-4">
                    <div class="loading"></div> កំពុងផ្ទុកទិន្នន័យ...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Document Templates Tab -->
      <div class="inspection-content" id="document-templates-inspection">
        <div class="control-section">
          <h4><i class="bi bi-file-earmark-text"></i> គ្រប់គ្រងទំរង់ឯកសារ</h4>
          <p class="text-muted">អាចបង្កើត និងគ្រប់គ្រងទំរង់ឯកសារ DOCX សម្រាប់ដំណាក់កាលទាំងបីនៃការត្រួតពិនិត្យ</p>
        </div>

        <div class="row">
          <!-- Inspection Document Template -->
          <div class="col-md-4 mb-4">
            <div class="card h-100">
              <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard"></i> ទំរង់អធិការកិច្ច</h5>
              </div>
              <div class="card-body">
                <p>ទំរង់សម្រាប់ការត្រួតពិនិត្យដំបូង</p>
                <div class="document-format-section">
                  <h6>ទំរង់បច្ចុប្បន្ន</h6>
                  <div class="format-preview" id="inspectionTemplatePreview">
                    <p>ទំរង់លំនាំដើម - អធិការកិច្ច</p>
                  </div>
                  <div class="document-actions">
                    <button class="btn btn-sm btn-outline-primary" id="uploadInspectionTemplate">
                      <i class="bi bi-upload"></i> ផ្ទុកឡើង DOCX
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="downloadInspectionTemplate">
                      <i class="bi bi-download"></i> ទាញយក DOCX
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Penalty Follow-up Document Template -->
          <div class="col-md-4 mb-4">
            <div class="card h-100">
              <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> ទំរង់តាមដានកំហិត</h5>
              </div>
              <div class="card-body">
                <p>ទំរង់សម្រាប់ការតាមដានការអនុវត្តកំហិត</p>
                <div class="document-format-section">
                  <h6>ទំរង់បច្ចុប្បន្ន</h6>
                  <div class="format-preview" id="penaltyTemplatePreview">
                    <p>ទំរង់លំនាំដើម - តាមដានកំហិត</p>
                  </div>
                  <div class="document-actions">
                    <button class="btn btn-sm btn-outline-primary" id="uploadPenaltyTemplate">
                      <i class="bi bi-upload"></i> ផ្ទុកឡើង DOCX
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="downloadPenaltyTemplate">
                      <i class="bi bi-download"></i> ទាញយក DOCX
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Fine Document Template -->
          <div class="col-md-4 mb-4">
            <div class="card h-100">
              <div class="card-header bg-danger text-white">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> ទំរង់តាមដានឯកសារផាក</h5>
              </div>
              <div class="card-body">
                <p>ទំរង់សម្រាប់ការតាមដានឯកសារផាក</p>
                <div class="document-format-section">
                  <h6>ទំរង់បច្ចុប្បន្ន</h6>
                  <div class="format-preview" id="fineTemplatePreview">
                    <p>ទំរង់លំនាំដើម - តាមដានឯកសារផាក</p>
                  </div>
                  <div class="document-actions">
                    <button class="btn btn-sm btn-outline-primary" id="uploadFineTemplate">
                      <i class="bi bi-upload"></i> ផ្ទុកឡើង DOCX
                    </button>
                    <button class="btn btn-sm btn-outline-success" id="downloadFineTemplate">
                      <i class="bi bi-download"></i> ទាញយក DOCX
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </div>

  <!-- All Modals (Inspection, Penalty Follow-up, Fine Follow-up) -->
  <!-- Initial Inspection Modal -->
  <div class="modal fade" id="inspectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="inspectionModalTitle">ការត្រួតពិនិត្យថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="inspectionForm">
            <div class="row g-3">
              <!-- Basic Information -->
              <div class="col-md-4">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ក្រុម *</label>
                <select class="form-select" name="group" required>
                  <option value="">-- ជ្រើសរើសក្រុម --</option>
                  <option value="ក្រុម ក">ក្រុម ក</option>
                  <option value="ក្រុម ខ">ក្រុម ខ</option>
                  <option value="ក្រុម គ">ក្រុម គ</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">កាលបរិច្ឆេទត្រួតពិនិត្យ *</label>
                <input type="date" class="form-control" name="inspection_date" required>
              </div>
              <!-- Inspection Type -->
              <div class="col-md-6">
                <label class="form-label">ប្រភេទអធិការកិច្ច *</label>
                <select class="form-select" name="inspection_type" required>
                  <option value="">-- ជ្រើសរើសប្រភេទ --</option>
                  <option value="អធិការពិសេស">អធិការពិសេស</option>
                  <option value="អធិការសាមញ្ញ">អធិការសាមញ្ញ</option>
                </select>
              </div>

              <!-- Company Information Section -->
              <div class="col-12">
                <div class="company-info-section">
                  <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">ឈ្មោះរោងចក្រ *</label>
                      <select class="form-select" id="factorySelect" name="factory_name" required>
                        <option value="">-- ជ្រើសរើសរោងចក្រ --</option>
                      </select>
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">វិស័យ *</label>
                      <input type="text" class="form-control" name="sector" required placeholder="បញ្ចូលវិស័យ...">
                    </div>

                    <div class="col-md-4">
                      <label class="form-label">ប្រធានបទ *</label>
                      <input type="text" class="form-control" name="case_subject" required
                        placeholder="បញ្ចូលប្រធានបទ...">
                    </div>
                  </div>

                  <!-- Address Fields -->
                  <div class="row g-3 mt-2">
                    <div class="col-md-3">
                      <label class="form-label">ភូមិ *</label>
                      <input type="text" class="form-control" name="village" required placeholder="បញ្ចូលភូមិ...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ឃុំ *</label>
                      <input type="text" class="form-control" name="commune" required placeholder="បញ្ចូលឃុំ...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ស្រុក *</label>
                      <input type="text" class="form-control" name="district" required placeholder="បញ្ចូលស្រុក...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ខេត្ត *</label>
                      <input type="text" class="form-control" name="province" required placeholder="បញ្ចូលខេត្ត...">
                    </div>
                  </div>
                </div>
              </div>

              <!-- កំហិត Section -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-exclamation-triangle"></i> កំហិត (អ្វីដែលរោងចក្រត្រូវកែលម្អ)</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="penalty_yes_option">
                      <input type="radio" name="has_penalty" value="មាន" onchange="togglePenaltyDetails(true)">
                      <span>មាន</span>
                    </label>
                    <label class="penalty-option" id="penalty_no_option">
                      <input type="radio" name="has_penalty" value="គ្មាន" onchange="togglePenaltyDetails(false)">
                      <span>គ្មាន</span>
                    </label>
                  </div>
                  <div class="penalty-details" id="penalty_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">បែបបទ</label>
                        <input type="text" class="form-control" name="penalty_format" placeholder="បញ្ចូលបែបបទកំហិត...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">លក្ខខណ្ឌ</label>
                        <input type="text" class="form-control" name="penalty_condition"
                          placeholder="បញ្ចូលលក្ខខណ្ឌកំហិត...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">សុខភាពនិងសុវត្ថភាព</label>
                        <textarea class="form-control" name="penalty_health" rows="3"
                          placeholder="បញ្ចូលព័ត៌មានសុខភាពនិងសុវត្ថភាព..."></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">វិជ្ជាជីវៈ</label>
                        <textarea class="form-control" name="penalty_professional" rows="3"
                          placeholder="បញ្ចូលព័ត៌មានវិជ្ជាជីវៈ..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ផាក Section -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-cash-coin"></i> ផាក</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="fine_yes_option">
                      <input type="radio" name="has_fine" value="មាន" onchange="toggleFineDetails(true)">
                      <span>មាន</span>
                    </label>
                    <label class="penalty-option" id="fine_no_option">
                      <input type="radio" name="has_fine" value="គ្មាន" onchange="toggleFineDetails(false)">
                      <span>គ្មាន</span>
                    </label>
                  </div>
                  <div class="fine-details" id="fine_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">បែបបទ</label>
                        <input type="text" class="form-control" name="fine_format"
                          placeholder="បញ្ចូលបែបបទត្រូវផាក ">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">លក្ខខណ្ឌ</label>
                        <input type="text" class="form-control" name="fine_condition"
                          placeholder="បញ្ចូលបែបបទត្រូវផាក ">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">សុខភាពនិងសុវត្ថភាព</label>
                        <textarea class="form-control" name="fine_health" rows="3"
                          placeholder="បញ្ចូលបែបបទត្រូវផាក "></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">វិជ្ជាជីវៈ</label>
                        <textarea class="form-control" name="fine_professional" rows="3"
                          placeholder="បញ្ចូលបែបបទត្រូវផាក "></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">ផ្សេងៗ</label>
                <textarea class="form-control" name="remarks" rows="3" placeholder="បញ្ចូលផ្សេងៗ..."></textarea>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="inspectionSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Penalty Follow-up Modal -->
  <div class="modal fade" id="penaltyFollowupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="penaltyFollowupModalTitle">តាមដានកំហិតថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="penaltyFollowupForm">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ការត្រួតពិនិត្យដើម *</label>
                <select class="form-select" name="original_inspection" id="originalInspectionSelect" required
                  onchange="loadOriginalInspectionData()">
                  <option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">កាលបរិច្ឆេទតាមដាន *</label>
                <input type="date" class="form-control" name="followup_date" required>
              </div>
              <!-- Company Information Display (Read-only) -->
              <div class="col-12">
                <div class="company-info-section d-none" id="companyInfoDisplay">
                  <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
                  <select class="form-select" id="factorySelect" name="factory_name" required>
                    <option value="">-- ជ្រើសរើសរោងចក្រ --</option>
                  </select>
                </div>
              </div>

              <!-- Original Penalty Information (Read-only) -->
              <div class="col-12">
                <div id="originalPenaltyInfo" class="followup-info d-none">
                  <h5 class="mb-2">កំហិតដើម</h5>
                  <div id="penaltyDisplay"></div>
                </div>
              </div>

              <!-- Follow-up Result -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-clipboard-check"></i> លទ្ធផលតាមដាន</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="implemented_yes_option">
                      <input type="radio" name="penalty_implemented" value="អនុវត្ត"
                        onchange="toggleFollowupDetails(false)">
                      <span>អនុវត្ត</span>
                    </label>
                    <label class="penalty-option" id="implemented_no_option">
                      <input type="radio" name="penalty_implemented" value="មិនអនុវត្ត"
                        onchange="toggleFollowupDetails(true)">
                      <span>មិនអនុវត្ត</span>
                    </label>
                  </div>

                  <div class="penalty-details" id="followup_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">បែបបទ</label>
                        <input type="text" class="form-control" name="followup_format"
                          placeholder="បញ្ចូលបែបបទតាមដាន...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">លក្ខខណ្ឌ</label>
                        <input type="text" class="form-control" name="followup_condition"
                          placeholder="បញ្ចូលលក្ខខណ្ឌតាមដាន...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">សុខភាពនិងសុវត្ថភាព</label>
                        <textarea class="form-control" name="followup_health" rows="3"
                          placeholder="បញ្ចូលព័ត៌មានសុខភាពនិងសុវត្ថភាពតាមដាន..."></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">វិជ្ជាជីវៈ</label>
                        <textarea class="form-control" name="followup_professional" rows="3"
                          placeholder="បញ្ចូលព័ត៌មានវិជ្ជាជីវៈតាមដាន..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">សេចក្តីសន្និដ្ឋាន</label>
                <textarea class="form-control" name="conclusion" rows="3"
                  placeholder="បញ្ចូលសេចក្តីសន្និដ្ឋាន..."></textarea>
              </div>
              <div class="col-md-4">
                <label class="form-label">ស្ថានភាព *</label>
                <select class="form-select" name="status" required>
                  <option value="">-- ជ្រើសរើសស្ថានភាព --</option>
                  <option value="ចុះ">ចុះ</option>
                  <option value="មិនទាន់ចុះ">មិនទាន់ចុះ</option>
                </select>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="penaltyFollowupSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Fine Document Follow-up Modal -->
  <div class="modal fade" id="fineFollowupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="fineFollowupModalTitle">តាមដានឯកសារផាកថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="fineFollowupForm">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ការត្រួតពិនិត្យដើម *</label>
                <select class="form-select" name="original_inspection" id="fineOriginalInspectionSelect" required
                  onchange="loadFineOriginalInspectionData()">
                  <option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">កាលបរិច្ឆេទ</label>
                <input type="date" class="form-control" name="date">
              </div>
              <!-- Company Information Display (Read-only) -->
              <div class="col-12">
                <div class="company-info-section d-none" id="fineCompanyInfoDisplay">
                  <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
                </div>
              </div>

              <!-- Original Fine Information (Read-only) -->
              <div class="col-12">
                <div id="originalFineInfo" class="followup-info d-none">
                  <h5 class="mb-2">ព័ត៌មានផាកដើម</h5>
                  <div id="fineDisplay"></div>
                </div>
              </div>

              <!-- Fine Details Section -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-file-earmark-text"></i> ព័ត៌មានផាកលម្អិត</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">ឯកសារតម្រូវការ (Required Doc)</label>
                      <textarea class="form-control" name="requiredDoc" rows="3"
                        placeholder="បញ្ចូលឯកសារតម្រូវការ..."></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">លក្ខខណ្ឌការងារ (Working Condition)</label>
                      <textarea class="form-control" name="workingCondition" rows="3"
                        placeholder="បញ្ចូលលក្ខខណ្ឌការងារ..."></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">សុខភាពនិងសុវត្ថិភាព (OSH)</label>
                      <textarea class="form-control" name="osh" rows="3"
                        placeholder="បញ្ចូលព័ត៌មានសុខភាពនិងសុវត្ថិភាព..."></textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">វិជ្ជាជីវៈ (NSF)</label>
                      <textarea class="form-control" name="nsf" rows="3"
                        placeholder="បញ្ចូលព័ត៌មានវិជ្ជាជីវៈ..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Status Section -->
              <div class="col-md-6">
                <label class="form-label">ស្ថានភាព</label>
                <select class="form-select" name="status">
                  <option value="">-- ជ្រើសរើសស្ថានភាព --</option>
                  <option value="ចុះ">ចុះ</option>
                  <option value="មិនទាន់ចុះ">មិនទាន់ចុះ</option>
                </select>
              </div>

              <div class="col-12">
                <label class="form-label">ផ្សេងៗ</label>
                <textarea class="form-control" name="remark" rows="3" placeholder="បញ្ចូលផ្សេងៗ..."></textarea>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="fineFollowupSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View Inspection Details Modal -->
  <div class="modal fade" id="viewInspectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="viewInspectionModalTitle">ព័ត៌មានលម្អិតការត្រួតពិនិត្យ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="inspectionDetail">
            <div class="row g-3">
              <!-- Basic Information -->
              <div class="col-12">
                <h6 class="border-bottom pb-2"><i class="bi bi-info-circle"></i> ព័ត៌មានមូលដ្ឋាន</h6>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">លេខចូល:</label>
                <p id="view_no" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">ក្រុម:</label>
                <p id="view_group" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">កាលបរិច្ឆេទត្រួតពិនិត្យ:</label>
                <p id="view_inspection_date" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-3">
                <label class="form-label fw-bold">ប្រភេទអធិការកិច្ច:</label>
                <p id="view_inspection_type" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">ឈ្មោះរោងចក្រ:</label>
                <p id="view_factory_name" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">ប្រធានបទ:</label>
                <p id="view_case_subject" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">ស្ថានភាព:</label>
                <p id="view_status" class="form-control-plaintext"></p>
              </div>

              <!-- Non-Compliance Section -->
              <div class="col-12">
                <h6 class="border-bottom pb-2 mt-3"><i class="bi bi-exclamation-triangle"></i> កំហិត (Non-Compliance)</h6>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold">មានកំហិត:</label>
                <p id="view_has_noncompliance" class="form-control-plaintext"></p>
              </div>
              <div id="view_noncompliance_details" class="col-12 d-none">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">ឯកសារតម្រូវការ (Required Doc):</label>
                    <p id="view_nc_required_doc" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">លក្ខខណ្ឌការងារ (Working Condition):</label>
                    <p id="view_nc_working_condition" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">សុខភាពនិងសុវត្ថិភាព (OSH):</label>
                    <p id="view_nc_osh" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">វិជ្ជាជីវៈ (NSF):</label>
                    <p id="view_nc_nsf" class="form-control-plaintext"></p>
                  </div>
                </div>
                <div class="mt-3">
                  <label class="form-label fw-bold">បញ្ជីកំហិតលម្អិត:</label>
                  <div id="view_noncompliance_list" class="border rounded p-2 bg-light">
                    <!-- Non-compliance items will be listed here -->
                  </div>
                </div>
              </div>

              <!-- Fine Section -->
              <div class="col-12">
                <h6 class="border-bottom pb-2 mt-3"><i class="bi bi-cash-coin"></i> ផាក (Fine)</h6>
              </div>
              <div class="col-md-12">
                <label class="form-label fw-bold">មានផាក:</label>
                <p id="view_has_fine" class="form-control-plaintext"></p>
              </div>
              <div id="view_fine_details" class="col-12 d-none">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label fw-bold">ឯកសារតម្រូវការ (Required Doc):</label>
                    <p id="view_fine_required_doc" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">លក្ខខណ្ឌការងារ (Working Condition):</label>
                    <p id="view_fine_working_condition" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">សុខភាពនិងសុវត្ថិភាព (OSH):</label>
                    <p id="view_fine_osh" class="form-control-plaintext"></p>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label fw-bold">វិជ្ជាជីវៈ (NSF):</label>
                    <p id="view_fine_nsf" class="form-control-plaintext"></p>
                  </div>
                </div>
                <div class="mt-3">
                  <label class="form-label fw-bold">បញ្ជីផាកលម្អិត:</label>
                  <div id="view_fine_list" class="border rounded p-2 bg-light">
                    <!-- Fine items will be listed here -->
                  </div>
                </div>
              </div>

              <!-- Timestamps -->
              <div class="col-12">
                <h6 class="border-bottom pb-2 mt-3"><i class="bi bi-clock-history"></i> ព័ត៌មានបន្ថែម</h6>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">បង្កើតនៅ:</label>
                <p id="view_created_at" class="form-control-plaintext"></p>
              </div>
              <div class="col-md-6">
                <label class="form-label fw-bold">ធ្វើបច្ចុប្បន្នភាពនៅ:</label>
                <p id="view_updated_at" class="form-control-plaintext"></p>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="messageTitle">Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="messageText"></p>
        </div>
        <div class="modal-footer" id="messageButtons">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden file input for template uploads -->
  <input type="file" id="hiddenFileInput" style="display: none;" accept=".docx">

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- JavaScript for Inspection Management -->
  <script>
    // Global variables
    let allInspections = [];
    let allPenaltyFollowups = [];
    let allFineFollowups = [];
    let currentEditingId = null;

    const API_BASE_URL = "https://uat-api-office2.thithabirdnest.com"
    // Utility functions
    function showMessage(message, title = 'Information') {
      const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageText').textContent = message;
      messageModal.show();
    }

    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }

    // DOCX Document Generator
    class DocxGenerator {
      constructor() {
        this.templates = {
          inspection: this.getDefaultInspectionTemplate(),
          penaltyFollowup: this.getDefaultPenaltyFollowupTemplate(),
          fineFollowup: this.getDefaultFineFollowupTemplate()
        };
      }

      getDefaultInspectionTemplate() {
        return {
          title: "របាយការណ៍អធិការកិច្ច",
          sections: [
            { label: "លេខចូល", key: "no" },
            { label: "ក្រុម", key: "group" },
            { label: "កាលបរិច្ឆេទត្រួតពិនិត្យ", key: "inspection_date" },
            { label: "ប្រភេទអធិការកិច្ច", key: "inspection_type" },
            { label: "ឈ្មោះរោងចក្រ", key: "factory_name" },
            { label: "វិស័យ", key: "sector" },
            { label: "ប្រធានបទ", key: "case_subject" },
            { label: "ទីតាំង", key: "address", composite: true }
          ],
          conditionalSections: {
            penalty: {
              condition: "has_penalty",
              value: "មាន",
              sections: [
                { label: "បែបបទ", key: "penalty_format" },
                { label: "លក្ខខណ្ឌ", key: "penalty_condition" },
                { label: "សុខភាពនិងសុវត្ថភាព", key: "penalty_health" },
                { label: "វិជ្ជាជីវៈ", key: "penalty_professional" }
              ]
            },
            fine: {
              condition: "has_fine",
              value: "មាន",
              sections: [
                { label: "បែបបទ", key: "fine_format" },
                { label: "លក្ខខណ្ឌ", key: "fine_condition" },
                { label: "សុខភាពនិងសុវត្ថភាព", key: "finey_health" },
                { label: "វិជ្ជាជីវៈ", key: "fine_professional" }
              ]
            }
          },
          remarks: { label: "ផ្សេងៗ", key: "remarks" }
        };
      }

      getDefaultPenaltyFollowupTemplate() {
        return {
          title: "របាយការណ៍តាមដានកំហិត",
          sections: [
            { label: "លេខចូល", key: "no" },
            { label: "កាលបរិច្ឆេទតាមដាន", key: "followup_date" },
            { label: "ការត្រួតពិនិត្យដើម", key: "original_inspection", composite: true },
            { label: "លទ្ធផលតាមដាន", key: "penalty_implemented" }
          ],
          conditionalSections: {
            additional: {
              condition: "penalty_implemented",
              value: "មិនអនុវត្ត",
              sections: [
                { label: "បែបបទ", key: "followup_format" },
                { label: "លក្ខខណ្ឌ", key: "followup_condition" },
                { label: "សុខភាពនិងសុវត្ថភាព", key: "followup_health" },
                { label: "វិជ្ជាជីវៈ", key: "followup_professional" }
              ]
            }
          },
          remarks: { label: "សេចក្តីសន្និដ្ឋាន", key: "conclusion" }
        };
      }

      getDefaultFineFollowupTemplate() {
        return {
          title: "របាយការណ៍តាមដានឯកសារផាក",
          sections: [
            { label: "លេខចូល", key: "no" },
            { label: "កាលបរិច្ឆេទចេញលិខិត", key: "document_date" },
            { label: "ការត្រួតពិនិត្យដើម", key: "original_inspection", composite: true },
            { label: "ចំនួនទឹកប្រាក់ផាក", key: "fine_amount", composite: true },
            { label: "ស្ថានភាពឯកសារ", key: "document_status_display" }
          ],
          remarks: { label: "ផ្សេងៗ", key: "remarks" }
        };
      }

      async generateDocument(templateType, data) {
        const template = this.templates[templateType];
        if (!template) {
          throw new Error(`Template not found for type: ${templateType}`);
        }

        const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType } = docx;

        const doc = new Document({
          sections: [{
            properties: {},
            children: [
              new Paragraph({
                text: template.title,
                heading: HeadingLevel.HEADING_1,
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
              }),
              ...this.generateContent(template, data)
            ]
          }]
        });

        return doc;
      }

      generateContent(template, data) {
        const { Paragraph, TextRun, AlignmentType } = docx;
        const content = [];

        // Add main sections
        template.sections.forEach(section => {
          if (section.composite) {
            const value = this.getCompositeValue(section.key, data);
            if (value) {
              content.push(
                new Paragraph({
                  children: [
                    new TextRun({ text: `${section.label}: `, bold: true }),
                    new TextRun({ text: value })
                  ],
                  spacing: { after: 200 }
                })
              );
            }
          } else {
            const value = this.getValue(section.key, data);
            if (value) {
              content.push(
                new Paragraph({
                  children: [
                    new TextRun({ text: `${section.label}: `, bold: true }),
                    new TextRun({ text: value })
                  ],
                  spacing: { after: 200 }
                })
              );
            }
          }
        });

        // Add conditional sections
        if (template.conditionalSections) {
          Object.values(template.conditionalSections).forEach(conditional => {
            if (data[conditional.condition] === conditional.value) {
              conditional.sections.forEach(section => {
                const value = this.getValue(section.key, data);
                if (value) {
                  content.push(
                    new Paragraph({
                      children: [
                        new TextRun({ text: `${section.label}: `, bold: true }),
                        new TextRun({ text: value })
                      ],
                      spacing: { after: 200 }
                    })
                  );
                }
              });
            }
          });
        }

        // Add remarks
        if (template.remarks && data[template.remarks.key]) {
          content.push(
            new Paragraph({
              children: [
                new TextRun({ text: `${template.remarks.label}: `, bold: true }),
                new TextRun({ text: data[template.remarks.key] })
              ],
              spacing: { after: 200 }
            })
          );
        }

        return content;
      }

      getValue(key, data) {
        return data[key] || '';
      }

      getCompositeValue(type, data) {
        switch (type) {
          case 'address':
            return `${data.village || ''}, ${data.commune || ''}, ${data.district || ''}, ${data.province || ''}`;
          case 'original_inspection':
            const original = data.original_inspection_data || {};
            return `${original.no || ''} - ${original.factory_name || ''}`;
          case 'fine_amount':
            return `${data.fine_amount || ''} ${data.fine_type || ''}`;
          case 'document_status_display':
            switch (data.document_status) {
              case 'department': return 'បានចេញលិខិតផាក ទៅនាយកដ្ឋាន';
              case 'general': return 'ទៅអគ្គ';
              case 'minister': return 'ទៅរដ្ឋមន្ត្រី';
              case 'completed': return 'បានបញ្ចប់';
              default: return data.document_status || '';
            }
          default:
            return '';
        }
      }

      async downloadDocument(doc, filename) {
        const blob = await docx.Packer.toBlob(doc);
        saveAs(blob, `${filename}.docx`);
      }
    }

    // Inspection Management functionality
    class InspectionManager {
      constructor() {
        this.allInspections = [];
        this.allPenaltyFollowups = [];
        this.allFineFollowups = [];
        this.docxGenerator = new DocxGenerator();
        this.currentTemplateType = null;

        this.openInspectionForm = this.openInspectionForm.bind(this);
      }

      init() {
        this.bindEvents();
        this.fetchInspect();
        this.fetchNonCompliances();
        this.fetchFines();
      }

      bindEvents() {
        // Tab switching
        document.querySelectorAll('.inspection-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const tabName = e.currentTarget.getAttribute('data-tab');
            this.showInspectionTab(tabName);
          });
        });

        // Inspection buttons
        document.getElementById('openInspectionForm').addEventListener('click', () => {
          console.log("testing")
          this.openInspectionForm();
        });

        document.getElementById('exportInspectionExcel').addEventListener('click', () => {
          this.exportInspectionsToExcel();
        });

        // Penalty Followup buttons
        document.getElementById('openPenaltyFollowupForm').addEventListener('click', () => {
          this.openPenaltyFollowupForm();
        });

        document.getElementById('exportPenaltyFollowupExcel').addEventListener('click', () => {
          this.exportPenaltyFollowupsToExcel();
        });

        // Fine Followup buttons
        document.getElementById('openFineFollowupForm').addEventListener('click', () => {
          this.openFineFollowupForm();
        });

        document.getElementById('exportFineFollowupExcel').addEventListener('click', () => {
          this.exportFineFollowupsToExcel();
        });

        // Document template buttons
        document.getElementById('uploadInspectionTemplate').addEventListener('click', () => {
          this.uploadTemplate('inspection');
        });

        document.getElementById('downloadInspectionTemplate').addEventListener('click', () => {
          this.downloadTemplate('inspection');
        });

        document.getElementById('uploadPenaltyTemplate').addEventListener('click', () => {
          this.uploadTemplate('penaltyFollowup');
        });

        document.getElementById('downloadPenaltyTemplate').addEventListener('click', () => {
          this.downloadTemplate('penaltyFollowup');
        });

        document.getElementById('uploadFineTemplate').addEventListener('click', () => {
          this.uploadTemplate('fineFollowup');
        });

        document.getElementById('downloadFineTemplate').addEventListener('click', () => {
          this.downloadTemplate('fineFollowup');
        });

        // Search functionality
        document.getElementById('inspectionSearch').addEventListener('input', (e) => {
          this.searchInspections(e.target.value);
        });

        document.getElementById('penaltyFollowupSearch').addEventListener('input', (e) => {
          this.searchPenaltyFollowups(e.target.value);
        });

        document.getElementById('fineFollowupSearch').addEventListener('input', (e) => {
          this.searchFineFollowups(e.target.value);
        });

        // Form submissions
        document.getElementById('inspectionForm').addEventListener('submit', (e) => {
          this.handleInspectionFormSubmit(e);
        });

        document.getElementById('penaltyFollowupForm').addEventListener('submit', (e) => {
          this.handlePenaltyFollowupFormSubmit(e);
        });

        document.getElementById('fineFollowupForm').addEventListener('submit', (e) => {
          this.handleFineFollowupFormSubmit(e);
        });

        // Event delegation for action buttons
        document.getElementById('inspectionTableBody').addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          if (!row) return;

          const id = row.getAttribute('data-id');
          if (!id) return;

          if (e.target.closest('.btn-outline-primary')) {
            this.viewInspection(id);
          } else if (e.target.closest('.btn-outline-secondary')) {
            this.editInspection(id);
          } else if (e.target.closest('.btn-outline-info')) {
            this.generateInspectionDocument(id);
          } else if (e.target.closest('.btn-outline-danger')) {
            this.deleteInspectionConfirm(id);
          }
        });

        document.getElementById('penaltyFollowupTableBody').addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          if (!row) return;

          const id = row.getAttribute('data-id');
          if (!id) return;

          if (e.target.closest('.btn-outline-primary')) {
            this.viewPenaltyFollowup(id);
          } else if (e.target.closest('.btn-outline-secondary')) {
            this.editPenaltyFollowup(id);
          } else if (e.target.closest('.btn-outline-info')) {
            this.generatePenaltyFollowupDocument(id);
          } else if (e.target.closest('.btn-outline-danger')) {
            this.deletePenaltyFollowupConfirm(id);
          }
        });

        document.getElementById('fineFollowupTableBody').addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          if (!row) return;

          const id = row.getAttribute('data-id');
          if (!id) return;

          if (e.target.closest('.btn-outline-primary')) {
            this.viewFineFollowup(id);
          } else if (e.target.closest('.btn-outline-secondary')) {
            this.editFineFollowup(id);
          } else if (e.target.closest('.btn-outline-info')) {
            this.generateFineFollowupDocument(id);
          } else if (e.target.closest('.btn-outline-danger')) {
            this.deleteFineFollowupConfirm(id);
          }
        });
      }

      async fetchInspect() {
        try {
          const res = await fetch("https://uat-api-office2.thithabirdnest.com/inspections");

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();


          this.allInspections = data.data;  // backend data
          console.log("Inspections:", this.allInspections);

          this.renderInspections(this.allInspections);
          this.populateOriginalInspections(); // Populate dropdowns after fetching
        } catch (error) {
          console.error("fetchInspect error:", error);
        }
      }

       async fetchNonCompliances() {
        try {
          const res = await fetch(`${API_BASE_URL}/non-compliances`);

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();


          this.allPenaltyFollowups = data.data;  // backend data
          console.log("Non compliance:", this.allPenaltyFollowups);

          this.renderPenaltyFollowups(this.allPenaltyFollowups);
          this.updateStatistics(); // Update statistics after fetching
        } catch (error) {
          console.error("Non compliance error:", error);
        }
      }

      async fetchFines() {
        try {
          const res = await fetch(`${API_BASE_URL}/fines`);

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          const data = await res.json();


          this.allFineFollowups = data.data;  // backend data
          console.log("allFineFollowups:", this.allFineFollowups);

          this.renderFineFollowups(this.allFineFollowups);
          this.updateStatistics(); // Update statistics after fetching
        } catch (error) {
          console.error("allFineFollowups error:", error);
        }
      }



      // loadSampleData() {
      //   // Sample inspection data
      //   this.allInspections = [
      //     {
      //       id: 1,
      //       no: 'INS001',
      //       factory_name: 'រោងចក្រ ក',
      //       sector: 'វិស័យ ក',
      //       case_subject: 'ការបំពានលើស្តង់ដារសុវត្ថិភាព',
      //       group: 'ក្រុម ក',
      //       inspection_date: '2024-01-15',
      //       inspection_type: 'អធិការពិសេស',
      //       village: 'ភូមិ ក',
      //       commune: 'ឃុំ ក',
      //       district: 'ស្រុក ក',
      //       province: 'ខេត្ត ក',
      //       has_penalty: 'មាន',
      //       penalty_format: 'ត្រូវកែលម្អប្រព័ន្ធអគ្គិសនី',
      //       penalty_condition: 'មិនបំពេញស្តង់ដារសុវត្ថិភាព',
      //       penalty_health: 'ខ្សែភ្លើងមិនមានសុវត្ថិភាព',
      //       penalty_professional: 'បុគ្គលិកគ្មានការបណ្តុះបណ្តាល',
      //       has_fine: 'មាន',
      //       penalty_format: 'ធ្វើការលើសម៉ោង',
      //       penalty_condition: 'គ្មានបទបញ្ជាផ្ទៃក្នុង',
      //       penalty_health: 'គ្មានពេទ្យ',
      //       penalty_professional: 'អត់បង់បសស',
      //       remarks: 'ត្រូវកែលម្អក្នុងរយៈពេល ៣០ថ្ងៃ'
      //     },
      //     {
      //       id: 2,
      //       no: 'INS002',
      //       factory_name: 'រោងចក្រ ខ',
      //       sector: 'វិស័យ ខ',
      //       case_subject: 'ការបំពានលើស្តង់ដារបរិស្ថាន',
      //       group: 'ក្រុម ខ',
      //       inspection_date: '2024-01-20',
      //       inspection_type: 'អធិការសាមញ្ញ',
      //       village: 'ភូមិ ខ',
      //       commune: 'ឃុំ ខ',
      //       district: 'ស្រុក ខ',
      //       province: 'ខេត្ត ខ',
      //       has_penalty: 'គ្មាន',
      //       has_fine: 'មាន',
      //       fine_amount: '500,000',
      //       fine_type: 'ប្រាក់ដុល្លារ',
      //       fine_reason: 'បញ្ចេញទឹកស្អុយដោយគ្មានការអនុញ្ញាត',
      //       remarks: 'ត្រូវបង់ផាកក្នុងរយៈពេល ១៥ថ្ងៃ'
      //     }
      //   ];

      // Sample penalty followup data
      //   this.allPenaltyFollowups = [
      //     {
      //       id: 1,
      //       no: 'FLW001',
      //       original_inspection: '1',
      //       original_inspection_data: this.allInspections[0],
      //       followup_date: '2024-02-15',
      //       penalty_implemented: 'អនុវត្ត',
      //       conclusion: 'រោងចក្របានកែលម្អតាមតម្រូវការគ្រប់ចំនុច'
      //     }
      //   ];
      //   // Sample fine followup data
      //   this.allFineFollowups = [
      //     {
      //       id: 1,
      //       no: 'DOC001',
      //       original_inspection: '2',
      //       original_inspection_data: this.allInspections[1],
      //       document_date: '2024-01-25',
      //       fine_amount: '500,000',
      //       fine_type: 'ប្រាក់ដុល្លារ',
      //       document_status: 'general',
      //       remarks: 'លិខិតកំពុងដំណើរការនៅអគ្គ'
      //     }
      //   ];
      //   this.renderInspections();
      //   this.renderPenaltyFollowups();
      //   this.renderFineFollowups();
      //   this.updateStatistics();
      //   this.populateOriginalInspections();
      // }

      updateStatistics() {
        const totalInspections = this.allInspections.length;
        const inspectionsWithPenalties = this.allInspections.filter(i => i.isNonCompliance === true).length;
        const inspectionsWithFines = this.allInspections.filter(i => i.isFine === true).length;
        const totalFollowups = this.allPenaltyFollowups.length + this.allFineFollowups.length;

        document.getElementById('totalInspections').textContent = formatNumber(totalInspections);
        document.getElementById('inspectionsWithPenalties').textContent = formatNumber(inspectionsWithPenalties);
        document.getElementById('inspectionsWithFines').textContent = formatNumber(inspectionsWithFines);
        document.getElementById('totalFollowups').textContent = formatNumber(totalFollowups);
      }

      showInspectionTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.inspection-content').forEach(content => {
          content.classList.remove('active');
        });
        // Remove active class from all tabs
        document.querySelectorAll('.inspection-tab').forEach(tab => {
          tab.classList.remove('active');
        });

        // Show selected tab content
        document.getElementById(`${tabName}-inspection`).classList.add('active');

        // Activate selected tab
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      }

      renderInspections() {
        const tbody = document.getElementById('inspectionTableBody');

        if (!this.allInspections || this.allInspections.length === 0) {
          tbody.innerHTML = `
      <tr>
        <td colspan="8" class="text-center text-muted py-4">
          មិនមានទិន្នន័យ
        </td>
      </tr>
    `;
          return;
        }

        tbody.innerHTML = this.allInspections.map((inspection, index) => {

          // Backend now returns these:
          const hasPenalty = inspection.isNonCompliance;   // boolean
          const hasFine = inspection.isFine;               // boolean

          let status = '';
          let statusClass = '';

          if (hasPenalty) {
            status = 'ត្រូវតាមដានកំហិត';
            statusClass = 'status-pending';
          } else if (hasFine) {
            status = 'ត្រូវតាមដានផាក';
            statusClass = 'status-warning';
          } else {
            status = 'បានបញ្ចប់';
            statusClass = 'status-completed';
          }

          // Format inspection date
          const inspectionDate = inspection.inspectionDate || inspection.inspection_date;
          const formattedDate = inspectionDate ? inspectionDate.split('T')[0] : '';

          return `
      <tr data-id="${inspection.id}">
        <td class="text-muted">${index + 1}</td>

        <td>${inspection.no || ''}</td>

        <td>
          <div class="fw-semibold">
            ${inspection.factory?.factoryname || ''}
          </div>
          <div class="text-muted small">
            <div>${inspection.caseSubject || inspection.case_subject || ''}</div>
            <div>${inspection.group || ''}</div>
            <div>${inspection.inspectionType || inspection.inspection_type || ''}</div>
          </div>
        </td>

        <td>${formattedDate}</td>

        <td>
          <span class="status-badge ${hasPenalty ? 'status-warning' : 'status-completed'}">
            ${hasPenalty ? 'មាន' : 'គ្មាន'}
          </span>
        </td>

        <td>
          <span class="status-badge ${hasFine ? 'status-warning' : 'status-completed'}">
            ${hasFine ? 'មាន' : 'គ្មាន'}
          </span>
        </td>

        <td>
          <span class="status-badge ${statusClass}">
            ${status}
          </span>
        </td>

        <td>
          <div class="btn-group-vertical btn-group-sm">
            <button class="btn btn-outline-primary" title="View">
              <i class="bi bi-eye"></i>
            </button>
            <button class="btn btn-outline-secondary" title="Edit">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-outline-info" title="Generate Document">
              <i class="bi bi-file-earmark-word"></i>
            </button>
            <button class="btn btn-outline-danger" title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;

        }).join('');

        this.updateStatistics();
      }
      renderPenaltyFollowups() {
        const tbody = document.getElementById('penaltyFollowupTableBody');

        if (this.allPenaltyFollowups.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                មិនមានទិន្នន័យ
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = this.allPenaltyFollowups.map((followup, index) => {
      
          const status = followup.status;

          const statusText =
            status === "ចុះ" ? "ចុះ" :
            status === "មិនទាន់ចុះ" ? "មិនទាន់ចុះ" :
            "មិនទាន់ចុះ";

          const statusClass =
            status === "ចុះ" ? "status-success" : "status-warning";

          // Build factory address
          const addressParts = [];
          if (followup.factory?.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory?.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory?.province?.name) addressParts.push(followup.factory.province.name);
          const factoryAddress = addressParts.join(', ');

          // Get original inspection date
          const originalInspectionDate = followup.inspection?.inspectionDate
            ? followup.inspection.inspectionDate.split("T")[0]
            : '';

          return `
          <tr data-id="${followup.id}">
            <td class="text-muted">${index + 1}</td>
            <td>${followup.inspection.no}</td>
            <td>
              <div class="fw-semibold">${followup.factory?.factoryname || ''}</div>
              <div class="text-muted small">${factoryAddress}</div>
            </td>
            <td>${followup.inspection?.group || ''}</td>
            <td>${followup.date ? followup.date.split("T")[0] : ''}</td>
            <td>${originalInspectionDate}</td>
            <td>
              <span class="status-badge ${statusClass}">
                ${status}
              </span>
            </td>
            <td>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info" title="Generate Document">
                  <i class="bi bi-file-earmark-word"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');
      }

      renderFineFollowups() {
        const tbody = document.getElementById('fineFollowupTableBody');

        if (this.allFineFollowups.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                មិនមានទិន្នន័យ
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = this.allFineFollowups.map((followup, index) => {
          // Build factory address
          const addressParts = [];
          if (followup.factory?.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory?.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory?.province?.name) addressParts.push(followup.factory.province.name);
          const factoryAddress = addressParts.join(', ');

          // Determine status based on the status field
          const status = followup.status;
          const statusText = status === "ចុះ" ? "ចុះ" : status === "មិនទាន់ចុះ" ? "មិនទាន់ចុះ" : "មិនទាន់ចុះ";
          const statusClass = status === "ចុះ" ? "status-success" : "status-warning";

          return `
          <tr data-id="${followup.id}">
            <td class="text-muted">${index + 1}</td>
            <td>${followup.no || followup.inspection?.no || `F-${followup.id}`}</td>
            <td>
              <div class="fw-semibold">${followup.factory?.factoryname || ''}</div>
              <div class="text-muted small">${factoryAddress}</div>
            </td>
            <td>${followup.date ? followup.date.split('T')[0] : ''}</td>
            <td>
              <div class="text-muted small">
                ${followup.requiredDoc ? `<div><strong>Required Doc:</strong> ${followup.requiredDoc}</div>` : ''}
                ${followup.osh ? `<div><strong>OSH:</strong> ${followup.osh}</div>` : ''}
              </div>
            </td>
            <td>
              <span class="status-badge ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info" title="Generate Document">
                  <i class="bi bi-file-earmark-word"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');
      }

      // Search functionality
      searchInspections(query) {
        if (!query.trim()) {
          this.renderInspections();
          return;
        }

        const filteredInspections = this.allInspections.filter(inspection =>
          Object.values(inspection).some(value =>
            value && value.toString().toLowerCase().includes(query.toLowerCase())
          )
        );
        const tbody = document.getElementById('inspectionTableBody');
        if (filteredInspections.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                មិនមានទិន្នន័យត្រូវនឹងការស្វែងរក
              </td>
            </tr>
          `;
          return;
        }

        // Re-render with filtered data
        tbody.innerHTML = filteredInspections.map((inspection, index) => {
          // Backend now returns these:
          const hasPenalty = inspection.isNonCompliance;
          const hasFine = inspection.isFine;

          let status = '';
          let statusClass = '';
          if (hasPenalty) {
            status = 'ត្រូវតាមដានកំហិត';
            statusClass = 'status-pending';
          } else if (hasFine) {
            status = 'ត្រូវតាមដានផាក';
            statusClass = 'status-warning';
          } else {
            status = 'បានបញ្ចប់';
            statusClass = 'status-completed';
          }

          // Format inspection date
          const inspectionDate = inspection.inspectionDate || inspection.inspection_date;
          const formattedDate = inspectionDate ? inspectionDate.split('T')[0] : '';

          return `
          <tr data-id="${inspection.id}">
            <td class="text-muted">${index + 1}</td>
            <td>${inspection.no || ''}</td>
            <td>
              <div class="fw-semibold">${inspection.factory?.factoryname || inspection.factory_name || ''}</div>
              <div class="text-muted small">
                <div>${inspection.caseSubject || inspection.case_subject || ''}</div>
                <div>${inspection.group || ''}</div>
                <div>${inspection.inspectionType || inspection.inspection_type || ''}</div>
              </div>
            </td>
            <td>${formattedDate}</td>
            <td>
              <span class="status-badge ${hasPenalty ? 'status-warning' : 'status-completed'}">
                ${hasPenalty ? 'មាន' : 'គ្មាន'}
              </span>
            </td>
            <td>
              <span class="status-badge ${hasFine ? 'status-warning' : 'status-completed'}">
                ${hasFine ? 'មាន' : 'គ្មាន'}
              </span>
            </td>
            <td>
              <span class="status-badge ${statusClass}">
                ${status}
              </span>
            </td>
            <td>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info" title="Generate Document">
                  <i class="bi bi-file-earmark-word"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');
      }

      searchPenaltyFollowups(query) {
        if (!query.trim()) {
          this.renderPenaltyFollowups();
          return;
        }

        const filteredFollowups = this.allPenaltyFollowups.filter(followup =>
          Object.values(followup).some(value =>
            value && value.toString().toLowerCase().includes(query.toLowerCase())
          )
        );
        const tbody = document.getElementById('penaltyFollowupTableBody');
        if (filteredFollowups.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                មិនមានទិន្នន័យត្រូវនឹងការស្វែងរក
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredFollowups.map((followup, index) => {
          // Determine status based on isPractice field
          const isPracticed = followup.isPractice === true;
          const statusText = isPracticed ? 'អនុវត្ត' : 'មិនអនុវត្ត';
          const statusClass = isPracticed ? 'status-success' : 'status-warning';

          // Build factory address
          const addressParts = [];
          if (followup.factory?.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory?.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory?.province?.name) addressParts.push(followup.factory.province.name);
          const factoryAddress = addressParts.join(', ');

          // Get original inspection date
          const originalInspectionDate = followup.inspection?.inspectionDate
            ? followup.inspection.inspectionDate.split("T")[0]
            : '';

          return `
          <tr data-id="${followup.id}">
            <td class="text-muted">${index + 1}</td>
            <td>${followup.no || `NC-${followup.id}`}</td>
            <td>
              <div class="fw-semibold">${followup.factory?.factoryname || ''}</div>
              <div class="text-muted small">${factoryAddress}</div>
            </td>
            <td>${followup.inspection?.group || ''}</td>
            <td>${followup.date ? followup.date.split("T")[0] : ''}</td>
            <td>${originalInspectionDate}</td>
            <td>
              <span class="status-badge ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info" title="Generate Document">
                  <i class="bi bi-file-earmark-word"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');
      }

      searchFineFollowups(query) {
        if (!query.trim()) {
          this.renderFineFollowups();
          return;
        }

        const filteredFollowups = this.allFineFollowups.filter(followup =>
          Object.values(followup).some(value =>
            value && value.toString().toLowerCase().includes(query.toLowerCase())
          )
        );
        const tbody = document.getElementById('fineFollowupTableBody');
        if (filteredFollowups.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-muted py-4">
                មិនមានទិន្នន័យត្រូវនឹងការស្វែងរក
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = filteredFollowups.map((followup, index) => {
          // Build factory address
          const addressParts = [];
          if (followup.factory?.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory?.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory?.province?.name) addressParts.push(followup.factory.province.name);
          const factoryAddress = addressParts.join(', ');

          // Determine status based on the status field
          const status = followup.status;
          const statusText = status === "ចុះ" ? "ចុះ" : status === "មិនទាន់ចុះ" ? "មិនទាន់ចុះ" : "មិនទាន់ចុះ";
          const statusClass = status === "ចុះ" ? "status-success" : "status-warning";

          return `
          <tr data-id="${followup.id}">
            <td class="text-muted">${index + 1}</td>
            <td>${followup.no || followup.inspection?.no || `F-${followup.id}`}</td>
            <td>
              <div class="fw-semibold">${followup.factory?.factoryname || ''}</div>
              <div class="text-muted small">${factoryAddress}</div>
            </td>
            <td>${followup.date ? followup.date.split('T')[0] : ''}</td>
            <td>
              <div class="text-muted small">
                ${followup.requiredDoc ? `<div><strong>Required Doc:</strong> ${followup.requiredDoc}</div>` : ''}
                ${followup.osh ? `<div><strong>OSH:</strong> ${followup.osh}</div>` : ''}
              </div>
            </td>
            <td>
              <span class="status-badge ${statusClass}">
                ${statusText}
              </span>
            </td>
            <td>
              <div class="btn-group-vertical btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-info" title="Generate Document">
                  <i class="bi bi-file-earmark-word"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `}).join('');
      }

      // Form handling methods
      openInspectionForm(editId = null) {
        console.log("Open Inspection Form");
        currentEditingId = editId;
        const modal = new bootstrap.Modal(document.getElementById('inspectionModal'));
        const modalTitle = document.getElementById('inspectionModalTitle');
        const form = document.getElementById('inspectionForm');

        modalTitle.textContent = editId ? 'កែសម្រួលការត្រួតពិនិត្យ' : 'ការត្រួតពិនិត្យថ្មី';
        form.reset();
        this.resetAllSelections();

        if (editId) {
          this.populateInspectionForm(editId);
        }

        modal.show();
      }

      populateInspectionForm(id) {
        const inspection = this.allInspections.find(i => i.id.toString() === id.toString());
        if (!inspection) return;

        const form = document.getElementById('inspectionForm');
        const elements = form.elements;
        elements['no'].value = inspection.no || '';
        elements['group'].value = inspection.group || '';
        elements['inspection_date'].value = inspection.inspection_date || '';
        elements['inspection_type'].value = inspection.inspection_type || '';
        elements['factory_name'].value = inspection.factory_name || '';
        elements['sector'].value = inspection.sector || '';
        elements['case_subject'].value = inspection.case_subject || '';
        elements['village'].value = inspection.village || '';
        elements['commune'].value = inspection.commune || '';
        elements['district'].value = inspection.district || '';
        elements['province'].value = inspection.province || '';
        elements['remarks'].value = inspection.remarks || '';
        // Handle penalty section
        if (inspection.has_penalty === 'មាន') {
          togglePenaltyDetails(true);
          elements['penalty_format'].value = inspection.penalty_format || '';
          elements['penalty_condition'].value = inspection.penalty_condition || '';
          elements['penalty_health'].value = inspection.penalty_health || '';
          elements['penalty_professional'].value = inspection.penalty_professional || '';
        } else {
          togglePenaltyDetails(false);
        }
        // Handle fine section
        if (inspection.has_fine === 'មាន') {
          toggleFineDetails(true);
          elements['fine_amount'].value = inspection.fine_amount || '';
          elements['fine_type'].value = inspection.fine_type || '';
          elements['fine_reason'].value = inspection.fine_reason || '';
        } else {
          toggleFineDetails(false);
        }
      }

      openPenaltyFollowupForm(editId = null) {
        currentEditingId = editId;
        const modal = new bootstrap.Modal(document.getElementById('penaltyFollowupModal'));
        const modalTitle = document.getElementById('penaltyFollowupModalTitle');
        const form = document.getElementById('penaltyFollowupForm');

        modalTitle.textContent = editId ? 'កែសម្រួលតាមដានកំហិត' : 'តាមដានកំហិតថ្មី';
        form.reset();
        this.resetAllSelections();
        this.populateOriginalInspections();

        if (editId) {
          this.populatePenaltyFollowupForm(editId);
        }

        modal.show();
      }

      populatePenaltyFollowupForm(id) {
        // Find the followup in the already-loaded data
        const followup = this.allPenaltyFollowups.find(f => f.id.toString() === id.toString());

        if (!followup) {
          showMessage('មិនរកឃើញការតាមដានកំហិត', 'Error');
          return;
        }

        const form = document.getElementById('penaltyFollowupForm');
        const elements = form.elements;

        // Basic information
        elements['no'].value = followup.no || `NC-${followup.id}`;
        elements['followup_date'].value = followup.date ? followup.date.split('T')[0] : '';
        elements['conclusion'].value = followup.remark || '';

        // Set status field
        if (followup.status) {
          elements['status'].value = followup.status;
        }

        // Set original inspection dropdown
        if (followup.inspectionId) {
          elements['original_inspection'].value = followup.inspectionId;
        }

        // Display company information
        const companyInfoDisplay = document.getElementById('companyInfoDisplay');
        if (followup.factory) {
          companyInfoDisplay.classList.remove('d-none');
          const addressParts = [];
          if (followup.factory.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory.province?.name) addressParts.push(followup.factory.province.name);

          companyInfoDisplay.innerHTML = `
            <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <strong>ឈ្មោះរោងចក្រ:</strong> ${followup.factory.factoryname || ''}
              </div>
              <div class="col-md-6">
                <strong>អាសយដ្ឋាន:</strong> ${addressParts.join(', ')}
              </div>
            </div>
          `;
        }

        // Display original penalty information
        const originalPenaltyInfo = document.getElementById('originalPenaltyInfo');
        if (followup.inspection) {
          originalPenaltyInfo.classList.remove('d-none');
          document.getElementById('penaltyDisplay').innerHTML = `
            <div class="row g-2">
              <div class="col-md-4"><strong>លេខចូល:</strong> ${followup.inspection.no || ''}</div>
              <div class="col-md-4"><strong>ក្រុម:</strong> ${followup.inspection.group || ''}</div>
              <div class="col-md-4"><strong>កាលបរិច្ឆេទ:</strong> ${followup.inspection.inspectionDate ? followup.inspection.inspectionDate.split('T')[0] : ''}</div>
              <div class="col-12"><strong>ប្រធានបទ:</strong> ${followup.inspection.caseSubject || ''}</div>
            </div>
          `;
        }

        // Determine penalty implementation status based on isPractice field
        const penaltyImplemented = followup.isPractice === true ? 'អនុវត្ត' : 'មិនអនុវត្ត';

        // Select the appropriate radio button
        const implementedRadio = form.querySelector(`input[name="penalty_implemented"][value="${penaltyImplemented}"]`);
        if (implementedRadio) {
          implementedRadio.checked = true;
          toggleFollowupDetails(penaltyImplemented === 'មិនអនុវត្ត');
        }

        // Populate followup details (only if not implemented / isPractice is false)
        if (followup.isPractice !== true) {
          elements['followup_format'].value = followup.requiredDoc || '';
          elements['followup_condition'].value = followup.workingCondition || '';
          elements['followup_health'].value = followup.osh || '';
          elements['followup_professional'].value = followup.nsf || '';
        }
      }

      openFineFollowupForm(editId = null) {
        currentEditingId = editId;
        const modal = new bootstrap.Modal(document.getElementById('fineFollowupModal'));
        const modalTitle = document.getElementById('fineFollowupModalTitle');
        const form = document.getElementById('fineFollowupForm');

        modalTitle.textContent = editId ? 'កែសម្រួលតាមដានឯកសារផាក' : 'តាមដានឯកសារផាកថ្មី';
        form.reset();
        this.resetAllSelections();
        this.populateOriginalInspections();

        if (editId) {
          this.populateFineFollowupForm(editId);
        }

        modal.show();
      }

      populateFineFollowupForm(id) {
        // Find the followup in the already-loaded data
        const followup = this.allFineFollowups.find(f => f.id.toString() === id.toString());

        if (!followup) {
          showMessage('មិនរកឃើញការតាមដានឯកសារផាក', 'Error');
          return;
        }

        const form = document.getElementById('fineFollowupForm');
        const elements = form.elements;

        // Basic information
        elements['no'].value = followup.no || `F-${followup.id}`;
        elements['date'].value = followup.date ? followup.date.split('T')[0] : '';

        // Set original inspection dropdown
        if (followup.inspectionId) {
          elements['original_inspection'].value = followup.inspectionId;
        }

        // Display company information
        const fineCompanyInfoDisplay = document.getElementById('fineCompanyInfoDisplay');
        if (followup.factory) {
          fineCompanyInfoDisplay.classList.remove('d-none');
          const addressParts = [];
          if (followup.factory.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory.province?.name) addressParts.push(followup.factory.province.name);

          fineCompanyInfoDisplay.innerHTML = `
            <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <strong>ឈ្មោះរោងចក្រ:</strong> ${followup.factory.factoryname || ''}
              </div>
              <div class="col-md-6">
                <strong>អាសយដ្ឋាន:</strong> ${addressParts.join(', ')}
              </div>
            </div>
          `;
        }

        // Display original fine information
        const originalFineInfo = document.getElementById('originalFineInfo');
        if (followup.inspection) {
          originalFineInfo.classList.remove('d-none');
          document.getElementById('fineDisplay').innerHTML = `
            <div class="row g-2">
              <div class="col-md-4"><strong>លេខចូល:</strong> ${followup.inspection.no || ''}</div>
              <div class="col-md-4"><strong>ក្រុម:</strong> ${followup.inspection.group || ''}</div>
              <div class="col-md-4"><strong>កាលបរិច្ឆេទ:</strong> ${followup.inspection.inspectionDate ? followup.inspection.inspectionDate.split('T')[0] : ''}</div>
              <div class="col-12"><strong>ប្រធានបទ:</strong> ${followup.inspection.caseSubject || ''}</div>
            </div>
          `;
        }

        // Populate fine detail fields
        elements['requiredDoc'].value = followup.requiredDoc || '';
        elements['workingCondition'].value = followup.workingCondition || followup.workingCondition || '';
        elements['osh'].value = followup.osh || '';
        elements['nsf'].value = followup.nsf || '';

        // Set status field
        if (followup.status) {
          elements['status'].value = followup.status;
        }

        // Set remark
        elements['remark'].value = followup.remark || '';
      }

      resetAllSelections() {
        document.querySelectorAll('.penalty-option').forEach(option => {
          option.classList.remove('selected');
        });
        document.querySelectorAll('.penalty-details').forEach(details => {
          details.classList.remove('active');
        });
      }



      async handleInspectionFormSubmit(e) {
  e.preventDefault();

  const formData = new FormData(e.target);
  const form = Object.fromEntries(formData);

  // STEP 1 — Build the complete inspection payload
  const inspectionPayload = {
    no: form.no,
    factoryId: Number(form.factory_name),
    caseSubject: form.case_subject,
    group: form.group,
    inspectionType: form.inspection_type,
    inspectionDate: form.inspection_date,
    status: "Checked",

    // -------------------------------
    // Non-compliance snapshot
    // -------------------------------
    isNonCompliance: form.has_penalty === "មាន",   // TRUE or FALSE

    ncRequiredDoc:
      form.has_penalty === "មាន" ? form.penalty_format : null,
    ncWorkingCondition:
      form.has_penalty === "មាន" ? form.penalty_condition : null,
    ncOsh:
      form.has_penalty === "មាន" ? form.penalty_health : null,
    ncNsf:
      form.has_penalty === "មាន" ? form.penalty_professional : null,

    // -------------------------------
    // Fine snapshot
    // -------------------------------
    isFine: form.has_fine === "មាន",  // TRUE or FALSE

    fineRequiredDoc:
      form.has_fine === "មាន" ? form.fine_format : null,
    fineWorkingCondition:
      form.has_fine === "មាន" ? form.fine_condition : null,
    fineOsh:
      form.has_fine === "មាន" ? form.fine_health : null,
    fineNsf:
      form.has_fine === "មាន" ? form.fine_professional : null,
  };

  console.log("Sending payload → ", inspectionPayload);

  try {
    // POST to your new inspection API
    const res = await fetch(`${API_BASE_URL}/inspections`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(inspectionPayload),
    });

    const result = await res.json();

    if (!result.data) {
      showMessage("Saving failed!", "Error");
      return;
    }

    showMessage("Inspection saved successfully!", "Success");
    bootstrap.Modal.getInstance(
      document.getElementById("inspectionModal")
    ).hide();
    this.renderInspections();

  } catch (err) {
    console.error("Save error:", err);
    showMessage("Error saving inspection!", "Error");
  }
}

      async handlePenaltyFollowupFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        if (!data.no || !data.original_inspection || !data.followup_date) {
          showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
          return;
        }

        const submitBtn = document.getElementById('penaltyFollowupSubmitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
        submitBtn.disabled = true;

        try {
          // Check if "អនុវត្ត" (Implemented) is selected
          const isImplemented = data.penalty_implemented === 'អនុវត្ត';

          // Build payload based on implementation status
          const payload = {
            no: data.no,
            inspectionId: Number(data.original_inspection),
            date: data.followup_date,
            remark: data.conclusion || '',
            status: data.status,
            isPractice: isImplemented, // Set isPractice to true if implemented

            // If implemented, set these fields to null/empty
            // If not implemented, include the detail fields
            requiredDoc: isImplemented ? null : (data.followup_format || null),
            workingCondition: isImplemented ? null : (data.followup_condition || null),
            osh: isImplemented ? null : (data.followup_health || null),
            nsf: isImplemented ? null : (data.followup_professional || null)
          };

          console.log('Penalty Followup Payload:', payload);

          if (currentEditingId) {
            // UPDATE existing penalty followup
            const res = await fetch(`${API_BASE_URL}/non-compliances/${currentEditingId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const result = await res.json();

            if (!result.data) {
              showMessage('មានបញ្ហាក្នុងការកែសម្រួល!', 'Error');
              return;
            }

            // If penalty is NOT implemented (មិនអនុវត្ត), create a fine entry
            if (!isImplemented) {
              console.log('Creating fine entry because penalty was not implemented...');

              // Get factory ID from the original inspection
              const originalInspection = this.allInspections.find(i => i.id.toString() === data.original_inspection);
              const factoryId = originalInspection?.factoryId || originalInspection?.factory?.id;

              if (!factoryId) {
                console.error('Factory ID not found for inspection');
                showMessage('ការតាមដានត្រូវបានកែសម្រួល ប៉ុន្តែមិនអាចបង្កើតផាក (រកមិនឃើញរោងចក្រ)!', 'Warning');
              } else {
                const finePayload = {
                  factoryId: Number(factoryId),
                  inspectionId: Number(data.original_inspection),
                  requiredDoc: data.followup_format || null,
                  workingCondition: data.followup_condition || null,
                  osh: data.followup_health || null,
                  nsf: data.followup_professional || null,
                  remark: data.conclusion || null,
                  status: null,
                  date: data.followup_date || null
                };

                console.log('Fine Payload:', finePayload);

                const fineRes = await fetch(`${API_BASE_URL}/fines`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(finePayload)
                });

                if (!fineRes.ok) {
                  console.error('Failed to create fine entry');
                  showMessage('ការតាមដានត្រូវបានកែសម្រួល ប៉ុន្តែមានបញ្ហាក្នុងការបង្កើតផាក!', 'Warning');
                } else {
                  const fineResult = await fineRes.json();
                  if (fineResult.data) {
                    console.log('Fine entry created successfully');
                    showMessage('ការតាមដានត្រូវបានកែសម្រួល និងបានបង្កើតផាកដោយជោគជ័យ!', 'Success');
                  }
                }
              }
            } else {
              showMessage('ការតាមដានត្រូវបានកែសម្រួលដោយជោគជ័យ!', 'Success');
            }
          } else {
            // CREATE new penalty followup
            const res = await fetch(`${API_BASE_URL}/non-compliances`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const result = await res.json();

            if (!result.data) {
              showMessage('មានបញ្ហាក្នុងការបង្កើត!', 'Error');
              return;
            }

            // If penalty is NOT implemented (មិនអនុវត្ត), create a fine entry
            if (!isImplemented) {
              console.log('Creating fine entry because penalty was not implemented...');

              // Get factory ID from the original inspection
              const originalInspection = this.allInspections.find(i => i.id.toString() === data.original_inspection);
              const factoryId = originalInspection?.factoryId || originalInspection?.factory?.id;

              if (!factoryId) {
                console.error('Factory ID not found for inspection');
                showMessage('ការតាមដានត្រូវបានបង្កើត ប៉ុន្តែមិនអាចបង្កើតផាក (រកមិនឃើញរោងចក្រ)!', 'Warning');
              } else {
                const finePayload = {
                  factoryId: Number(factoryId),
                  inspectionId: Number(data.original_inspection),
                  requiredDoc: data.followup_format || null,
                  workingCondition: data.followup_condition || null,
                  osh: data.followup_health || null,
                  nsf: data.followup_professional || null,
                  remark: data.conclusion || null,
                  status: null,
                  date: data.followup_date || null
                };

                console.log('Fine Payload:', finePayload);

                const fineRes = await fetch(`${API_BASE_URL}/fines`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(finePayload)
                });

                if (!fineRes.ok) {
                  console.error('Failed to create fine entry');
                  showMessage('ការតាមដានត្រូវបានបង្កើត ប៉ុន្តែមានបញ្ហាក្នុងការបង្កើតផាក!', 'Warning');
                } else {
                  const fineResult = await fineRes.json();
                  if (fineResult.data) {
                    console.log('Fine entry created successfully');
                    showMessage('ការតាមដានត្រូវបានបង្កើត និងបានបង្កើតផាកដោយជោគជ័យ!', 'Success');
                  }
                }
              }
            } else {
              showMessage('ការតាមដានត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
            }
          }

          const modal = bootstrap.Modal.getInstance(document.getElementById('penaltyFollowupModal'));
          modal.hide();

          // Refresh the penalty followups list
          await this.fetchNonCompliances();
          // Also refresh fines list if a fine was created
          if (!isImplemented) {
            await this.fetchFines();
          }

        } catch (error) {
          console.error('Save error:', error);
          showMessage('មានបញ្ហាក្នុងការរក្សាទុកការតាមដាន', 'Error');
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      async handleFineFollowupFormSubmit(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = Object.fromEntries(formData);

        if (!data.no || !data.original_inspection) {
          showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
          return;
        }

        const submitBtn = document.getElementById('fineFollowupSubmitBtn');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
        submitBtn.disabled = true;

        try {
          // Get factory ID from the original inspection
          const originalInspection = this.allInspections.find(i => i.id.toString() === data.original_inspection);
          const factoryId = originalInspection?.factoryId || originalInspection?.factory?.id;

          if (!factoryId) {
            showMessage('រកមិនឃើញព័ត៌មានរោងចក្រ!', 'Error');
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
            return;
          }

          // Build payload for fine followup
          const payload = {
            factoryId: Number(factoryId),
            inspectionId: Number(data.original_inspection),
            requiredDoc: data.requiredDoc || null,
            workingCondition: data.workingCondition || null,
            osh: data.osh || null,
            nsf: data.nsf || null,
            remark: data.remark || null,
            status: data.status || null,
            date: data.date || null
          };

          console.log('Fine Followup Payload:', payload);

          if (currentEditingId) {
            // UPDATE existing fine followup
            const res = await fetch(`${API_BASE_URL}/fines/${currentEditingId}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const result = await res.json();

            if (!result.data) {
              showMessage('មានបញ្ហាក្នុងការកែសម្រួល!', 'Error');
              return;
            }

            showMessage('ការតាមដានឯកសារផាកត្រូវបានកែសម្រួលដោយជោគជ័យ!', 'Success');
          } else {
            // CREATE new fine followup
            const res = await fetch(`${API_BASE_URL}/fines`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (!res.ok) {
              throw new Error(`HTTP error! status: ${res.status}`);
            }

            const result = await res.json();

            if (!result.data) {
              showMessage('មានបញ្ហាក្នុងការបង្កើត!', 'Error');
              return;
            }

            showMessage('ការតាមដានឯកសារផាកត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
          }

          const modal = bootstrap.Modal.getInstance(document.getElementById('fineFollowupModal'));
          modal.hide();

          // Refresh the fine followups list
          await this.fetchFines();

        } catch (error) {
          console.error('Save error:', error);
          showMessage('មានបញ្ហាក្នុងការរក្សាទុកការតាមដានឯកសារផាក', 'Error');
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      // Document generation methods
      async generateInspectionDocument(id) {
        const inspection = this.allInspections.find(i => i.id.toString() === id.toString());
        if (!inspection) {
          showMessage('Inspection not found', 'Error');
          return;
        }
        try {
          const doc = await this.docxGenerator.generateDocument('inspection', inspection);
          await this.docxGenerator.downloadDocument(doc, `Inspection_${inspection.no}`);
          showMessage('ឯកសារ DOCX ត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
        } catch (error) {
          console.error('Document generation error:', error);
          showMessage('មានបញ្ហាក្នុងការបង្កើតឯកសារ', 'Error');
        }
      }

      async generatePenaltyFollowupDocument(id) {
        const followup = this.allPenaltyFollowups.find(f => f.id.toString() === id.toString());
        if (!followup) {
          showMessage('Follow-up not found', 'Error');
          return;
        }
        try {
          const doc = await this.docxGenerator.generateDocument('penaltyFollowup', followup);
          await this.docxGenerator.downloadDocument(doc, `PenaltyFollowup_${followup.no}`);
          showMessage('ឯកសារ DOCX ត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
        } catch (error) {
          console.error('Document generation error:', error);
          showMessage('មានបញ្ហាក្នុងការបង្កើតឯកសារ', 'Error');
        }
      }

      async generateFineFollowupDocument(id) {
        const followup = this.allFineFollowups.find(f => f.id.toString() === id.toString());
        if (!followup) {
          showMessage('Fine document follow-up not found', 'Error');
          return;
        }
        try {
          const doc = await this.docxGenerator.generateDocument('fineFollowup', followup);
          await this.docxGenerator.downloadDocument(doc, `FineFollowup_${followup.no}`);
          showMessage('ឯកសារ DOCX ត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
        } catch (error) {
          console.error('Document generation error:', error);
          showMessage('មានបញ្ហាក្នុងការបង្កើតឯកសារ', 'Error');
        }
      }

      // Template management methods
      uploadTemplate(templateType) {
        const fileInput = document.getElementById('hiddenFileInput');
        fileInput.onchange = (e) => {
          const file = e.target.files[0];
          if (file && file.name.endsWith('.docx')) {
            // In a real application, you would upload and process the DOCX template
            showMessage('ទំរង់ DOCX ត្រូវបានផ្ទុកឡើងដោយជោគជ័យ!', 'Success');
          } else {
            showMessage('សូមជ្រើសរើសឯកសារ DOCX', 'Error');
          }
        };
        fileInput.click();
      }

      downloadTemplate(templateType) {
        // In a real application, you would download the actual template
        showMessage('ទំរង់លំនាំដើមត្រូវបានទាញយកដោយជោគជ័យ!', 'Success');
      }

      // View methods
      viewInspection(id) {
        const inspection = this.allInspections.find(i => i.id.toString() === id.toString());
        if (!inspection) {
          showMessage('Inspection not found', 'Error');
          return;
        }

        // Helper function to format date
        const formatDate = (dateString) => {
          if (!dateString) return 'N/A';
          const date = new Date(dateString);
          return date.toLocaleDateString('km-KH', { year: 'numeric', month: 'long', day: 'numeric' });
        };

        // Populate basic information
        document.getElementById('view_no').textContent = inspection.no || 'N/A';
        document.getElementById('view_group').textContent = inspection.group || 'N/A';
        document.getElementById('view_inspection_date').textContent = formatDate(inspection.inspectionDate);
        document.getElementById('view_inspection_type').textContent = inspection.inspectionType || 'N/A';
        document.getElementById('view_factory_name').textContent = inspection.factory?.factoryname || inspection.factory?.factoryname_en || 'N/A';
        document.getElementById('view_case_subject').textContent = inspection.caseSubject || 'N/A';
        document.getElementById('view_status').textContent = inspection.status || 'N/A';

        // Populate Non-Compliance section
        const hasNonCompliance = inspection.isNonCompliance;
        document.getElementById('view_has_noncompliance').textContent = hasNonCompliance ? 'មាន' : 'គ្មាន';

        const nonComplianceDetails = document.getElementById('view_noncompliance_details');
        if (hasNonCompliance) {
          nonComplianceDetails.classList.remove('d-none');
          document.getElementById('view_nc_required_doc').textContent = inspection.ncRequiredDoc || 'N/A';
          document.getElementById('view_nc_working_condition').textContent = inspection.ncWorkingCondition || 'N/A';
          document.getElementById('view_nc_osh').textContent = inspection.ncOsh || 'N/A';
          document.getElementById('view_nc_nsf').textContent = inspection.ncNsf || 'N/A';

          // Display non-compliance list
          const ncList = document.getElementById('view_noncompliance_list');
          if (inspection.nonCompliance && inspection.nonCompliance.length > 0) {
            ncList.innerHTML = inspection.nonCompliance.map((nc, index) => `
              <div class="mb-2 p-2 border-start border-3 border-warning">
                <strong>${index + 1}.</strong> ${nc.description || nc.title || JSON.stringify(nc)}
              </div>
            `).join('');
          } else {
            ncList.innerHTML = '<p class="text-muted mb-0">គ្មានកំហិតលម្អិត</p>';
          }
        } else {
          nonComplianceDetails.classList.add('d-none');
        }

        // Populate Fine section
        const hasFine = inspection.isFine;
        document.getElementById('view_has_fine').textContent = hasFine ? 'មាន' : 'គ្មាន';

        const fineDetails = document.getElementById('view_fine_details');
        if (hasFine) {
          fineDetails.classList.remove('d-none');
          document.getElementById('view_fine_required_doc').textContent = inspection.fineRequiredDoc || 'N/A';
          document.getElementById('view_fine_working_condition').textContent = inspection.fineWorkingCondition || 'N/A';
          document.getElementById('view_fine_osh').textContent = inspection.fineOsh || 'N/A';
          document.getElementById('view_fine_nsf').textContent = inspection.fineNsf || 'N/A';

          // Display fine list
          const fineList = document.getElementById('view_fine_list');
          if (inspection.fines && inspection.fines.length > 0) {
            fineList.innerHTML = inspection.fines.map((fine, index) => `
              <div class="mb-2 p-2 border-start border-3 border-danger">
                <strong>${index + 1}.</strong> ${fine.description || fine.amount || JSON.stringify(fine)}
              </div>
            `).join('');
          } else {
            fineList.innerHTML = '<p class="text-muted mb-0">គ្មានផាកលម្អិត</p>';
          }
        } else {
          fineDetails.classList.add('d-none');
        }

        // Populate timestamps
        document.getElementById('view_created_at').textContent = formatDate(inspection.createdAt);
        document.getElementById('view_updated_at').textContent = formatDate(inspection.updatedAt);

        // Open the modal
        const modal = new bootstrap.Modal(document.getElementById('viewInspectionModal'));
        modal.show();
      }

      viewPenaltyFollowup(id) {
        const followup = this.allPenaltyFollowups.find(f => f.id.toString() === id.toString());
        if (!followup) {
          showMessage('Follow-up not found', 'Error');
          return;
        }

        // Open modal in view mode
        const modal = new bootstrap.Modal(document.getElementById('penaltyFollowupModal'));
        const modalTitle = document.getElementById('penaltyFollowupModalTitle');
        const form = document.getElementById('penaltyFollowupForm');

        modalTitle.textContent = 'មើលព័ត៌មានលម្អិតតាមដានកំហិត';

        // Populate original inspections dropdown first
        this.populateOriginalInspections();

        // Populate form fields with backend data
        const elements = form.elements;

        // Basic information
        elements['no'].value = followup.no || `NC-${followup.id}`;
        elements['followup_date'].value = followup.date ? followup.date.split('T')[0] : '';

        // Set original inspection dropdown
        if (followup.inspectionId) {
          elements['original_inspection'].value = followup.inspectionId;
        }

        // Display company information
        const companyInfoDisplay = document.getElementById('companyInfoDisplay');
        if (followup.factory) {
          companyInfoDisplay.classList.remove('d-none');
          const addressParts = [];
          if (followup.factory.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory.province?.name) addressParts.push(followup.factory.province.name);

          companyInfoDisplay.innerHTML = `
            <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <strong>ឈ្មោះរោងចក្រ:</strong> ${followup.factory.factoryname || ''}
              </div>
              <div class="col-md-6">
                <strong>អាសយដ្ឋាន:</strong> ${addressParts.join(', ')}
              </div>
            </div>
          `;
        }

        // Display original inspection information
        const originalPenaltyInfo = document.getElementById('originalPenaltyInfo');
        if (followup.inspection) {
          originalPenaltyInfo.classList.remove('d-none');
          document.getElementById('penaltyDisplay').innerHTML = `
            <div class="row g-2">
              <div class="col-md-4"><strong>លេខចូល:</strong> ${followup.inspection.no || ''}</div>
              <div class="col-md-4"><strong>ក្រុម:</strong> ${followup.inspection.group || ''}</div>
              <div class="col-md-4"><strong>កាលបរិច្ឆេទ:</strong> ${followup.inspection.inspectionDate ? followup.inspection.inspectionDate.split('T')[0] : ''}</div>
              <div class="col-12"><strong>ប្រធានបទ:</strong> ${followup.inspection.caseSubject || ''}</div>
            </div>
          `;
        }

        // Determine penalty implementation status based on isPractice field
        const penaltyImplemented = followup.isPractice === true ? 'អនុវត្ត' : 'មិនអនុវត្ត';

        // Select the appropriate radio button
        const implementedRadio = form.querySelector(`input[name="penalty_implemented"][value="${penaltyImplemented}"]`);
        if (implementedRadio) {
          implementedRadio.checked = true;
          // Trigger the change event to show/hide followup details
          toggleFollowupDetails(penaltyImplemented === 'មិនអនុវត្ត');
        }

        // Populate followup details (only if not implemented)
        if (followup.isPractice !== true) {
          elements['followup_format'].value = followup.requiredDoc || '';
          elements['followup_condition'].value = followup.workingCondition || '';
          elements['followup_health'].value = followup.osh || '';
          elements['followup_professional'].value = followup.nsf || '';
        }

        elements['conclusion'].value = followup.remark || '';

        // Set status field if available
        if (followup.status && elements['status']) {
          elements['status'].value = followup.status;
        }

        // Make all form fields readonly
        Array.from(elements).forEach(element => {
          if (element.type !== 'button' && element.type !== 'submit') {
            element.setAttribute('readonly', true);
            element.setAttribute('disabled', true);
          }
        });

        // Hide submit button, show only close button
        document.getElementById('penaltyFollowupSubmitBtn').style.display = 'none';

        modal.show();

        // Reset form to editable state when modal is closed
        document.getElementById('penaltyFollowupModal').addEventListener('hidden.bs.modal', function() {
          Array.from(elements).forEach(element => {
            element.removeAttribute('readonly');
            element.removeAttribute('disabled');
          });
          document.getElementById('penaltyFollowupSubmitBtn').style.display = '';
          form.reset();
          companyInfoDisplay.classList.add('d-none');
          originalPenaltyInfo.classList.add('d-none');
        }, { once: true });
      }

      viewFineFollowup(id) {
        const followup = this.allFineFollowups.find(f => f.id.toString() === id.toString());
        if (!followup) {
          showMessage('Fine document follow-up not found', 'Error');
          return;
        }

        // Open modal in view mode
        const modal = new bootstrap.Modal(document.getElementById('fineFollowupModal'));
        const modalTitle = document.getElementById('fineFollowupModalTitle');
        const form = document.getElementById('fineFollowupForm');

        modalTitle.textContent = 'មើលព័ត៌មានលម្អិតតាមដានឯកសារផាក';

        // Populate original inspections dropdown first
        this.populateOriginalInspections();

        // Populate form fields with backend data
        const elements = form.elements;

        // Basic information
        elements['no'].value = followup.no || `F-${followup.id}`;
        elements['date'].value = followup.date ? followup.date.split('T')[0] : '';

        // Set original inspection dropdown
        if (followup.inspectionId) {
          elements['original_inspection'].value = followup.inspectionId;
        }

        // Display company information
        const fineCompanyInfoDisplay = document.getElementById('fineCompanyInfoDisplay');
        if (followup.factory) {
          fineCompanyInfoDisplay.classList.remove('d-none');
          const addressParts = [];
          if (followup.factory.commune?.name) addressParts.push(followup.factory.commune.name);
          if (followup.factory.district?.name) addressParts.push(followup.factory.district.name);
          if (followup.factory.province?.name) addressParts.push(followup.factory.province.name);

          fineCompanyInfoDisplay.innerHTML = `
            <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
            <div class="row g-3">
              <div class="col-md-6">
                <strong>ឈ្មោះរោងចក្រ:</strong> ${followup.factory.factoryname || ''}
              </div>
              <div class="col-md-6">
                <strong>អាសយដ្ឋាន:</strong> ${addressParts.join(', ')}
              </div>
            </div>
          `;
        }

        // Display original fine information
        const originalFineInfo = document.getElementById('originalFineInfo');
        if (followup.inspection) {
          originalFineInfo.classList.remove('d-none');
          document.getElementById('fineDisplay').innerHTML = `
            <div class="row g-2">
              <div class="col-md-4"><strong>លេខចូល:</strong> ${followup.inspection.no || ''}</div>
              <div class="col-md-4"><strong>ក្រុម:</strong> ${followup.inspection.group || ''}</div>
              <div class="col-md-4"><strong>កាលបរិច្ឆេទ:</strong> ${followup.inspection.inspectionDate ? followup.inspection.inspectionDate.split('T')[0] : ''}</div>
              <div class="col-12"><strong>ប្រធានបទ:</strong> ${followup.inspection.caseSubject || ''}</div>
            </div>
          `;
        }

        // Populate fine detail fields
        elements['requiredDoc'].value = followup.requiredDoc || '';
        elements['workingCondition'].value = followup.workingCondition || followup.workingCondition || '';
        elements['osh'].value = followup.osh || '';
        elements['nsf'].value = followup.nsf || '';

        // Set status field
        if (followup.status) {
          elements['status'].value = followup.status;
        }

        // Set remark
        elements['remark'].value = followup.remark || '';

        // Make all form fields readonly
        Array.from(elements).forEach(element => {
          if (element.type !== 'button' && element.type !== 'submit') {
            element.setAttribute('readonly', true);
            element.setAttribute('disabled', true);
          }
        });

        // Hide submit button, show only close button
        document.getElementById('fineFollowupSubmitBtn').style.display = 'none';

        modal.show();

        // Reset form to editable state when modal is closed
        document.getElementById('fineFollowupModal').addEventListener('hidden.bs.modal', function() {
          Array.from(elements).forEach(element => {
            element.removeAttribute('readonly');
            element.removeAttribute('disabled');
          });
          document.getElementById('fineFollowupSubmitBtn').style.display = '';
          form.reset();
          fineCompanyInfoDisplay.classList.add('d-none');
          originalFineInfo.classList.add('d-none');
        }, { once: true });
      }

      // Edit methods
      editInspection(id) {
        this.openInspectionForm(id);
      }

      editPenaltyFollowup(id) {
        this.openPenaltyFollowupForm(id);
      }

      editFineFollowup(id) {
        this.openFineFollowupForm(id);
      }

      // Delete confirmation methods
      deleteInspectionConfirm(id) {
        if (confirm('តើអ្នកប្រាកដថាចង់លុបការត្រួតពិនិត្យនេះមែនទេ?')) {
          this.deleteInspection(id);
        }
      }

      deletePenaltyFollowupConfirm(id) {
        if (confirm('តើអ្នកប្រាកដថាចង់លុបតាមដានកំហិតនេះមែនទេ?')) {
          this.deletePenaltyFollowup(id);
        }
      }

      deleteFineFollowupConfirm(id) {
        if (confirm('តើអ្នកប្រាកដថាចង់លុបតាមដានឯកសារផាកនេះមែនទេ?')) {
          this.deleteFineFollowup(id);
        }
      }

      // Delete methods
      deleteInspection(id) {
        try {
          this.allInspections = this.allInspections.filter(i => i.id.toString() !== id.toString());
          this.renderInspections();
          this.populateOriginalInspections();
          showMessage('ការត្រួតពិនិត្យត្រូវបានលុបដោយជោគជ័យ!', 'Success');
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('មានបញ្ហាក្នុងការលុបការត្រួតពិនិត្យ', 'Error');
        }
      }

      deletePenaltyFollowup(id) {
        try {
          this.allPenaltyFollowups = this.allPenaltyFollowups.filter(f => f.id.toString() !== id.toString());
          this.renderPenaltyFollowups();
          showMessage('ការតាមដានកំហិតត្រូវបានលុបដោយជោគជ័យ!', 'Success');
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('មានបញ្ហាក្នុងការលុបការតាមដានកំហិត', 'Error');
        }
      }

      async deleteFineFollowup(id) {
        try {
          const res = await fetch(`${API_BASE_URL}/fines/${id}`, {
            method: 'DELETE'
          });

          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }

          showMessage('ការតាមដានឯកសារផាកត្រូវបានលុបដោយជោគជ័យ!', 'Success');

          // Refresh the fine followups list
          await this.fetchFines();
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('មានបញ្ហាក្នុងការលុបការតាមដានឯកសារផាក', 'Error');
        }
      }

      populateOriginalInspections() {
        const select = document.getElementById('originalInspectionSelect');
        const fineSelect = document.getElementById('fineOriginalInspectionSelect');

        if (select) {
          select.innerHTML = '<option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>';

          // Filter inspections that have non-compliance (isNonCompliance === true)
          this.allInspections.filter(inspection => inspection.isNonCompliance === true).forEach(inspection => {
            const option = document.createElement('option');
            option.value = inspection.id;
            const factoryName = inspection.factory?.factoryname || inspection.factory_name || '';
            const inspectionDate = inspection.inspection_date || inspection.inspectionDate || '';
            option.textContent = `${inspection.no} - ${factoryName} (${inspectionDate})`;
            select.appendChild(option);
          });
        }

        if (fineSelect) {
          fineSelect.innerHTML = '<option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>';

          // Filter inspections that have fines (isFine === true)
          this.allInspections.filter(inspection => inspection.isFine === true).forEach(inspection => {
            const option = document.createElement('option');
            option.value = inspection.id;
            const factoryName = inspection.factory?.factoryname || inspection.factory_name || '';
            const inspectionDate = inspection.inspection_date || inspection.inspectionDate || '';
            option.textContent = `${inspection.no} - ${factoryName} (${inspectionDate})`;
            fineSelect.appendChild(option);
          });
        }
      }

      // Export methods
      exportInspectionsToExcel() {
        try {
          const ws = XLSX.utils.json_to_sheet(this.allInspections);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Inspections");
          XLSX.writeFile(wb, "inspections.xlsx");
          showMessage('Excel file downloaded successfully', 'Success');
        } catch (error) {
          console.error('Export error:', error);
          showMessage('Failed to export to Excel', 'Error');
        }
      }

      exportPenaltyFollowupsToExcel() {
        try {
          const exportData = this.allPenaltyFollowups.map(followup => ({
            'លេខចូល': followup.no,
            'រោងចក្រ': followup.original_inspection_data?.factory_name || '',
            'កាលបរិច្ឆេទតាមដាន': followup.followup_date,
            'កាលបរិច្ឆេទកំហិតដើម': followup.original_inspection_data?.inspection_date || '',
            'ស្ថានភាពតាមដាន': followup.penalty_implemented,
            'សេចក្តីសន្និដ្ឋាន': followup.conclusion
          }));

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "PenaltyFollowups");
          XLSX.writeFile(wb, "penalty_followups.xlsx");
          showMessage('Excel file downloaded successfully', 'Success');
        } catch (error) {
          console.error('Export error:', error);
          showMessage('Failed to export to Excel', 'Error');
        }
      }

      exportFineFollowupsToExcel() {
        try {
          const exportData = this.allFineFollowups.map(followup => ({
            'លេខចូល': followup.no || followup.inspection?.no || '',
            'រោងចក្រ': followup.factory?.factoryname || '',
            'កាលបរិច្ឆេទ': followup.date ? followup.date.split('T')[0] : '',
            'ឯកសារតម្រូវការ': followup.requiredDoc || '',
            'លក្ខខណ្ឌការងារ': followup.workingCondition || followup.workingCondition || '',
            'សុខភាពនិងសុវត្ថិភាព': followup.osh || '',
            'វិជ្ជាជីវៈ': followup.nsf || '',
            'ស្ថានភាព': followup.status || '',
            'ផ្សេងៗ': followup.remark || ''
          }));

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "FineFollowups");
          XLSX.writeFile(wb, "fine_followups.xlsx");
          showMessage('Excel file downloaded successfully', 'Success');
        } catch (error) {
          console.error('Export error:', error);
          showMessage('Failed to export to Excel', 'Error');
        }
      }
    }

    // Global functions for modal interactions
    function togglePenaltyDetails(showDetails) {
      const detailsElement = document.getElementById('penalty_details');
      const yesOption = document.getElementById('penalty_yes_option');
      const noOption = document.getElementById('penalty_no_option');
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
      }
    }

    function toggleFineDetails(showDetails) {
      const detailsElement = document.getElementById('fine_details');
      const yesOption = document.getElementById('fine_yes_option');
      const noOption = document.getElementById('fine_no_option');
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
      }
    }

    function toggleFollowupDetails(showDetails) {
      const detailsElement = document.getElementById('followup_details');
      const yesOption = document.getElementById('implemented_yes_option');
      const noOption = document.getElementById('implemented_no_option');
      if (showDetails) {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.remove('active');
      }
    }

    function updateDocumentFlow(status) {
      const steps = {
        department: document.getElementById('step_department'),
        general: document.getElementById('step_general'),
        minister: document.getElementById('step_minister')
      };
      // Reset all steps
      Object.values(steps).forEach(step => {
        step.classList.remove('completed', 'pending');
        step.querySelector('i').className = 'bi bi-circle';
      });

      // Update steps based on status
      switch (status) {
        case 'department':
          steps.department.classList.add('completed');
          steps.department.querySelector('i').className = 'bi bi-check-circle-fill';
          steps.general.classList.add('pending');
          break;
        case 'general':
          steps.department.classList.add('completed');
          steps.department.querySelector('i').className = 'bi bi-check-circle-fill';
          steps.general.classList.add('completed');
          steps.general.querySelector('i').className = 'bi bi-check-circle-fill';
          steps.minister.classList.add('pending');
          break;
        case 'minister':
        case 'completed':
          Object.values(steps).forEach(step => {
            step.classList.add('completed');
            step.querySelector('i').className = 'bi bi-check-circle-fill';
          });
          break;
      }
    }

    function updateFactoryInfo() {
      const select = document.querySelector('select[name="factory_name"]');
      const selectedOption = select.options[select.selectedIndex];
      if (selectedOption.value) {
        document.querySelector('input[name="sector"]').value = selectedOption.getAttribute('data-sector') || '';
        document.querySelector('input[name="village"]').value = selectedOption.getAttribute('data-village') || '';
        document.querySelector('input[name="commune"]').value = selectedOption.getAttribute('data-commune') || '';
        document.querySelector('input[name="district"]').value = selectedOption.getAttribute('data-district') || '';
        document.querySelector('input[name="province"]').value = selectedOption.getAttribute('data-province') || '';
      }
    }

    function loadOriginalInspectionData() {
      const select = document.getElementById('originalInspectionSelect');
      if (!select) return;
      const inspectionId = select.value;
      const infoDiv = document.getElementById('originalPenaltyInfo');
      const companyInfoDiv = document.getElementById('companyInfoDisplay');
      const penaltyDisplay = document.getElementById('penaltyDisplay');
      if (inspectionId) {
        const inspection = window.inspectionManager.allInspections.find(i => i.id.toString() === inspectionId);
        if (inspection) {
          // Display company information
          document.getElementById('display_factory_name').value = inspection.factory_name || '';
          document.getElementById('display_sector').value = inspection.sector || '';
          document.getElementById('display_case_subject').value = inspection.case_subject || '';
          document.getElementById('display_village').value = inspection.village || '';
          document.getElementById('display_commune').value = inspection.commune || '';
          document.getElementById('display_district').value = inspection.district || '';
          document.getElementById('display_province').value = inspection.province || '';
          companyInfoDiv.classList.remove('d-none');
          // Display penalty information if exists
          if (inspection.has_penalty === 'មាន') {
            penaltyDisplay.innerHTML = `
              <p><strong>បែបបទ:</strong> <span>${inspection.penalty_format || 'N/A'}</span></p>
              <p><strong>លក្ខខណ្ឌ:</strong> <span>${inspection.penalty_condition || 'N/A'}</span></p>
              <p><strong>សុខភាពនិងសុវត្ថភាព:</strong> <span>${inspection.penalty_health || 'N/A'}</span></p>
              <p><strong>វិជ្ជាជីវៈ:</strong> <span>${inspection.penalty_professional || 'N/A'}</span></p>
            `;
            infoDiv.classList.remove('d-none');
          } else {
            infoDiv.classList.add('d-none');
            showMessage('ការត្រួតពិនិត្យដើមនេះមិនមានកំហិតទេ', 'Info');
          }
        }
      } else {
        companyInfoDiv.classList.add('d-none');
        infoDiv.classList.add('d-none');
      }
    }

    function loadFineOriginalInspectionData() {
      const select = document.getElementById('fineOriginalInspectionSelect');
      if (!select) return;
      const inspectionId = select.value;
      const infoDiv = document.getElementById('originalFineInfo');
      const companyInfoDiv = document.getElementById('fineCompanyInfoDisplay');
      const fineDisplay = document.getElementById('fineDisplay');
      if (inspectionId) {
        const inspection = window.inspectionManager.allInspections.find(i => i.id.toString() === inspectionId);
        if (inspection) {
          // Display company information
          document.getElementById('fine_display_factory_name').value = inspection.factory_name || '';
          document.getElementById('fine_display_sector').value = inspection.sector || '';
          document.getElementById('fine_display_case_subject').value = inspection.case_subject || '';
          companyInfoDiv.classList.remove('d-none');
          // Display fine information if exists
          if (inspection.has_fine === 'មាន') {
            fineDisplay.innerHTML = `
              <p><strong>ចំនួនទឹកប្រាក់:</strong> <span>${inspection.fine_amount || 'N/A'} ${inspection.fine_type || ''}</span></p>
              <p><strong>ហេតុផល:</strong> <span>${inspection.fine_reason || 'N/A'}</span></p>
            `;
            infoDiv.classList.remove('d-none');
            // Pre-fill fine amount and type
            document.querySelector('#fineFollowupForm input[name="fine_amount"]').value = inspection.fine_amount || '';
            document.querySelector('#fineFollowupForm input[name="fine_type"]').value = inspection.fine_type || '';
          } else {
            infoDiv.classList.add('d-none');
            showMessage('ការត្រួតពិនិត្យដើមនេះមិនមានផាកទេ', 'Info');
          }
        }
      } else {
        companyInfoDiv.classList.add('d-none');
        infoDiv.classList.add('d-none');
      }
    }

    async function loadFactories() {
      try {
        const res = await fetch(`${API_BASE_URL}/fac/list`); // Example: /api/factories
        const json = await res.json();
        const factories = json.data;

        const select = document.getElementById("factorySelect");

        factories.forEach(factory => {
          const option = document.createElement("option");

          option.value = factory.id;
          option.textContent = factory.factoryname;

          // Attach extra data for auto-fill
          option.dataset.sector = factory.sector;
          option.dataset.village = factory.address;   // you may update this later
          option.dataset.commune = factory.commune?.name || "";
          option.dataset.district = factory.district?.name || "";
          option.dataset.province = factory.province?.name || "";

          select.appendChild(option);
        });

      } catch (err) {
        console.error("Error loading factories:", err);
      }
    }

    function updateFactoryInfo() {
      const select = document.getElementById("factorySelect");
      const selected = select.options[select.selectedIndex];

      document.querySelector('input[name="sector"]').value = selected.dataset.sector || "";
      document.querySelector('input[name="village"]').value = selected.dataset.village || "";
      document.querySelector('input[name="commune"]').value = selected.dataset.commune || "";
      document.querySelector('input[name="district"]').value = selected.dataset.district || "";
      document.querySelector('input[name="province"]').value = selected.dataset.province || "";
    }

    document.getElementById("factorySelect").addEventListener("change", updateFactoryInfo);


    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.inspectionManager = new InspectionManager();
      window.inspectionManager.init();

      loadFactories()
    });
  </script>
</body>

</html>