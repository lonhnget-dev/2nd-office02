<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Office 02 - Document Management System</title>
  <link rel="stylesheet" href="style.css">

  <!-- Excel Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Reset and base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    /* Main content adjustment for sidebar */
    .main-content {
      margin-left: 250px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    /* Mobile responsive for main content */
    @media (max-width: 768px) {
      .main-content {
        margin-left: 0;
      }
    }

    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      padding: 30px 20px;
      margin: 0;
    }

    .page-header h1 {
      font-size: 2.2rem;
      font-weight: 700;
      margin-bottom: 8px;
      text-align: center;
    }

    .page-header .subtitle {
      font-size: 1.1rem;
      text-align: center;
      opacity: 0.9;
      font-weight: 300;
    }

    .add-document {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: white;
      margin: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      .add-document {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }
    }

    .filter-section {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    @media (max-width: 768px) {
      .filter-section {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    #openForm {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 8px rgba(11, 61, 145, 0.3);
    }

    #openForm:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(11, 61, 145, 0.4);
    }

    .table-container {
      margin: 20px;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      position: relative;
    }

    .table-wrapper {
      overflow-x: auto;
      max-height: 70vh;
      overflow-y: auto;
      position: relative;
    }

    .table-wrapper::-webkit-scrollbar {
      height: 12px;
      width: 12px;
    }

    .table-wrapper::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 6px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 6px;
      border: 2px solid #f1f1f1;
    }

    .table-wrapper::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    .table-wrapper::-webkit-scrollbar-corner {
      background: #f1f1f1;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1600px;
    }

    th, td {
      padding: 10px 12px;
      text-align: left;
      border-bottom: 1px solid #eaeaea;
      font-size: 0.85rem;
      white-space: nowrap;
    }

    th {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      font-size: 0.8rem;
      padding: 12px;
    }

    tr:hover {
      background-color: #f8f9fa;
    }

    /* Column widths */
    td:nth-child(1), th:nth-child(1) {
      min-width: 80px;
      max-width: 100px;
      position: sticky;
      left: 0;
      background: white;
      z-index: 10;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    th:nth-child(1) {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      z-index: 20;
    }

    td:nth-child(2), th:nth-child(2) {
      min-width: 120px;
    }

    td:nth-child(4), th:nth-child(4),
    td:nth-child(7), th:nth-child(7),
    td:nth-child(9), th:nth-child(9),
    td:nth-child(15), th:nth-child(15) {
      min-width: 110px;
    }

    td:nth-child(18), th:nth-child(18) {
      min-width: 140px;
      position: sticky;
      right: 0;
      background: white;
      z-index: 10;
      box-shadow: -2px 0 5px rgba(0,0,0,0.1);
    }

    th:nth-child(18) {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      z-index: 20;
    }

    /* Form Modal Styles */
    #myForm {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 0;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      z-index: 1001;
      max-width: 800px;
      width: 95%;
      max-height: 85vh;
      overflow: hidden;
    }

    .form-header {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      padding: 25px 30px;
      border-radius: 16px 16px 0 0;
    }

    .form-header h2 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .form-content {
      padding: 30px;
      max-height: calc(85vh - 120px);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: #c1c1c1 #f1f1f1;
    }

    .form-content::-webkit-scrollbar {
      width: 8px;
    }

    .form-content::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .form-content::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .form-content::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Form Grid Layout */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      #myForm {
        max-width: 95%;
        max-height: 95vh;
      }
      
      .form-content {
        max-height: calc(95vh - 120px);
        padding: 20px;
      }
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 0.95rem;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #0b3d91;
      box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
    }

    /* Required field styling */
    .form-group label:has(+ input:required)::after {
      content: " *";
      color: #dc3545;
    }

    input:required {
      border-left: 3px solid #0b3d91;
    }

    .form-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 1px solid #eaeaea;
    }

    @media (max-width: 768px) {
      .form-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-submit,
      .btn-close {
        width: 100%;
      }
    }

    .btn-submit {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(11, 61, 145, 0.3);
    }

    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(11, 61, 145, 0.4);
    }

    .btn-close {
      background: #6c757d;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .btn-close:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }

    #overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      z-index: 1000;
    }

    /* Modern Popup Styles */
    .popup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(4px);
      justify-content: center;
      align-items: center;
      z-index: 1002;
    }

    .popup-content {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
      max-width: 600px;
      width: 95%;
      overflow: hidden;
    }

    .popup-header {
      background: linear-gradient(135deg, #0b3d91 0%, #1e5bc9 100%);
      color: white;
      padding: 25px 30px;
      position: relative;
    }

    .popup-header h2 {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .popup-body {
      padding: 30px;
    }

    /* Document Summary Format */
    .document-summary {
      font-family: 'Khmer OS', 'Arial', sans-serif;
      line-height: 1.6;
      font-size: 1rem;
    }

    .greeting {
      font-size: 1.1rem;
      font-weight: 600;
      color: #0b3d91;
      margin-bottom: 20px;
      text-align: center;
    }

    .document-info,
    .additional-info {
      margin: 15px 0;
      padding-left: 10px;
    }

    .status-info {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin: 20px 0;
      border-left: 4px solid #0b3d91;
    }

    .info-line {
      margin: 10px 0;
      color: #333;
      font-size: 1rem;
    }

    .closing {
      text-align: center;
      font-weight: 600;
      color: #0b3d91;
      margin-top: 25px;
      font-size: 1.1rem;
    }

    /* Highlight important information */
    .status-info strong {
      color: #dc3545;
      font-size: 1.1rem;
    }

    .document-summary span:not(.greeting):not(.closing) {
      color: #0b3d91;
      font-weight: 500;
    }

    .close {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 28px;
      cursor: pointer;
      color: white;
      background: none;
      border: none;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Button styles in table */
    button {
      padding: 6px 10px;
      margin: 1px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.8rem;
      font-weight: 500;
      min-width: 60px;
    }

    .editBtn {
      background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
      color: black;
    }

    .editBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }

    .deleteBtn {
      background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
      color: white;
    }

    .deleteBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
    }

    /* Search and filter inputs */
    #searchBox, #showCount {
      padding: 10px 14px;
      border: 2px solid #e1e5e9;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    #searchBox:focus, #showCount:focus {
      outline: none;
      border-color: #0b3d91;
      box-shadow: 0 0 0 3px rgba(11, 61, 145, 0.1);
    }

    #exportExcelBtn {
      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    #exportExcelBtn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(40, 167, 69, 0.4);
    }

    /* View button in table */
    button:not(.editBtn):not(.deleteBtn):not(.btn-submit):not(.btn-close):not(#openForm):not(#exportExcelBtn) {
      background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
      color: white;
    }

    button:not(.editBtn):not(.deleteBtn):not(.btn-submit):not(.btn-close):not(#openForm):not(#exportExcelBtn):hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
    }

    /* Scroll indicators */
    .table-container::before,
    .table-container::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 20px;
      pointer-events: none;
      z-index: 5;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .table-container::before {
      left: 0;
      background: linear-gradient(90deg, rgba(0,0,0,0.1) 0%, transparent 100%);
    }

    .table-container::after {
      right: 0;
      background: linear-gradient(270deg, rgba(0,0,0,0.1) 0%, transparent 100%);
    }

    .table-container.scroll-left::before,
    .table-container.scroll-right::after {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div id="navbar"></div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Page Header -->
    <header class="page-header">
      <h1>ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¯á€áŸá¶áš</h1>
      <p class="subtitle">Document Management System - Office 02</p>
    </header>

    <!-- Add Document + Filter Section -->
    <section class="add-document">
      <button id="openForm">â• á”á‰áŸ’á…á¼á›á¯á€áŸá¶áš</button>

      <div class="filter-section">
        <label>á”á„áŸ’á á¶á‰á…áŸ†á“á½á“:</label>
        <select id="showCount">
          <option value="15">15</option>
          <option value="30">30</option>
          <option value="60">60</option>
          <option value="100">100</option>
          <option value="all">All</option>
        </select>

        <input type="search" id="searchBox" placeholder="áŸáŸ’áœáŸ‚á„ášá€á¯á€áŸá¶áš...">
        <button id="exportExcelBtn">ğŸ“¥ á‘á¶á‰á™á€ Excel</button>
      </div>
    </section>

    <!-- Table -->
    <div class="table-container">
      <div class="table-wrapper">
        <table id="documentTable">
          <thead>
            <tr>
              <th>á›áŸáá…á¼á›.</th>
              <th>á›áŸáá›á·áá·á (IR)</th>
              <th>á›áŸáá…áŸá‰</th>
              <th>ááŸ’á„áŸƒááŸ‚á›á·áá·áá…á¼á›/á…áŸá‰</th>
              <th>á¢á„áŸ’á‚á—á¶á–/á”áŸ’ášá—á–á›á·áá·á</th>
              <th>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</th>
              <th>ááŸ’á„áŸƒááŸ‚á˜á»áá€á¶ášá·.áŸ¢</th>
              <th>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›á˜á»áá€á¶áš</th>
              <th>ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†á‘á‘á½á›</th>
              <th>áŸáŸ’áá¶á“á—á¶á–á€á¶ášá„á¶áš</th>
              <th>á…áŸ†á“á½á“ááŸ’á„áŸƒá’áŸ’áœá¾á…áŸá‰</th>
              <th>á…á¼á›á”áŸ’ášá’á¶á“á€á¶ášá·.</th>
              <th>á…á¼á›á¢á“á».á“á¶á™á€áŠáŸ’á‹á¶á“</th>
              <th>á…á¼á›á”áŸ’ášá’á¶á“á“á¶á™á€áŠáŸ’á‹á¶á“</th>
              <th>ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†á…áŸá‰á›á·áá·á</th>
              <th>á”á‰áŸ’á‡á·á€á¶</th>
              <th>á˜á¼á›á áŸáá»/á•áŸ’áŸáŸá„áŸ—</th>
              <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Form Modal -->
  <div id="myForm">
    <div class="form-header">
      <h2>á”á‰áŸ’á…á¼á›á¯á€áŸá¶áš</h2>
    </div>
    <div class="form-content">
      <form id="contactForm" class="styled-form">
        <div class="form-grid">
          <!-- Row 1 -->
          <div class="form-group">
            <label>á›áŸáá…á¼á› *</label>
            <input type="text" name="no" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá…á¼á›" required>
          </div>

          <div class="form-group">
            <label>á›áŸáá›á·áá·á(IR) *</label>
            <input type="text" name="ir" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá›á·áá·á" required>
          </div>

          <!-- Row 2 -->
          <div class="form-group">
            <label>á›áŸáá…áŸá‰</label>
            <input type="text" name="outNo" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá…áŸá‰">
          </div>

          <div class="form-group">
            <label>ááŸ’á„áŸƒááŸ‚á›á·áá·áá…á¼á›/á…áŸá‰</label>
            <input type="date" name="submitDate">
          </div>

          <!-- Row 3 -->
          <div class="form-group full-width">
            <label>á¢á„áŸ’á‚á—á¶á–/á”áŸ’ášá—á–á›á·áá·á</label>
            <input type="text" name="source" placeholder="á”á‰áŸ’á…á¼á›á¢á„áŸ’á‚á—á¶á–">
          </div>

          <!-- Row 4 -->
          <div class="form-group">
            <label>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</label>
            <input type="text" name="doc" placeholder="á§á‘á¶á ášááŸ: á›á·áá·áá‡á¶á•áŸ’á›á¼áœá€á¶áš">
          </div>

          <div class="form-group">
            <label>ááŸ’á„áŸƒááŸ‚á˜á»áá€á¶ášá·.áŸ¢</label>
            <input type="date" name="officeDate2">
          </div>

          <!-- Row 5 -->
          <div class="form-group">
            <label>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›á˜á»áá€á¶áš</label>
            <input type="text" name="officer" placeholder="áˆáŸ’á˜áŸ„áŸ‡á˜á“áŸ’ášáŸ’áá¸">
          </div>

          <div class="form-group">
            <label>ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†á‘á‘á½á›</label>
            <input type="date" name="receiveDate">
          </div>

          <!-- Row 6 -->
          <div class="form-group">
            <label>áŸáŸ’áá¶á“á—á¶á–á€á¶ášá„á¶áš</label>
            <select name="progress">
              <option value="">á‡áŸ’ášá¾áŸášá¾áŸáŸáŸ’áá¶á“á—á¶á–</option>
              <option value="á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰">á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰</option>
              <option value="á”á¶á“á’áŸ’áœá¾á…áŸá‰">á”á¶á“á’áŸ’áœá¾á…áŸá‰</option>
            </select>
          </div>

          <div class="form-group">
            <label>á…áŸ†á“á½á“ááŸ’á„áŸƒá’áŸ’áœá¾á…áŸá‰</label>
            <input type="number" name="duration" placeholder="á…áŸ†á“á½á“ááŸ’á„áŸƒ">
          </div>

          <!-- Row 7 -->
          <div class="form-group">
            <label>á…á¼á›á”áŸ’ášá’á¶á“á€á¶ášá·.</label>
            <input type="text" name="toChiefOffice" placeholder="á§á‘á¶á ášááŸ: 01-11-2025">
          </div>

          <div class="form-group">
            <label>á…á¼á›á¢á“á».á“á¶á™á€áŠáŸ’á‹á¶á“</label>
            <input type="text" name="toDeputy" placeholder="á§á‘á¶á ášááŸ: 02-11-2025">
          </div>

          <!-- Row 8 -->
          <div class="form-group">
            <label>á…á¼á›á”áŸ’ášá’á¶á“á“á¶á™á€áŠáŸ’á‹á¶á“</label>
            <input type="text" name="toHeadDept" placeholder="á§á‘á¶á ášááŸ: 03-11-2025">
          </div>

          <div class="form-group">
            <label>ááŸ’á„áŸƒááŸ‚á†áŸ’á“á¶áŸ†á…áŸá‰á›á·áá·á</label>
            <input type="date" name="outDate">
          </div>

          <!-- Row 9 -->
          <div class="form-group">
            <label>á”á‰áŸ’á‡á·á€á¶</label>
            <select name="registryStatus">
              <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
              <option value="á…áŸá‰á”á‰áŸ’á‡á·á€á¶">á…áŸá‰á”á‰áŸ’á‡á·á€á¶</option>
              <option value="á˜á·á“á‘á¶á“áŸ‹á…áŸá‰á”á‰áŸ’á‡á·á€á¶">á˜á·á“á‘á¶á“áŸ‹á…áŸá‰á”á‰áŸ’á‡á·á€á¶</option>
            </select>
          </div>

          <!-- Row 10 -->
          <div class="form-group full-width">
            <label>á˜á¼á›á áŸáá»/á•áŸ’áŸáŸá„áŸ—</label>
            <textarea name="reason" placeholder="á”á‰áŸ’á…á¼á›á˜á¼á›á áŸáá»" rows="3"></textarea>
          </div>
        </div>

        <div class="form-buttons">
          <button type="submit" class="btn-submit">ášá€áŸ’áŸá¶á‘á»á€</button>
          <button type="button" id="closeForm" class="btn-close">á”á·á‘</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modern View Popup -->
  <div id="viewPopup" class="popup">
    <div class="popup-content">
      <div class="popup-header">
        <h2>ğŸ“„ á–áŸááŸŒá˜á¶á“á¯á€áŸá¶áš</h2>
        <button class="close" onclick="closeView()">&times;</button>
      </div>
      <div class="popup-body">
        <div class="document-summary">
          <div class="greeting">á‚áŸ„ášá–ášá¶á™á€á¶ášááŸá›áŸ„á€á”áŸ’ášá’á¶á“!</div>
          <div class="document-info">
            <div class="info-line">- á¯á€áŸá¶ášáŸ– <span id="vDocType">-</span> á…á¼á›ááŸ’á„áŸƒá‘á¸ <span id="vSubmitDate">-</span></div>
            <div class="info-line">- á›áŸáá›á·áá·ááŸ– <span id="vIrNo">-</span> á…áŸá‰ááŸ’á„áŸƒá‘á¸ <span id="vOutDate">-</span></div>
            <div class="info-line">- á”áŸ’ášá—á–á›á·áá·ááŸ– <span id="vDocSource">-</span></div>
            <div class="info-line">- á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›á˜á»áá€á¶ášáŸ– <span id="vDocOfficer">-</span> á‘á‘á½á›ááŸ’á„áŸƒá‘á¸ <span id="vReceiveDate">-</span></div>
          </div>
          <div class="status-info">
            <strong>áŸáŸ’áá¶á“á—á¶á–á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á‚áºá“áŸ… <span id="vCurrentStatus">-</span></strong>
          </div>
          <div class="additional-info">
            <div class="info-line">- á…áŸ†á“á½á“ááŸ’á„áŸƒá’áŸ’áœá¾á…áŸá‰áŸ– <span id="vDuration">-</span> ááŸ’á„áŸƒ</div>
            <div class="info-line">- á”á‰áŸ’á‡á·á€á¶áŸ– <span id="vRegistry">-</span></div>
            <div class="info-line">- á˜á¼á›á áŸáá»/á•áŸ’áŸáŸá„áŸ—áŸ– <span id="vDocReason">-</span></div>
          </div>
          <div class="closing">áŸá¼á˜á¢ášá‚á»ááŸ—</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load navbar
    fetch('navbar.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('navbar').innerHTML = data;

        // Highlight current page
        const currentPage = window.location.pathname.split("/").pop();
        const links = document.querySelectorAll(".navbar-links a");

        links.forEach(link => {
          if (link.getAttribute("href") === currentPage) {
            link.classList.add("active");
          }
        });
      })
      
      .catch(error => console.error('Error loading navbar:', error));

    const API_URL = "https://uat-api-office2.thithabirdnest.com/doc";
    const form = document.getElementById("contactForm");
    const tableBody = document.getElementById("tableBody");
    const formModal = document.getElementById("myForm");
    const overlay = document.getElementById("overlay");
    const openBtn = document.getElementById("openForm");
    const closeBtn = document.getElementById("closeForm");
    const searchInput = document.getElementById("searchBox");
    const showCountSelect = document.getElementById("showCount");
    let editingId = null;
    let allDocs = [];
    let currentFilteredDocs = [];

    // === Open / Close Form ===
    openBtn.onclick = () => {
      formModal.style.display = 'block';
      overlay.style.display = 'block';
      form.reset();
      editingId = null;
    };
    
    closeBtn.onclick = () => {
      formModal.style.display = 'none';
      overlay.style.display = 'none';
    };
    
    overlay.onclick = () => {
      formModal.style.display = 'none';
      overlay.style.display = 'none';
    };

    // === Fetch Documents ===
    async function fetchDocument() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        allDocs = data.date || [];

        // Sort newest first
        allDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        currentFilteredDocs = [...allDocs];
        renderTable(currentFilteredDocs);
        updateRowCount();
      } catch (error) {
        console.error("Fetch Error:", error);
      }
    }

    // === Render Table with Row Limit ===
    function renderTable(docs) {
      tableBody.innerHTML = "";
      
      // Get the selected row count
      const selectedValue = showCountSelect.value;
      let displayDocs = docs;
      
      if (selectedValue !== "all") {
        const rowCount = parseInt(selectedValue);
        displayDocs = docs.slice(0, rowCount);
      }
      
      if (displayDocs.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="18" style="text-align: center; padding: 20px; color: #666;">á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™</td>`;
        tableBody.appendChild(row);
        return;
      }

      displayDocs.forEach((doc, index) => {
        const row = document.createElement("tr");

        // Create a safe ID that won't break the HTML
        const safeId = `doc-${index}`;
        
        // Store the document in a global array for view function access
        if (!window.documentsMap) window.documentsMap = {};
        window.documentsMap[safeId] = doc;

        row.innerHTML = `
          <td>${doc.no || ""}</td>
          <td>${doc.ir || ""}</td>
          <td>${doc.outNo || ""}</td>
          <td>${doc.submitDate?.split("T")[0] || ""}</td>
          <td>${doc.source || ""}</td>
          <td>${doc.doc || ""}</td>
          <td>${doc.officeDate2 || ""}</td>
          <td>${doc.officer || "-"}</td>
          <td>${doc.receiveDate || ""}</td>
          <td>${doc.progress || ""}</td>
          <td>${doc.duration || ""}</td>
          <td>${doc.toChiefOffice || ""}</td>
          <td>${doc.toDeputy || ""}</td>
          <td>${doc.toHeadDept || ""}</td>
          <td>${doc.outDate || ""}</td>
          <td>${doc.registryStatus || ""}</td>
          <td>${doc.reason || ""}</td>

          <td>
            <button data-doc-id="${safeId}" class="viewBtn">View</button>
            <button class="editBtn">Edit</button>
            <button class="deleteBtn">Delete</button>
          </td>
        `;

        // View - use event delegation instead of inline onclick
        row.querySelector(".viewBtn").onclick = () => viewDocument(safeId);
        // Edit - pass the actual doc object
        row.querySelector(".editBtn").onclick = () => openEditForm(doc);
        // Delete - use the safeId
        row.querySelector(".deleteBtn").onclick = () => deleteDoc(safeId);

        tableBody.appendChild(row);
      });
      
      updateRowCount();
    }

    // === Update Row Count Display ===
    function updateRowCount() {
      const selectedValue = showCountSelect.value;
      const totalDocs = currentFilteredDocs.length;
      let showingDocs = totalDocs;
      
      if (selectedValue !== "all") {
        showingDocs = Math.min(totalDocs, parseInt(selectedValue));
      }
      
      // Update the label to show current count
      const countLabel = document.querySelector('.filter-section label');
      if (countLabel) {
        countLabel.textContent = `á”á„áŸ’á á¶á‰: ${showingDocs}/${totalDocs}`;
      }
    }

    // === Enhanced View Function ===
    function viewDocument(safeId) {
      console.log('Viewing document with safe ID:', safeId);
      
      // Get the document from our global map
      const doc = window.documentsMap ? window.documentsMap[safeId] : null;
      
      if (doc) {
        console.log('Found document:', doc);
        
        // Format dates for display in Khmer format
        const formatDate = (dateString) => {
          if (!dateString) return '-';
          try {
            const date = new Date(dateString);
            // Convert to Khmer numerals and format
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            
            // Convert numbers to Khmer numerals
            const khmerNumerals = ['áŸ ', 'áŸ¡', 'áŸ¢', 'áŸ£', 'áŸ¤', 'áŸ¥', 'áŸ¦', 'áŸ§', 'áŸ¨', 'áŸ©'];
            const toKhmerNum = (num) => {
              return num.toString().split('').map(digit => khmerNumerals[parseInt(digit)]).join('');
            };
            
            return `${toKhmerNum(day)}/${toKhmerNum(month)}/${toKhmerNum(year)}`;
          } catch (e) {
            return '-';
          }
        };

        // Set the values in the formal format
        document.getElementById('vDocType').textContent = doc.doc || '-';
        document.getElementById('vSubmitDate').textContent = formatDate(doc.submitDate);
        document.getElementById('vIrNo').textContent = doc.ir || '-';
        document.getElementById('vOutDate').textContent = formatDate(doc.outDate);
        document.getElementById('vDocSource').textContent = doc.source || '-';
        document.getElementById('vDocOfficer').textContent = doc.officer || '-';
        document.getElementById('vReceiveDate').textContent = formatDate(doc.receiveDate);
        document.getElementById('vCurrentStatus').textContent = doc.progress || '-';
        document.getElementById('vDuration').textContent = doc.duration ? doc.duration + ' ááŸ’á„áŸƒ' : '-';
        document.getElementById('vRegistry').textContent = doc.registryStatus || '-';
        document.getElementById('vDocReason').textContent = doc.reason || '-';

        document.getElementById('viewPopup').style.display = 'flex';
      } else {
        console.error('Document not found with safe ID:', safeId);
        alert('á˜á·á“á¢á¶á…ášá€áƒá¾á‰á¯á€áŸá¶áš!');
      }
    }

    function closeView() {
      document.getElementById('viewPopup').style.display = 'none';
    }

    // === Event Listeners ===
    
    // Show count selection
    showCountSelect.addEventListener("change", () => {
      renderTable(currentFilteredDocs);
    });

    // Search functionality
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();

      currentFilteredDocs = allDocs.filter((d) =>
        [
          d.no,
          d.ir,
          d.outNo,
          d.submitDate,
          d.source,
          d.doc,
          d.officeDate2,
          d.officer,
          d.receiveDate,
          d.progress,
          d.duration,
          d.toChiefOffice,
          d.toDeputy,
          d.toHeadDept,
          d.outDate,
          d.registryStatus,
          d.reason,
        ].some(v => v?.toString().toLowerCase().includes(q))
      );

      renderTable(currentFilteredDocs);
    });

    // Add scroll indicators for table
    function updateScrollIndicators() {
      const tableWrapper = document.querySelector('.table-wrapper');
      const tableContainer = document.querySelector('.table-container');
      
      if (tableWrapper && tableContainer) {
        if (tableWrapper.scrollLeft > 0) {
          tableContainer.classList.add('scroll-left');
        } else {
          tableContainer.classList.remove('scroll-left');
        }
        
        if (tableWrapper.scrollLeft + tableWrapper.clientWidth < tableWrapper.scrollWidth) {
          tableContainer.classList.add('scroll-right');
        } else {
          tableContainer.classList.remove('scroll-right');
        }
      }
    }

    // Initialize scroll indicators
    document.addEventListener('DOMContentLoaded', function() {
      const tableWrapper = document.querySelector('.table-wrapper');
      if (tableWrapper) {
        tableWrapper.addEventListener('scroll', updateScrollIndicators);
        window.addEventListener('resize', updateScrollIndicators);
        updateScrollIndicators(); // Initial check
      }
    });

    // === Submit Form ===
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form));
      const method = editingId ? "PUT" : "POST";
      const url = editingId ? `${API_URL}/${editingId}` : API_URL;

      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });
        if (res.ok) {
          alert(editingId ? "á”á¶á“á€áŸ‚á”áŸ’ášáŸ‚á¯á€áŸá¶áš!" : "á”á¶á“ášá€áŸ’áŸá¶á‘á»á€á¯á€áŸá¶ášááŸ’á˜á¸!");
          formModal.style.display = 'none';
          overlay.style.display = 'none';

          // If new, add it to top
          const result = await res.json();
          if (!editingId) {
            allDocs.unshift(result.doc); // Add new doc to the beginning
          } else {
            // Update existing doc in list
            const index = allDocs.findIndex(d => d.id === editingId);
            if (index !== -1) allDocs[index] = result.doc;
          }

          // Update filtered docs and re-render
          currentFilteredDocs = [...allDocs];
          renderTable(currentFilteredDocs);
        } else {
          alert("á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á¯á€áŸá¶áš!");
        }
      } catch (err) {
        console.error("Save Error:", err);
      }
    });

    // === Edit ===
    function openEditForm(doc) {
      editingId = doc.id;
      formModal.style.display = 'block';
      overlay.style.display = 'block';
      Object.keys(form.elements).forEach((key) => {
        if (form.elements[key]?.name) {
          form.elements[key].value = doc[form.elements[key].name] || "";
        }
      });
    }

    // === Delete ===
    async function deleteDoc(safeId) {
      if (!confirm("áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á¯á€áŸá¶ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?")) return;
      try {
        const doc = window.documentsMap ? window.documentsMap[safeId] : null;
        if (doc && doc.id) {
          const res = await fetch(`${API_URL}/${doc.id}`, { method: "DELETE" });
          const data = await res.json();
          alert(data.message);
          allDocs = allDocs.filter(d => d.id !== doc.id);
          currentFilteredDocs = currentFilteredDocs.filter(d => d.id !== doc.id);
          renderTable(currentFilteredDocs);
        } else {
          alert("á˜á·á“á¢á¶á…á›á»á”á¯á€áŸá¶ášá“áŸáŸ‡á”á¶á“!");
        }
      } catch (err) {
        console.error("Delete Error:", err);
      }
    }

    // === Export to Excel ===
    document.getElementById("exportExcelBtn").onclick = () => {
      const ws = XLSX.utils.json_to_sheet(allDocs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Documents");
      XLSX.writeFile(wb, "documents.xlsx");
    };

    window.addEventListener("DOMContentLoaded", fetchDocument);
  </script>
</body>
</html>