<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document & Factory Management System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
      background-color: #f8f9fa; 
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    /* --- Sidebar (Navbar) --- */
    .sidebar { 
      width: 260px; 
      min-width: 260px;
      background: #fff; 
      color: #2c3e50; 
      padding: 25px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.08);
      position: fixed;
      height: 100%;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
      border-right: 1px solid #e1e5e9;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }
    
    .navbar-header { 
      padding: 0 25px 25px 25px;
      border-bottom: 1px solid #e1e5e9;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand { 
      font-size: 1.4rem; 
      font-weight: 600; 
      white-space: nowrap;
      overflow: hidden;
      letter-spacing: 0.5px;
    }

    /* Hide Button - Inside Navbar */
    #hideSidebar {
        background: none;
        border: 1px solid #d1d9e6;
        color: #5d6d7e;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 101; 
        font-size: 0.85rem;
    }
    #hideSidebar:hover {
        background: #f8f9fa;
        border-color: #a6b1c2;
    }
    
    /* Show Button - When sidebar is hidden */
    #showSidebar {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        color: #2c3e50;
        border: 1px solid #d1d9e6;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 10000;
        font-size: 16px;
        display: none;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    #showSidebar:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .navbar-links { 
      display: flex; 
      flex-direction: column; 
      overflow: hidden;
    }
    .navbar-links a { 
      color: #5d6d7e; 
      text-decoration: none; 
      padding: 14px 25px; 
      transition: all 0.3s; 
      border-left: 4px solid transparent;
      white-space: nowrap;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-links a:hover { 
      background: #f8f9fa; 
      color: #2c3e50;
      border-left-color: #a6b1c2;
    }
    .navbar-links a.active { 
      background: #f0f3f7; 
      color: #2c3e50;
      border-left-color: #3498db;
      font-weight: 600;
    }
    
    /* --- Main Content Area --- */
    .main-container {
      flex-grow: 1;
      margin-left: 260px;
      padding: 25px;
      max-width: calc(100% - 260px);
      width: 100%;
      transition: margin-left 0.3s ease, max-width 0.3s ease;
    }

    .main-container.expanded {
      margin-left: 0;
      max-width: 100%;
    }
    
    .page-header { 
      background: #fff; 
      color: #2c3e50; 
      padding: 30px; 
      border-radius: 10px; 
      margin-bottom: 25px; 
      text-align: center;
      position: sticky; 
      top: 0; 
      z-index: 50; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    .page-header h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .page-header p {
      color: #7b8a9b;
      font-size: 1.1rem;
    }
    
    .control-section { 
      background: #fff; 
      padding: 25px; 
      border-radius: 10px; 
      margin-bottom: 25px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-wrap: wrap; 
      gap: 15px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    /* Buttons */
    .btn { 
      padding: 10px 20px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s; 
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      color: #2c3e50;
      letter-spacing: 0.3px;
    }
    .btn:hover { 
      background: #f8f9fa; 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      border-color: #a6b1c2;
    }
    .btn-primary {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    .btn-primary:hover {
      background: #2980b9;
      border-color: #2980b9;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }
    
    /* Action buttons container */
    .action-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    /* Tables */
    .table-container { 
      background: #fff; 
      border-radius: 10px; 
      overflow: hidden; 
      margin-bottom: 25px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    .table-wrapper { 
      overflow-x: auto; 
      max-height: 70vh; 
      overflow-y: auto; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1200px; 
    }
    th, td { 
      padding: 14px 16px; 
      text-align: left; 
      border-bottom: 1px solid #e1e5e9; 
    }
    th { 
      background: #f8f9fa; 
      color: #2c3e50; 
      position: sticky; 
      top: 0; 
      font-weight: 600;
      border-bottom: 2px solid #e1e5e9;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
    }
    tr:hover { 
      background-color: #f8f9fa; 
    }
    
    /* Forms & Modals */
    .modal { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        z-index: 1000; 
        justify-content: center; 
        align-items: center; 
        padding: 20px;
        backdrop-filter: blur(4px);
    }
    .modal-content { 
        background: white; 
        border-radius: 12px; 
        max-width: 800px; 
        width: 95%; 
        max-height: 90vh; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid #e1e5e9;
        animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal-header { 
        background: #f8f9fa; 
        color: #2c3e50; 
        padding: 25px; 
        border-bottom: 1px solid #e1e5e9;
    }
    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    .modal-body { 
        padding: 25px; 
        max-height: calc(90vh - 120px); 
        overflow-y: auto; 
    }
    .form-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px; 
        margin-bottom: 20px; 
    }
    .form-group { 
        margin-bottom: 8px; 
    }
    .form-group.full-width { 
        grid-column: 1 / -1; 
    }
    .form-group label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600; 
        color: #5d6d7e;
        font-size: 0.95rem;
    }
    .form-group input, .form-group select, .form-group textarea { 
        width: 100%; 
        padding: 12px 14px; 
        border: 1px solid #d1d9e6; 
        border-radius: 8px; 
        background: #fff;
        color: #2c3e50;
        font-size: 0.95rem;
        transition: all 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .form-buttons { 
        display: flex; 
        gap: 12px; 
        justify-content: flex-end; 
        margin-top: 25px; 
        padding-top: 25px;
        border-top: 1px solid #e1e5e9;
    }
    
    /* Compact Import Section */
    .import-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .import-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .import-header h3 {
      color: #2c3e50;
      font-size: 1.1rem;
      margin: 0;
    }
    
    .import-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .file-input {
      display: none;
    }
    
    .file-info {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      font-size: 0.9rem;
    }
    
    .file-info.hidden {
      display: none;
    }
    
    /* Detail View Styling */
    .detail-view p { 
        margin-bottom: 14px; 
        line-height: 1.7; 
        border-bottom: 1px dashed #e1e5e9;
        padding-bottom: 10px;
        display: flex;
    }
    .detail-view strong { 
        display: inline-block; 
        width: 180px;
        color: #5d6d7e; 
        font-weight: 600;
    }
    .detail-view span {
        color: #2c3e50;
        flex: 1;
    }
    
    .search-box { 
      padding: 12px 16px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      min-width: 220px; 
      background: #fff;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .search-box:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .count-select { 
      padding: 12px 16px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      background: #fff;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .count-select:focus {
        outline: none;
        border-color: #3498db;
    }

    .menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: #fff;
      color: #2c3e50;
      border: 1px solid #d1d9e6;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    .menu-toggle:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Status badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b8e0e6;
    }

    /* Role badges */
    .role-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .role-badge-admin {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid rgba(231, 76, 60, 0.3);
    }
    .role-badge-officer {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }

    /* Inspection Management Styles */
    .inspection-tabs {
      display: flex;
      background: #fff;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
      overflow: hidden;
    }
    
    .inspection-tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .inspection-tab.active {
      background: #f8f9fa;
      border-bottom-color: #3498db;
      font-weight: 600;
      color: #3498db;
    }
    
    .inspection-tab:hover {
      background: #f8f9fa;
    }
    
    .inspection-content {
      display: none;
    }
    
    .inspection-content.active {
      display: block;
    }

    .penalty-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .penalty-section h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 1.1rem;
    }
    
    .penalty-options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .penalty-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 2px solid #d1d9e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .penalty-option.selected {
      background: #3498db;
      border-color: #3498db;
      color: white;
    }
    
    .penalty-option input {
      margin: 0;
    }
    
    .penalty-details {
      display: none;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #e1e5e9;
    }
    
    .penalty-details.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
    }
    
    .detail-item label {
      font-weight: 600;
      color: #5d6d7e;
      margin-bottom: 8px;
      font-size: 0.9rem;
    }
    
    .detail-item input, .detail-item textarea {
      padding: 12px;
      border: 1px solid #d1d9e6;
      border-radius: 6px;
      font-size: 0.95rem;
      transition: all 0.3s;
      background: white;
    }
    
    .detail-item input:focus, .detail-item textarea:focus {
      outline: none;
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    
    .detail-item textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .followup-info {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #2ecc71;
    }
    
    .address-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }
    
    .address-item {
      display: flex;
      flex-direction: column;
    }
    
    .address-item.full-width {
      grid-column: 1 / -1;
    }
    
    .compact-form-group {
      margin-bottom: 12px;
    }
    
    .compact-form-group label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      color: #5d6d7e;
      font-size: 0.9rem;
    }
    
    .compact-form-group input, .compact-form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d9e6;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.3s;
    }
    
    .company-info-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #e1e5e9;
    }
    
    .company-info-section h4 {
      color: #2c3e50;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }
    
    .company-info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* --- Responsive Styles --- */
    @media (max-width: 900px) {
      body {
        display: block;
      }

      .menu-toggle {
        display: block;
      }
      
      .sidebar {
        width: 280px;
        transform: translateX(-280px); 
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar.hidden { 
          width: 280px;
          min-width: 280px;
          transform: translateX(-280px);
          padding: 25px 0;
      }

      .main-container {
        margin-left: 0;
        padding-top: 70px;
        max-width: 100%;
      }

      .control-section { 
        flex-direction: column; 
        align-items: stretch; 
      }
      .form-grid { 
        grid-template-columns: 1fr; 
      }
      .form-buttons { 
        flex-direction: column; 
        justify-content: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 5px;
        justify-content: center;
      }
      
      #showSidebar {
        display: block !important;
      }
      
      .page-header {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 1.6rem;
      }
      
      .import-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .import-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .inspection-tabs {
        flex-direction: column;
      }
      
      .company-info-grid {
        grid-template-columns: 1fr;
      }
      
      .address-grid {
        grid-template-columns: 1fr;
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
      
      .penalty-options {
        flex-direction: column;
      }
      
      .penalty-option {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menuToggle">â˜° Menu</button>
  <button id="showSidebar">â˜° Show Menu</button>

  <nav class="sidebar" id="sidebar">
    <div class="navbar-header">
      <div class="navbar-brand">ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</div>
      <button id="hideSidebar" title="Hide Sidebar">â—€</button>
    </div>
    <div class="navbar-links">
      <a href="#" class="active" onclick="showSection('documents', event)">
        <span>ğŸ“„</span>
        <span>á¯á€áŸá¶áš</span>
      </a>
      <a href="#" onclick="showSection('inspectionmanagement', event)">
        <span>ğŸ”</span>
        <span>á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢á’á·á€á¶ášá€á·á…áŸ’á…</span>
      </a>
      <a href="#" onclick="showSection('factories', event)">
        <span>ğŸ­</span>
        <span>ášáŸ„á„á…á€áŸ’áš</span>
      </a>
      <a href="#" onclick="showSection('users', event)">
        <span>ğŸ‘¥</span>
        <span>á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</span>
      </a>
    </div>
  </nav>

  <div class="main-container" id="mainContainer"> 
    
    <!-- Documents Section -->
    <section id="documents-section">
      <header class="page-header">
        <h1>ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¯á€áŸá¶áš</h1>
        <p>Document Management System</p>
      </header>

      <div class="control-section">
        <button class="btn" id="openDocForm">
          <span>â•</span>
          <span>á”á‰áŸ’á…á¼á›á¯á€áŸá¶ášááŸ’á˜á¸</span>
        </button>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <select class="count-select" id="showCount">
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="100">100</option>
            <option value="all">All</option>
          </select>
          <input type="search" class="search-box" id="docSearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€á¯á€áŸá¶áš...">
          <button class="btn" id="exportDocExcel">
            <span>ğŸ“¥</span>
            <span>á‘á¶á‰á™á€ Excel</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table id="documentTable">
            <thead>
              <tr>
                <th>á›áŸáá…á¼á›</th>
                <th>á›áŸáá›á·áá·á (IR)</th>
                <th>á›áŸáá…áŸá‰</th>
                <th>ááŸ’á„áŸƒááŸ‚á›á·áá·á</th>
                <th>á¢á„áŸ’á‚á—á¶á–</th>
                <th>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</th>
                <th>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</th>
                <th>áŸáŸ’áá¶á“á—á¶á–</th>
                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
              </tr>
            </thead>
            <tbody id="docTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Inspection Management Section -->
    <section id="inspectionmanagement-section" style="display: none;">
      <header class="page-header">
        <h1>ğŸ” á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢á’á·á€á¶ášá€á·á…áŸ’á…</h1>
        <p>Inspection Management System</p>
      </header>

      <!-- Inspection Tabs -->
      <div class="inspection-tabs">
        <div class="inspection-tab active" onclick="showInspectionTab('initial')">
          <span>ğŸ“‹</span>
          <span>á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠáŸ†á”á¼á„</span>
        </div>
        <div class="inspection-tab" onclick="showInspectionTab('followup')">
          <span>ğŸ”„</span>
          <span>áá¶á˜áŠá¶á“á€áŸ†á á·á</span>
        </div>
      </div>

      <!-- Initial Inspection Tab -->
      <div class="inspection-content active" id="initial-inspection">
        <div class="control-section">
          <button class="btn" id="openInspectionForm">
            <span>â•</span>
            <span>á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™ááŸ’á˜á¸</span>
          </button>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <input type="search" class="search-box" id="inspectionSearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™...">
            <button class="btn" id="exportInspectionExcel">
              <span>ğŸ“¥</span>
              <span>á‘á¶á‰á™á€ Excel</span>
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table id="inspectionTable">
              <thead>
                <tr>
                  <th>á›áŸáá…á¼á›</th>
                  <th>ášáŸ„á„á…á€áŸ’áš</th>
                  <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘</th>
                  <th>á€áŸ†á á·á</th>
                  <th>á•á¶á€</th>
                  <th>áŸáŸ’áá¶á“á—á¶á–</th>
                  <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
                </tr>
              </thead>
              <tbody id="inspectionTableBody">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Follow-up Inspection Tab -->
      <div class="inspection-content" id="followup-inspection">
        <div class="control-section">
          <button class="btn" id="openFollowupForm">
            <span>â•</span>
            <span>áá¶á˜áŠá¶á“á€áŸ†á á·áááŸ’á˜á¸</span>
          </button>
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <input type="search" class="search-box" id="followupSearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€á€á¶ášáá¶á˜áŠá¶á“...">
            <button class="btn" id="exportFollowupExcel">
              <span>ğŸ“¥</span>
              <span>á‘á¶á‰á™á€ Excel</span>
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table id="followupTable">
              <thead>
                <tr>
                  <th>á›áŸáá…á¼á›</th>
                  <th>ášáŸ„á„á…á€áŸ’áš</th>
                  <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘áá¶á˜áŠá¶á“</th>
                  <th>á€á¶á›á”ášá·á…áŸ’á†áŸá‘á€áŸ†á á·ááŠá¾á˜</th>
                  <th>áŸáŸ’áá¶á“á—á¶á–áá¶á˜áŠá¶á“</th>
                  <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
                </tr>
              </thead>
              <tbody id="followupTableBody">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Factories Section -->
    <section id="factories-section" style="display: none;">
      <header class="page-header">
        <h1>ğŸ­ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ášáŸ„á„á…á€áŸ’áš</h1>
        <p>Factory Management System</p>
      </header>

      <!-- Compact Import Section -->
      <div class="import-section">
        <div class="import-header">
          <h3>ğŸ“¤ á“á¶áŸ†á…á¼á›á‘á·á“áŸ’á“á“áŸá™ášáŸ„á„á…á€áŸ’áš</h3>
          <div class="import-controls">
            <button class="btn btn-sm" id="selectFileBtn">
              <span>ğŸ“‚</span>
              <span>á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš</span>
            </button>
            <button class="btn btn-sm" id="downloadTemplateBtn">
              <span>ğŸ“¥</span>
              <span>á‘á¶á‰á™á€á‚áŸ†ášá¼</span>
            </button>
            <button class="btn btn-sm btn-primary" id="importBtn" disabled>
              <span>ğŸ“¤</span>
              <span>á“á¶áŸ†á…á¼á›</span>
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
        <div class="file-info hidden" id="fileInfo">
          <strong>á¯á€áŸá¶áš:</strong> <span id="fileName">-</span> | 
          <strong>á‘áŸ†á áŸ†:</strong> <span id="fileSize">-</span>
        </div>
      </div>

      <div class="control-section">
        <button class="btn" id="openFactoryForm">
          <span>â•</span>
          <span>á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸</span>
        </button>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <input type="search" class="search-box" id="factorySearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€ášáŸ„á„á…á€áŸ’áš...">
          <button class="btn" id="exportFactoryExcel">
            <span>ğŸ“¥</span>
            <span>á‘á¶á‰á™á€ Excel</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table id="factoryTable">
            <thead>
              <tr>
                <th>á›áŸáá…á¼á›</th>
                <th>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš</th>
                <th>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN)</th>
                <th>Sector</th>
                <th>á—á¼á˜á·</th>
                <th>áƒá»áŸ†</th>
                <th>áŸáŸ’ášá»á€</th>
                <th>ááŸááŸ’á</th>
                <th>á€á˜áŸ’á˜á€ášáŸášá»á”</th>
                <th>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸</th>
                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
              </tr>
            </thead>
            <tbody id="factoryTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Users Section -->
    <section id="users-section" style="display: none;">
      <header class="page-header">
        <h1>ğŸ‘¥ á€á¶ášá‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</h1>
        <p>User Management System</p>
      </header>

      <div class="control-section">
        <button class="btn" id="openUserForm">
          <span>â•</span>
          <span>á”á‰áŸ’á…á¼á›á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ááŸ’á˜á¸</span>
        </button>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <input type="search" class="search-box" id="userSearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹...">
          <button class="btn" id="exportUserExcel">
            <span>ğŸ“¥</span>
            <span>á‘á¶á‰á™á€ Excel</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table id="userTable">
            <thead>
              <tr>
                <th>áˆáŸ’á˜áŸ„áŸ‡</th>
                <th>á‘á¼ášáŸáŸá–áŸ’á‘</th>
                <th>á¢áŸŠá¸á˜áŸ‚á›</th>
                <th>áá½á“á¶á‘á¸</th>
                <th>á˜á»áá„á¶áš</th>
                <th>áŸá„áŸ’á€á¶ááŸ‹</th>
                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Document Modal (Used for both New and Edit) -->
  <div class="modal" id="docModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="docModalTitle">á”á‰áŸ’á…á¼á›á¯á€áŸá¶ášááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="docForm">
          <div class="form-grid">
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá›á·áá·á(IR) *</label>
              <input type="text" name="ir" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá…áŸá‰</label>
              <input type="text" name="outNo">
            </div>
            <div class="form-group">
              <label>ááŸ’á„áŸƒááŸ‚á›á·áá·á</label>
              <input type="date" name="submitDate">
            </div>
            <div class="form-group full-width">
              <label>á¢á„áŸ’á‚á—á¶á–/á”áŸ’ášá—á–á›á·áá·á</label>
              <input type="text" name="source">
            </div>
            <div class="form-group">
              <label>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</label>
              <input type="text" name="doc">
            </div>
            <div class="form-group">
              <label>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</label>
              <input type="text" name="officer">
            </div>
            <div class="form-group">
              <label>áŸáŸ’áá¶á“á—á¶á–</label>
              <select name="progress">
                <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
                <option value="á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰">á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰</option>
                <option value="á”á¶á“á’áŸ’áœá¾á…áŸá‰">á”á¶á“á’áŸ’áœá¾á…áŸá‰</option>
              </select>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="docSubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('docModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Factory Modal (Used for both New and Edit) -->
  <div class="modal" id="factoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="factoryModalTitle">á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="factoryForm">
          <div class="form-grid">
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš *</label>
              <input type="text" name="factoryname" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN) *</label>
              <input type="text" name="factoryname_en" required>
            </div>
            <div class="form-group">
              <label>Sector *</label>
              <input type="text" name="sector" required>
            </div>
            <div class="form-group">
              <label>á—á¼á˜á· *</label>
              <input type="text" name="village" required>
            </div>
            <div class="form-group">
              <label>áƒá»áŸ† *</label>
              <input type="text" name="commune" required>
            </div>
            <div class="form-group">
              <label>áŸáŸ’ášá»á€ *</label>
              <input type="text" name="district" required>
            </div>
            <div class="form-group">
              <label>ááŸááŸ’á *</label>
              <input type="text" name="province" required>
            </div>
            <div class="form-group">
              <label>á¢á¶áŸá™áŠáŸ’á‹á¶á“ *</label>
              <input type="text" name="address" required>
            </div>
            <div class="form-group">
              <label>á€á˜áŸ’á˜á€ášáŸášá»á” *</label>
              <input type="number" name="total_workers" required>
            </div>
            <div class="form-group">
              <label>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸ *</label>
              <input type="number" name="female_workers" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ *</label>
              <input type="text" name="admin_name" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘ *</label>
              <input type="text" name="admin_phone" required>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="factorySubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('factoryModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- User Modal (Used for both New and Edit) -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="userModalTitle">á”á‰áŸ’á…á¼á›á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <div class="form-grid">
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡ *</label>
              <input type="text" name="name" required>
            </div>
            <div class="form-group">
              <label>á‘á¼ášáŸáŸá–áŸ’á‘ *</label>
              <input type="text" name="phone" required>
            </div>
            <div class="form-group">
              <label>á¢áŸŠá¸á˜áŸ‚á› *</label>
              <input type="email" name="email" required>
            </div>
            <div class="form-group">
              <label>á–á¶á€áŸ’á™áŸá˜áŸ’á„á¶ááŸ‹ *</label>
              <input type="password" name="password" required>
            </div>
            <div class="form-group">
              <label>áá½á“á¶á‘á¸ *</label>
              <select name="role" required>
                <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸáá½á“á¶á‘á¸ --</option>
                <option value="admin">á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</option>
                <option value="officer">á˜á“áŸ’ááŸ’ášá¸</option>
              </select>
            </div>
            <div class="form-group">
              <label>á˜á»áá„á¶áš *</label>
              <input type="text" name="function" required>
            </div>
            <div class="form-group">
              <label>áŸá„áŸ’á€á¶ááŸ‹ *</label>
              <input type="text" name="sangkat" required>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="userSubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('userModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Inspection Management Modals -->
  <!-- Initial Inspection Modal -->
  <div class="modal" id="inspectionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="inspectionModalTitle">á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™ááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="inspectionForm">
          <div class="form-grid">
            <!-- Basic Information -->
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>á€áŸ’ášá»á˜ *</label>
              <select name="group" required>
                <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸá€áŸ’ášá»á˜ --</option>
                <option value="á€áŸ’ášá»á˜ á€">á€áŸ’ášá»á˜ á€</option>
                <option value="á€áŸ’ášá»á˜ á">á€áŸ’ášá»á˜ á</option>
                <option value="á€áŸ’ášá»á˜ á‚">á€áŸ’ášá»á˜ á‚</option>
              </select>
            </div>
            <div class="form-group">
              <label>á€á¶á›á”ášá·á…áŸ’á†áŸá‘ááŸ’ášá½áá–á·á“á·ááŸ’á™ *</label>
              <input type="date" name="inspection_date" required>
            </div>

            <!-- Company Information Section -->
            <div class="company-info-section full-width">
              <h4>á–áŸááŸŒá˜á¶á“ášáŸ„á„á…á€áŸ’áš</h4>
              <div class="company-info-grid">
                <div class="compact-form-group">
                  <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš *</label>
                  <select name="factory_name" required onchange="updateFactoryInfo()">
                    <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸášáŸ„á„á…á€áŸ’áš --</option>
                    <option value="ášáŸ„á„á…á€áŸ’áš á€" data-sector="áœá·áŸáŸá™ á€" data-village="á—á¼á˜á· á€" data-commune="áƒá»áŸ† á€" data-district="áŸáŸ’ášá»á€ á€" data-province="ááŸááŸ’á á€">ášáŸ„á„á…á€áŸ’áš á€</option>
                    <option value="ášáŸ„á„á…á€áŸ’áš á" data-sector="áœá·áŸáŸá™ á" data-village="á—á¼á˜á· á" data-commune="áƒá»áŸ† á" data-district="áŸáŸ’ášá»á€ á" data-province="ááŸááŸ’á á">ášáŸ„á„á…á€áŸ’áš á</option>
                    <option value="ášáŸ„á„á…á€áŸ’áš á‚" data-sector="áœá·áŸáŸá™ á‚" data-village="á—á¼á˜á· á‚" data-commune="áƒá»áŸ† á‚" data-district="áŸáŸ’ášá»á€ á‚" data-province="ááŸááŸ’á á‚">ášáŸ„á„á…á€áŸ’áš á‚</option>
                  </select>
                </div>
                
                <div class="compact-form-group">
                  <label>áœá·áŸáŸá™ *</label>
                  <input type="text" name="sector" required placeholder="á”á‰áŸ’á…á¼á›áœá·áŸáŸá™...">
                </div>
                
                <div class="compact-form-group">
                  <label>á”áŸ’ášá’á¶á“á”á‘ *</label>
                  <input type="text" name="case_subject" required placeholder="á”á‰áŸ’á…á¼á›á”áŸ’ášá’á¶á“á”á‘...">
                </div>
              </div>
              
              <!-- Address Fields -->
              <div class="address-grid" style="margin-top: 15px;">
                <div class="address-item">
                  <label>á—á¼á˜á· *</label>
                  <input type="text" name="village" required placeholder="á”á‰áŸ’á…á¼á›á—á¼á˜á·...">
                </div>
                <div class="address-item">
                  <label>áƒá»áŸ† *</label>
                  <input type="text" name="commune" required placeholder="á”á‰áŸ’á…á¼á›áƒá»áŸ†...">
                </div>
                <div class="address-item">
                  <label>áŸáŸ’ášá»á€ *</label>
                  <input type="text" name="district" required placeholder="á”á‰áŸ’á…á¼á›áŸáŸ’ášá»á€...">
                </div>
                <div class="address-item">
                  <label>ááŸááŸ’á *</label>
                  <input type="text" name="province" required placeholder="á”á‰áŸ’á…á¼á›ááŸááŸ’á...">
                </div>
              </div>
            </div>

            <!-- á€áŸ†á á·á Section -->
            <div class="penalty-section full-width">
              <h4>á€áŸ†á á·á (á¢áŸ’áœá¸áŠáŸ‚á›ášáŸ„á„á…á€áŸ’ášááŸ’ášá¼áœá€áŸ‚á›á˜áŸ’á¢)</h4>
              <div class="penalty-options">
                <label class="penalty-option" id="penalty_yes_option">
                  <input type="radio" name="has_penalty" value="á˜á¶á“" onchange="togglePenaltyDetails(true)">
                  <span>á˜á¶á“</span>
                </label>
                <label class="penalty-option" id="penalty_no_option">
                  <input type="radio" name="has_penalty" value="á‚áŸ’á˜á¶á“" onchange="togglePenaltyDetails(false)">
                  <span>á‚áŸ’á˜á¶á“</span>
                </label>
              </div>
              
              <div class="penalty-details" id="penalty_details">
                <div class="detail-grid">
                  <div class="detail-item">
                    <label>á”áŸ‚á”á”á‘</label>
                    <input type="text" name="penalty_format" placeholder="á”á‰áŸ’á…á¼á›á”áŸ‚á”á”á‘á€áŸ†á á·á...">
                  </div>
                  <div class="detail-item">
                    <label>á›á€áŸ’ááááŸ’áŒ</label>
                    <input type="text" name="penalty_condition" placeholder="á”á‰áŸ’á…á¼á›á›á€áŸ’ááááŸ’áŒá€áŸ†á á·á...">
                  </div>
                  <div class="detail-item">
                    <label>áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–</label>
                    <textarea name="penalty_health" placeholder="á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–..."></textarea>
                  </div>
                  <div class="detail-item">
                    <label>áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ</label>
                    <textarea name="penalty_professional" placeholder="á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- á•á¶á€ Section -->
            <div class="penalty-section full-width">
              <h4>á•á¶á€</h4>
              <div class="penalty-options">
                <label class="penalty-option" id="fine_yes_option">
                  <input type="radio" name="has_fine" value="á˜á¶á“" onchange="toggleFineDetails(true)">
                  <span>á˜á¶á“</span>
                </label>
                <label class="penalty-option" id="fine_no_option">
                  <input type="radio" name="has_fine" value="á‚áŸ’á˜á¶á“" onchange="toggleFineDetails(false)">
                  <span>á‚áŸ’á˜á¶á“</span>
                </label>
              </div>
              
              <div class="penalty-details" id="fine_details">
                <div class="detail-grid">
                  <div class="detail-item">
                    <label>á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹</label>
                    <input type="text" name="fine_amount" placeholder="á”á‰áŸ’á…á¼á›á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹...">
                  </div>
                  <div class="detail-item">
                    <label>á”áŸ’ášá—áŸá‘á•á¶á€</label>
                    <input type="text" name="fine_type" placeholder="á”á‰áŸ’á…á¼á›á”áŸ’ášá—áŸá‘á•á¶á€...">
                  </div>
                  <div class="detail-item full-width">
                    <label>á áŸáá»á•á›</label>
                    <textarea name="fine_reason" placeholder="á”á‰áŸ’á…á¼á›á áŸáá»á•á›á•á¶á€..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group full-width">
              <label>á•áŸ’áŸáŸá„áŸ—</label>
              <textarea name="remarks" rows="3" placeholder="á”á‰áŸ’á…á¼á›á•áŸ’áŸáŸá„áŸ—..."></textarea>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="inspectionSubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('inspectionModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Follow-up Inspection Modal -->
  <div class="modal" id="followupModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="followupModalTitle">áá¶á˜áŠá¶á“á€áŸ†á á·áááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="followupForm">
          <div class="form-grid">
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠá¾á˜ *</label>
              <select name="original_inspection" id="originalInspectionSelect" required onchange="loadOriginalInspectionData()">
                <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸá€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠá¾á˜ --</option>
              </select>
            </div>
            <div class="form-group">
              <label>á€á¶á›á”ášá·á…áŸ’á†áŸá‘áá¶á˜áŠá¶á“ *</label>
              <input type="date" name="followup_date" required>
            </div>
            
            <!-- Company Information Display (Read-only) -->
            <div class="company-info-section full-width" id="companyInfoDisplay" style="display: none;">
              <h4>á–áŸááŸŒá˜á¶á“ášáŸ„á„á…á€áŸ’áš</h4>
              <div class="company-info-grid">
                <div class="compact-form-group">
                  <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš</label>
                  <input type="text" id="display_factory_name" readonly style="background: #f8f9fa;">
                </div>
                <div class="compact-form-group">
                  <label>áœá·áŸáŸá™</label>
                  <input type="text" id="display_sector" readonly style="background: #f8f9fa;">
                </div>
                <div class="compact-form-group">
                  <label>á”áŸ’ášá’á¶á“á”á‘</label>
                  <input type="text" id="display_case_subject" readonly style="background: #f8f9fa;">
                </div>
              </div>
              
              <div class="address-grid" style="margin-top: 15px;">
                <div class="address-item">
                  <label>á—á¼á˜á·</label>
                  <input type="text" id="display_village" readonly style="background: #f8f9fa;">
                </div>
                <div class="address-item">
                  <label>áƒá»áŸ†</label>
                  <input type="text" id="display_commune" readonly style="background: #f8f9fa;">
                </div>
                <div class="address-item">
                  <label>áŸáŸ’ášá»á€</label>
                  <input type="text" id="display_district" readonly style="background: #f8f9fa;">
                </div>
                <div class="address-item">
                  <label>ááŸááŸ’á</label>
                  <input type="text" id="display_province" readonly style="background: #f8f9fa;">
                </div>
              </div>
            </div>

            <!-- Original Penalty Information (Read-only) -->
            <div id="originalPenaltyInfo" class="followup-info" style="display: none;">
              <h4>á€áŸ†á á·ááŠá¾á˜</h4>
              <div id="penaltyDisplay"></div>
            </div>

            <!-- Follow-up Result -->
            <div class="penalty-section full-width">
              <h4>á›á‘áŸ’á’á•á›áá¶á˜áŠá¶á“</h4>
              <div class="penalty-options">
                <label class="penalty-option" id="implemented_yes_option">
                  <input type="radio" name="penalty_implemented" value="á¢á“á»áœááŸ’á" onchange="toggleFollowupDetails(false)">
                  <span>á¢á“á»áœááŸ’á</span>
                </label>
                <label class="penalty-option" id="implemented_no_option">
                  <input type="radio" name="penalty_implemented" value="á˜á·á“á¢á“á»áœááŸ’á" onchange="toggleFollowupDetails(true)">
                  <span>á˜á·á“á¢á“á»áœááŸ’á</span>
                </label>
              </div>
              
              <div class="penalty-details" id="followup_details">
                <div class="detail-grid">
                  <div class="detail-item">
                    <label>á”áŸ‚á”á”á‘</label>
                    <input type="text" name="followup_format" placeholder="á”á‰áŸ’á…á¼á›á”áŸ‚á”á”á‘áá¶á˜áŠá¶á“...">
                  </div>
                  <div class="detail-item">
                    <label>á›á€áŸ’ááááŸ’áŒ</label>
                    <input type="text" name="followup_condition" placeholder="á”á‰áŸ’á…á¼á›á›á€áŸ’ááááŸ’áŒáá¶á˜áŠá¶á“...">
                  </div>
                  <div class="detail-item">
                    <label>áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–</label>
                    <textarea name="followup_health" placeholder="á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–áá¶á˜áŠá¶á“..."></textarea>
                  </div>
                  <div class="detail-item">
                    <label>áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ</label>
                    <textarea name="followup_professional" placeholder="á”á‰áŸ’á…á¼á›á–áŸááŸŒá˜á¶á“áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆáá¶á˜áŠá¶á“..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group full-width">
              <label>áŸáŸá…á€áŸ’áá¸áŸá“áŸ’á“á·áŠáŸ’á‹á¶á“</label>
              <textarea name="conclusion" rows="3" placeholder="á”á‰áŸ’á…á¼á›áŸáŸá…á€áŸ’áá¸áŸá“áŸ’á“á·áŠáŸ’á‹á¶á“..."></textarea>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="followupSubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('followupModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Modals -->
  <div class="modal" id="viewDocModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá¯á€áŸá¶áš</h2>
      </div>
      <div class="modal-body">
        <div id="docDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewDocModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="viewFactoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áášáŸ„á„á…á€áŸ’áš</h2>
      </div>
      <div class="modal-body">
        <div id="factoryDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewFactoryModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="viewUserModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹</h2>
      </div>
      <div class="modal-body">
        <div id="userDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewUserModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="viewInspectionModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™</h2>
      </div>
      <div class="modal-body">
        <div id="inspectionDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewInspectionModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="viewFollowupModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·ááá¶á˜áŠá¶á“á€áŸ†á á·á</h2>
      </div>
      <div class="modal-body">
        <div id="followupDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewFollowupModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Message Box/Confirmation Modal -->
  <div class="modal" id="messageModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 id="messageTitle">Information</h2>
      </div>
      <div class="modal-body">
        <p id="messageText"></p>
        <div class="form-buttons" id="messageButtons" style="justify-content: center;">
          <!-- Buttons inserted by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // API URLs - Using your working server
    const DOC_API = "https://uat-api-office2.thithabirdnest.com/doc";
    const FACTORY_API = "https://uat-api-office2.thithabirdnest.com/fac";
    const USER_API = "https://uat-api-office2.thithabirdnest.com/user";
    
    // Global variables
    let allDocs = [], allFactories = [], allUsers = [];
    let allInspections = [], allFollowups = [];
    let currentEditingId = null;
    let selectedFile = null;

    // DOM Elements
    const body = document.body;
    const sidebar = document.getElementById('sidebar');
    const mainContainer = document.getElementById('mainContainer');
    const menuToggle = document.getElementById('menuToggle');
    const hideSidebarBtn = document.getElementById('hideSidebar');
    const showSidebarBtn = document.getElementById('showSidebar');
    
    // Import elements
    const fileInput = document.getElementById('fileInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const importBtn = document.getElementById('importBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    // Message/Confirmation box elements
    const messageModal = document.getElementById('messageModal');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const messageButtons = document.getElementById('messageButtons');

    // --- Simple Sidebar Toggle Functions ---
    function hideSidebar() {
      sidebar.classList.add('hidden');
      mainContainer.classList.add('expanded');
      showSidebarBtn.style.display = 'block';
    }

    function showSidebar() {
      sidebar.classList.remove('hidden');
      mainContainer.classList.remove('expanded');
      showSidebarBtn.style.display = 'none';
    }

    // Event listeners for sidebar buttons
    hideSidebarBtn.addEventListener('click', hideSidebar);
    showSidebarBtn.addEventListener('click', showSidebar);

    // Mobile menu toggle
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // --- Navigation and Section Switching ---
    function showSection(section, event) {
      if (event) event.preventDefault();
      
      // Hide sidebar on mobile
      if (sidebar.classList.contains('open') && window.innerWidth <= 900) {
          sidebar.classList.remove('open');
      }
      
      // Hide all main content sections
      document.getElementById('documents-section').style.display = 'none';
      document.getElementById('inspectionmanagement-section').style.display = 'none';
      document.getElementById('factories-section').style.display = 'none';
      document.getElementById('users-section').style.display = 'none';

      // Update active nav link
      document.querySelectorAll('.navbar-links a').forEach(a => a.classList.remove('active'));
      const activeLink = document.querySelector(`.navbar-links a[onclick*="${section}"]`);
      if (activeLink) activeLink.classList.add('active');

      // Show selected section
      if (section === 'documents') {
        document.getElementById('documents-section').style.display = 'block';
        fetchDocuments();
      } else if (section === 'inspectionmanagement') {
        document.getElementById('inspectionmanagement-section').style.display = 'block';
        loadSampleInspectionData();
      } else if (section === 'factories') {
        document.getElementById('factories-section').style.display = 'block';
        fetchFactories();
      } else if (section === 'users') {
        document.getElementById('users-section').style.display = 'block';
        fetchUsers();
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      currentEditingId = null; // Reset editing state on close
    }

    // --- Custom Message/Confirmation Functions ---
    function openMessageModal(title, text, type, callback) {
      messageTitle.textContent = title;
      messageText.textContent = text;
      messageButtons.innerHTML = '';
      
      if (type === 'confirm') {
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.innerHTML = '<span>âœ…</span> Yes';
        confirmBtn.onclick = () => {
          callback(true);
          closeModal('messageModal');
        };
        messageButtons.appendChild(confirmBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.innerHTML = '<span>âŒ</span> Cancel';
        cancelBtn.onclick = () => {
          callback(false);
          closeModal('messageModal');
        };
        messageButtons.appendChild(cancelBtn);
        
      } else {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-primary';
        closeBtn.innerHTML = '<span>âœ…</span> OK';
        closeBtn.onclick = () => closeModal('messageModal');
        messageButtons.appendChild(closeBtn);
      }
      
      messageModal.style.display = 'flex';
    }
    
    function showMessage(message, title = 'Information') {
        openMessageModal(title, message, 'info', () => {});
    }

    // --- Inspection Management Functions ---
    function showInspectionTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.inspection-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.inspection-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(`${tabName}-inspection`).classList.add('active');
      
      // Activate selected tab
      event.target.classList.add('active');
      
      // Load appropriate data
      if (tabName === 'initial') {
        renderInspections();
      } else if (tabName === 'followup') {
        renderFollowups();
      }
    }

    // Penalty Management Functions
    function togglePenaltyDetails(showDetails) {
      const detailsElement = document.getElementById('penalty_details');
      const yesOption = document.getElementById('penalty_yes_option');
      const noOption = document.getElementById('penalty_no_option');
      
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
        clearPenaltyDetails();
      }
    }
    
    function toggleFineDetails(showDetails) {
      const detailsElement = document.getElementById('fine_details');
      const yesOption = document.getElementById('fine_yes_option');
      const noOption = document.getElementById('fine_no_option');
      
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
        clearFineDetails();
      }
    }
    
    function toggleFollowupDetails(showDetails) {
      const detailsElement = document.getElementById('followup_details');
      const yesOption = document.getElementById('implemented_yes_option');
      const noOption = document.getElementById('implemented_no_option');
      
      if (showDetails) {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.remove('active');
        clearFollowupDetails();
      }
    }
    
    function clearPenaltyDetails() {
      const form = document.getElementById('inspectionForm');
      const fields = ['penalty_format', 'penalty_condition', 'penalty_health', 'penalty_professional'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }
    
    function clearFineDetails() {
      const form = document.getElementById('inspectionForm');
      const fields = ['fine_amount', 'fine_type', 'fine_reason'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }
    
    function clearFollowupDetails() {
      const form = document.getElementById('followupForm');
      const fields = ['followup_format', 'followup_condition', 'followup_health', 'followup_professional'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }

    // Function to update factory information when company is selected
    function updateFactoryInfo() {
      const select = document.querySelector('select[name="factory_name"]');
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedOption.value) {
        // Auto-fill the address fields from data attributes
        document.querySelector('input[name="sector"]').value = selectedOption.getAttribute('data-sector') || '';
        document.querySelector('input[name="village"]').value = selectedOption.getAttribute('data-village') || '';
        document.querySelector('input[name="commune"]').value = selectedOption.getAttribute('data-commune') || '';
        document.querySelector('input[name="district"]').value = selectedOption.getAttribute('data-district') || '';
        document.querySelector('input[name="province"]').value = selectedOption.getAttribute('data-province') || '';
      }
    }

    // Enhanced function to load original inspection data for follow-up
    function loadOriginalInspectionData() {
      const select = document.getElementById('originalInspectionSelect');
      const inspectionId = select.value;
      const infoDiv = document.getElementById('originalPenaltyInfo');
      const companyInfoDiv = document.getElementById('companyInfoDisplay');
      const penaltyDisplay = document.getElementById('penaltyDisplay');
      
      if (inspectionId) {
        const inspection = allInspections.find(i => i.id.toString() === inspectionId);
        if (inspection) {
          // Display company information
          document.getElementById('display_factory_name').value = inspection.factory_name || '';
          document.getElementById('display_sector').value = inspection.sector || '';
          document.getElementById('display_case_subject').value = inspection.case_subject || '';
          document.getElementById('display_village').value = inspection.village || '';
          document.getElementById('display_commune').value = inspection.commune || '';
          document.getElementById('display_district').value = inspection.district || '';
          document.getElementById('display_province').value = inspection.province || '';
          companyInfoDiv.style.display = 'block';
          
          // Display penalty information if exists
          if (inspection.has_penalty === 'á˜á¶á“') {
            penaltyDisplay.innerHTML = `
              <p><strong>á”áŸ‚á”á”á‘:</strong> ${inspection.penalty_format || 'N/A'}</span></p>
              <p><strong>á›á€áŸ’ááááŸ’áŒ:</strong> ${inspection.penalty_condition || 'N/A'}</span></p>
              <p><strong>áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–:</strong> ${inspection.penalty_health || 'N/A'}</span></p>
              <p><strong>áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ:</strong> ${inspection.penalty_professional || 'N/A'}</span></p>
            `;
            infoDiv.style.display = 'block';
          } else {
            infoDiv.style.display = 'none';
            showMessage('á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠá¾á˜á“áŸáŸ‡á˜á·á“á˜á¶á“á€áŸ†á á·áá‘áŸ', 'Info');
          }
        }
      } else {
        companyInfoDiv.style.display = 'none';
        infoDiv.style.display = 'none';
      }
    }

    // Populate original inspection dropdown
    function populateOriginalInspections() {
      const select = document.getElementById('originalInspectionSelect');
      select.innerHTML = '<option value="">-- á‡áŸ’ášá¾áŸášá¾áŸá€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠá¾á˜ --</option>';
      
      allInspections.filter(inspection => inspection.has_penalty === 'á˜á¶á“').forEach(inspection => {
        const option = document.createElement('option');
        option.value = inspection.id;
        option.textContent = `${inspection.no} - ${inspection.factory_name} (${inspection.inspection_date})`;
        select.appendChild(option);
      });
    }

    // Enhanced inspection rendering with new fields
    function renderInspections() {
      const tbody = document.getElementById('inspectionTableBody');
      tbody.innerHTML = allInspections.map(inspection => `
        <tr>
          <td>${inspection.no || ''}</td>
          <td>
            <div>
              <strong>${inspection.factory_name || ''}</strong>
              <div style="font-size: 0.8rem; color: #666;">
                <div>áœá·áŸáŸá™: ${inspection.sector || ''}</div>
                <div>á”áŸ’ášá’á¶á“á”á‘: ${inspection.case_subject || ''}</div>
              </div>
            </div>
          </td>
          <td>${inspection.inspection_date || ''}</td>
          <td>
            <span class="status-badge ${inspection.has_penalty === 'á˜á¶á“' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_penalty || 'á‚áŸ’á˜á¶á“'}
            </span>
          </td>
          <td>
            <span class="status-badge ${inspection.has_fine === 'á˜á¶á“' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_fine || 'á‚áŸ’á˜á¶á“'}
            </span>
          </td>
          <td>
            <span class="status-badge ${inspection.has_penalty === 'á˜á¶á“' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_penalty === 'á˜á¶á“' ? 'ááŸ’ášá¼áœáá¶á˜áŠá¶á“' : 'á”á¶á“á”á‰áŸ’á…á”áŸ‹'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewInspection('${inspection.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editInspection('${inspection.id}')">âœï¸ Edit</button>
              <button class="btn" onclick="deleteInspectionConfirm('${inspection.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderFollowups() {
      const tbody = document.getElementById('followupTableBody');
      tbody.innerHTML = allFollowups.map(followup => {
        const original = followup.original_inspection_data || {};
        return `
        <tr>
          <td>${followup.no || ''}</td>
          <td>${original.factory_name || ''}</td>
          <td>${followup.followup_date || ''}</td>
          <td>${original.inspection_date || ''}</td>
          <td>
            <span class="status-badge ${followup.penalty_implemented === 'á¢á“á»áœááŸ’á' ? 'status-completed' : 'status-pending'}">
              ${followup.penalty_implemented || 'N/A'}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewFollowup('${followup.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editFollowup('${followup.id}')">âœï¸ Edit</button>
              <button class="btn" onclick="deleteFollowupConfirm('${followup.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `}).join('');
    }

    // Form Submission Handlers for Inspection Management
    document.getElementById('inspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.factory_name || !data.group || !data.inspection_date || !data.sector || !data.case_subject) {
        showMessage('áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('inspectionSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allInspections.findIndex(i => i.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allInspections[index] = { ...allInspections[index], ...data, id: currentEditingId };
          }
          showMessage('á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™ááŸ’ášá¼áœá”á¶á“á€áŸ‚áŸá˜áŸ’ášá½á›áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!', 'Success');
        } else {
          const newInspection = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allInspections.push(newInspection);
          showMessage('á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™ááŸ’ášá¼áœá”á¶á“á”á„áŸ’á€á¾ááŠáŸ„á™á‡áŸ„á‚á‡áŸá™!', 'Success');
        }
        
        closeModal('inspectionModal');
        renderInspections();
        populateOriginalInspections();
      } catch (error) {
        console.error('Save error:', error);
        showMessage('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('followupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.original_inspection || !data.followup_date) {
        showMessage('áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('followupSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allFollowups.findIndex(i => i.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allFollowups[index] = { ...allFollowups[index], ...data, id: currentEditingId };
          }
          showMessage('á€á¶ášáá¶á˜áŠá¶á“ááŸ’ášá¼áœá”á¶á“á€áŸ‚áŸá˜áŸ’ášá½á›áŠáŸ„á™á‡áŸ„á‚á‡áŸá™!', 'Success');
        } else {
          const originalInspection = allInspections.find(i => i.id.toString() === data.original_inspection);
          const newFollowup = {
            id: Date.now(),
            ...data,
            original_inspection_data: originalInspection,
            created_at: new Date().toISOString()
          };
          allFollowups.push(newFollowup);
          showMessage('á€á¶ášáá¶á˜áŠá¶á“ááŸ’ášá¼áœá”á¶á“á”á„áŸ’á€á¾ááŠáŸ„á™á‡áŸ„á‚á‡áŸá™!', 'Success');
        }
        
        closeModal('followupModal');
        renderFollowups();
      } catch (error) {
        console.error('Save error:', error);
        showMessage('á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á€á¶ášáá¶á˜áŠá¶á“', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Event Listeners for Inspection Modals
    document.getElementById('openInspectionForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('inspectionModalTitle').textContent = 'á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™ááŸ’á˜á¸';
      document.getElementById('inspectionForm').reset();
      resetAllSelections();
      openModal('inspectionModal');
    });

    document.getElementById('openFollowupForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('followupModalTitle').textContent = 'áá¶á˜áŠá¶á“á€áŸ†á á·áááŸ’á˜á¸';
      document.getElementById('followupForm').reset();
      resetAllSelections();
      populateOriginalInspections();
      openModal('followupModal');
    });

    function resetAllSelections() {
      document.querySelectorAll('.penalty-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelectorAll('.penalty-details').forEach(details => {
        details.classList.remove('active');
      });
    }

    // Update sample data with new fields
    function loadSampleInspectionData() {
      allInspections = [
        {
          id: 1,
          no: 'INS001',
          factory_name: 'ášáŸ„á„á…á€áŸ’áš á€',
          sector: 'áœá·áŸáŸá™ á€',
          case_subject: 'á€á¶ášá”áŸ†á–á¶á“á›á¾áŸáŸ’áá„áŸ‹áŠá¶ášáŸá»áœááŸ’áá·á—á¶á–',
          group: 'á€áŸ’ášá»á˜ á€',
          inspection_date: '2024-01-15',
          village: 'á—á¼á˜á· á€',
          commune: 'áƒá»áŸ† á€',
          district: 'áŸáŸ’ášá»á€ á€',
          province: 'ááŸááŸ’á á€',
          has_penalty: 'á˜á¶á“',
          penalty_format: 'ááŸ’ášá¼áœá€áŸ‚á›á˜áŸ’á¢á”áŸ’ášá–áŸá“áŸ’á’á¢á‚áŸ’á‚á·áŸá“á¸',
          penalty_condition: 'á˜á·á“á”áŸ†á–áŸá‰áŸáŸ’áá„áŸ‹áŠá¶ášáŸá»áœááŸ’áá·á—á¶á–',
          penalty_health: 'ááŸ’áŸáŸ‚á—áŸ’á›á¾á„á˜á·á“á˜á¶á“áŸá»áœááŸ’áá·á—á¶á–',
          penalty_professional: 'á”á»á‚áŸ’á‚á›á·á€á‚áŸ’á˜á¶á“á€á¶ášá”ááŸ’áá»áŸ‡á”ááŸ’áá¶á›',
          has_fine: 'á‚áŸ’á˜á¶á“',
          remarks: 'ááŸ’ášá¼áœá€áŸ‚á›á˜áŸ’á¢á€áŸ’á“á»á„ášá™áŸˆá–áŸá› áŸ£áŸ ááŸ’á„áŸƒ'
        }
      ];
      
      allFollowups = [
        {
          id: 1,
          no: 'FLW001',
          original_inspection: '1',
          original_inspection_data: allInspections[0],
          followup_date: '2024-02-15',
          penalty_implemented: 'á¢á“á»áœááŸ’á',
          conclusion: 'ášáŸ„á„á…á€áŸ’ášá”á¶á“á€áŸ‚á›á˜áŸ’á¢áá¶á˜áá˜áŸ’ášá¼áœá€á¶ášá‚áŸ’ášá”áŸ‹á…áŸ†á“á»á…'
        }
      ];
      
      renderInspections();
      renderFollowups();
      populateOriginalInspections();
    }

    // --- Document Management Functions ---
    async function fetchDocuments() {
      try {
        const res = await fetch(DOC_API);
        const data = await res.json();
        allDocs = data.date || []; 
        renderDocuments(allDocs);
      } catch (error) {
        console.error("Document fetch error:", error);
        showMessage("Failed to fetch documents from server.", "Error");
      }
    }

    function renderDocuments(docs) {
      const tbody = document.getElementById('docTableBody');
      tbody.innerHTML = docs.map(doc => `
        <tr>
          <td>${doc.no || ''}</td>
          <td>${doc.ir || ''}</td>
          <td>${doc.outNo || ''}</td>
          <td>${doc.submitDate?.split('T')[0] || ''}</td>
          <td>${doc.source || ''}</td>
          <td>${doc.doc || ''}</td>
          <td>${doc.officer || ''}</td>
          <td>
            <span class="status-badge ${doc.progress === 'á”á¶á“á’áŸ’áœá¾á…áŸá‰' ? 'status-completed' : 'status-pending'}">
              ${doc.progress || ''}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewDocument('${doc.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editDocument('${doc.id}')">âœï¸ Edit</button>
              <button class="btn" onclick="deleteDocumentConfirm('${doc.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Document CRUD Functions
    function viewDocument(id) {
      const doc = allDocs.find(d => d.id.toString() === id.toString());
      if (!doc) {
        showMessage('Document not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('docDetail');
      detailDiv.innerHTML = `
        <p><strong>á›áŸáá…á¼á›:</strong> <span>${doc.no || ''}</span></p>
        <p><strong>á›áŸáá›á·áá·á (IR):</strong> <span>${doc.ir || ''}</span></p>
        <p><strong>á›áŸáá…áŸá‰:</strong> <span>${doc.outNo || ''}</span></p>
        <p><strong>ááŸ’á„áŸƒááŸ‚á›á·áá·á:</strong> <span>${doc.submitDate?.split('T')[0] || ''}</span></p>
        <p><strong>á¢á„áŸ’á‚á—á¶á–:</strong> <span>${doc.source || ''}</span></p>
        <p><strong>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš:</strong> <span>${doc.doc || ''}</span></p>
        <p><strong>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›:</strong> <span>${doc.officer || ''}</span></p>
        <p><strong>áŸáŸ’áá¶á“á—á¶á–:</strong> <span>${doc.progress || ''}</span></p>
      `;
      
      openModal('viewDocModal');
    }

    function editDocument(id) {
      const doc = allDocs.find(d => d.id.toString() === id.toString());
      if (!doc) {
        showMessage('Document not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('docModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›á¯á€áŸá¶áš';
      
      // Populate form with document data
      const form = document.getElementById('docForm');
      form.elements['no'].value = doc.no || '';
      form.elements['ir'].value = doc.ir || '';
      form.elements['outNo'].value = doc.outNo || '';
      form.elements['submitDate'].value = doc.submitDate?.split('T')[0] || '';
      form.elements['source'].value = doc.source || '';
      form.elements['doc'].value = doc.doc || '';
      form.elements['officer'].value = doc.officer || '';
      form.elements['progress'].value = doc.progress || '';
      
      openModal('docModal');
    }

    function deleteDocumentConfirm(id) {
      openMessageModal(
        'á›á»á”á¯á€áŸá¶áš', 
        'áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á¯á€áŸá¶ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteDocument(id);
          }
        }
      );
    }

    async function deleteDocument(id) {
      try {
        // Remove from local array
        allDocs = allDocs.filter(d => d.id.toString() !== id.toString());
        renderDocuments(allDocs);
        showMessage('Document deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete document', 'Error');
      }
    }

    // Document form submission
    document.getElementById('docForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.ir) {
        showMessage('áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('docSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allDocs.findIndex(d => d.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allDocs[index] = { ...allDocs[index], ...data, id: currentEditingId };
          }
          showMessage('Document updated successfully', 'Success');
        } else {
          const newDoc = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allDocs.push(newDoc);
          showMessage('Document created successfully', 'Success');
        }
        
        closeModal('docModal');
        renderDocuments(allDocs);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save document', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- Factory Management Functions ---
    async function fetchFactories() {
      try {
        const res = await fetch(FACTORY_API);
        const data = await res.json();
        allFactories = data.data || [];
        renderFactories(allFactories);
        return allFactories;
      } catch (error) {
        console.error("Factory fetch error:", error);
        showMessage("Failed to fetch factories from server.", "Error");
        return [];
      }
    }

    function renderFactories(factories) {
      const tbody = document.getElementById('factoryTableBody');
      tbody.innerHTML = factories.map(factory => `
        <tr>
          <td>${factory.no || ''}</td>
          <td>${factory.factoryname || ''}</td>
          <td>${factory.factoryname_en || ''}</td>
          <td>${factory.sector || ''}</td>
          <td>${factory.village || ''}</td>
          <td>${factory.commune || ''}</td>
          <td>${factory.district || ''}</td>
          <td>${factory.province || ''}</td>
          <td>${factory.total_workers || ''}</td>
          <td>${factory.female_workers || ''}</td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewFactory('${factory.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editFactory('${factory.id}')">âœï¸ Edit</button> 
              <button class="btn" onclick="deleteFactoryConfirm('${factory.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Factory CRUD Functions
    function viewFactory(id) {
      const factory = allFactories.find(f => f.id.toString() === id.toString());
      if (!factory) {
        showMessage('Factory not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('factoryDetail');
      detailDiv.innerHTML = `
        <p><strong>á›áŸáá…á¼á›:</strong> <span>${factory.no || ''}</span></p>
        <p><strong>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš:</strong> <span>${factory.factoryname || ''}</span></p>
        <p><strong>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN):</strong> <span>${factory.factoryname_en || ''}</span></p>
        <p><strong>Sector:</strong> <span>${factory.sector || ''}</span></p>
        <p><strong>á—á¼á˜á·:</strong> <span>${factory.village || ''}</span></p>
        <p><strong>áƒá»áŸ†:</strong> <span>${factory.commune || ''}</span></p>
        <p><strong>áŸáŸ’ášá»á€:</strong> <span>${factory.district || ''}</span></p>
        <p><strong>ááŸááŸ’á:</strong> <span>${factory.province || ''}</span></p>
        <p><strong>á¢á¶áŸá™áŠáŸ’á‹á¶á“:</strong> <span>${factory.address || ''}</span></p>
        <p><strong>á€á˜áŸ’á˜á€ášáŸášá»á”:</strong> <span>${factory.total_workers || ''}</span></p>
        <p><strong>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸:</strong> <span>${factory.female_workers || ''}</span></p>
        <p><strong>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„:</strong> <span>${factory.admin_name || ''}</span></p>
        <p><strong>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘:</strong> <span>${factory.admin_phone || ''}</span></p>
      `;
      
      openModal('viewFactoryModal');
    }

    function editFactory(id) {
      const factory = allFactories.find(f => f.id.toString() === id.toString());
      if (!factory) {
        showMessage('Factory not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('factoryModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›ášáŸ„á„á…á€áŸ’áš';
      
      // Populate form with factory data
      const form = document.getElementById('factoryForm');
      form.elements['no'].value = factory.no || '';
      form.elements['factoryname'].value = factory.factoryname || '';
      form.elements['factoryname_en'].value = factory.factoryname_en || '';
      form.elements['sector'].value = factory.sector || '';
      form.elements['village'].value = factory.village || '';
      form.elements['commune'].value = factory.commune || '';
      form.elements['district'].value = factory.district || '';
      form.elements['province'].value = factory.province || '';
      form.elements['address'].value = factory.address || '';
      form.elements['total_workers'].value = factory.total_workers || '';
      form.elements['female_workers'].value = factory.female_workers || '';
      form.elements['admin_name'].value = factory.admin_name || '';
      form.elements['admin_phone'].value = factory.admin_phone || '';
      
      openModal('factoryModal');
    }

    function deleteFactoryConfirm(id) {
      openMessageModal(
        'á›á»á”ášáŸ„á„á…á€áŸ’áš', 
        'áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”ášáŸ„á„á…á€áŸ’ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteFactory(id);
          }
        }
      );
    }

    async function deleteFactory(id) {
      try {
        // Remove from local array
        allFactories = allFactories.filter(f => f.id.toString() !== id.toString());
        renderFactories(allFactories);
        showMessage('Factory deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete factory', 'Error');
      }
    }

    // Factory form submission
    document.getElementById('factoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.factoryname || !data.factoryname_en || !data.sector) {
        showMessage('áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('factorySubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allFactories.findIndex(f => f.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allFactories[index] = { ...allFactories[index], ...data, id: currentEditingId };
          }
          showMessage('Factory updated successfully', 'Success');
        } else {
          const newFactory = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allFactories.push(newFactory);
          showMessage('Factory created successfully', 'Success');
        }
        
        closeModal('factoryModal');
        renderFactories(allFactories);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save factory', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- User Management Functions ---
    async function fetchUsers() {
      try {
        const res = await fetch(USER_API);
        const data = await res.json();
        allUsers = data.data || [];
        renderUsers(allUsers);
      } catch (error) {
        console.error("User fetch error:", error);
        showMessage("Failed to fetch users from server.", "Error");
      }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.name || ''}</td>
          <td>${user.phone || ''}</td>
          <td>${user.email || ''}</td>
          <td>
            <span class="role-badge ${getRoleBadgeClass(user.role)}">
              ${getRoleDisplayName(user.role)}
            </span>
          </td>
          <td>${user.function || ''}</td>
          <td>${user.sangkat || ''}</td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewUser('${user.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editUser('${user.id}')">âœï¸ Edit</button>
              <button class="btn" onclick="deleteUserConfirm('${user.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function getRoleBadgeClass(role) {
      switch(role) {
        case 'admin': return 'role-badge-admin';
        case 'officer': return 'role-badge-officer';
        default: return 'role-badge-officer';
      }
    }

    function getRoleDisplayName(role) {
      switch(role) {
        case 'admin': return 'á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„';
        case 'officer': return 'á˜á“áŸ’ááŸ’ášá¸';
        default: return role;
      }
    }

    // User CRUD Functions
    function viewUser(id) {
      const user = allUsers.find(u => u.id.toString() === id.toString());
      if (!user) {
        showMessage('User not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('userDetail');
      detailDiv.innerHTML = `
        <p><strong>áˆáŸ’á˜áŸ„áŸ‡:</strong> <span>${user.name || ''}</span></p>
        <p><strong>á‘á¼ášáŸáŸá–áŸ’á‘:</strong> <span>${user.phone || ''}</span></p>
        <p><strong>á¢áŸŠá¸á˜áŸ‚á›:</strong> <span>${user.email || ''}</span></p>
        <p><strong>áá½á“á¶á‘á¸:</strong> <span>${getRoleDisplayName(user.role)}</span></p>
        <p><strong>á˜á»áá„á¶áš:</strong> <span>${user.function || ''}</span></p>
        <p><strong>áŸá„áŸ’á€á¶ááŸ‹:</strong> <span>${user.sangkat || ''}</span></p>
      `;
      
      openModal('viewUserModal');
    }

    function editUser(id) {
      const user = allUsers.find(u => u.id.toString() === id.toString());
      if (!user) {
        showMessage('User not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('userModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹';
      
      // Populate form with user data
      const form = document.getElementById('userForm');
      form.elements['name'].value = user.name || '';
      form.elements['phone'].value = user.phone || '';
      form.elements['email'].value = user.email || '';
      form.elements['password'].value = ''; // Don't populate password for security
      form.elements['role'].value = user.role || '';
      form.elements['function'].value = user.function || '';
      form.elements['sangkat'].value = user.sangkat || '';
      
      openModal('userModal');
    }

    function deleteUserConfirm(id) {
      openMessageModal(
        'á›á»á”á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹', 
        'áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteUser(id);
          }
        }
      );
    }

    async function deleteUser(id) {
      try {
        // Remove from local array
        allUsers = allUsers.filter(u => u.id.toString() !== id.toString());
        renderUsers(allUsers);
        showMessage('User deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete user', 'Error');
      }
    }

    // User form submission
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.name || !data.phone || !data.email || !data.password || !data.role) {
        showMessage('áŸá¼á˜á”áŸ†á–áŸá‰á–áŸááŸŒá˜á¶á“á…á¶áŸ†á”á¶á…áŸ‹á‘á¶áŸ†á„á¢áŸáŸ‹', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('userSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allUsers.findIndex(u => u.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allUsers[index] = { ...allUsers[index], ...data, id: currentEditingId };
          }
          showMessage('User updated successfully', 'Success');
        } else {
          const newUser = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allUsers.push(newUser);
          showMessage('User created successfully', 'Success');
        }
        
        closeModal('userModal');
        renderUsers(allUsers);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save user', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Inspection CRUD Functions
    function viewInspection(id) {
      const inspection = allInspections.find(i => i.id.toString() === id.toString());
      if (!inspection) {
        showMessage('Inspection not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('inspectionDetail');
      detailDiv.innerHTML = `
        <p><strong>á›áŸáá…á¼á›:</strong> <span>${inspection.no || ''}</span></p>
        <p><strong>á€áŸ’ášá»á˜:</strong> <span>${inspection.group || ''}</span></p>
        <p><strong>á€á¶á›á”ášá·á…áŸ’á†áŸá‘ááŸ’ášá½áá–á·á“á·ááŸ’á™:</strong> <span>${inspection.inspection_date || ''}</span></p>
        <p><strong>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš:</strong> <span>${inspection.factory_name || ''}</span></p>
        <p><strong>áœá·áŸáŸá™:</strong> <span>${inspection.sector || ''}</span></p>
        <p><strong>á”áŸ’ášá’á¶á“á”á‘:</strong> <span>${inspection.case_subject || ''}</span></p>
        <p><strong>á—á¼á˜á·:</strong> <span>${inspection.village || ''}</span></p>
        <p><strong>áƒá»áŸ†:</strong> <span>${inspection.commune || ''}</span></p>
        <p><strong>áŸáŸ’ášá»á€:</strong> <span>${inspection.district || ''}</span></p>
        <p><strong>ááŸááŸ’á:</strong> <span>${inspection.province || ''}</span></p>
        <p><strong>á€áŸ†á á·á:</strong> <span>${inspection.has_penalty || ''}</span></p>
        ${inspection.has_penalty === 'á˜á¶á“' ? `
          <p><strong>á”áŸ‚á”á”á‘:</strong> <span>${inspection.penalty_format || ''}</span></p>
          <p><strong>á›á€áŸ’ááááŸ’áŒ:</strong> <span>${inspection.penalty_condition || ''}</span></p>
          <p><strong>áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–:</strong> <span>${inspection.penalty_health || ''}</span></p>
          <p><strong>áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ:</strong> <span>${inspection.penalty_professional || ''}</span></p>
        ` : ''}
        <p><strong>á•á¶á€:</strong> <span>${inspection.has_fine || ''}</span></p>
        ${inspection.has_fine === 'á˜á¶á“' ? `
          <p><strong>á…áŸ†á“á½á“á‘á¹á€á”áŸ’ášá¶á€áŸ‹:</strong> <span>${inspection.fine_amount || ''}</span></p>
          <p><strong>á”áŸ’ášá—áŸá‘á•á¶á€:</strong> <span>${inspection.fine_type || ''}</span></p>
          <p><strong>á áŸáá»á•á›:</strong> <span>${inspection.fine_reason || ''}</span></p>
        ` : ''}
        <p><strong>á•áŸ’áŸáŸá„áŸ—:</strong> <span>${inspection.remarks || ''}</span></p>
      `;
      
      openModal('viewInspectionModal');
    }

    function editInspection(id) {
      const inspection = allInspections.find(i => i.id.toString() === id.toString());
      if (!inspection) {
        showMessage('Inspection not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('inspectionModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™';
      
      // Populate form with inspection data
      const form = document.getElementById('inspectionForm');
      form.elements['no'].value = inspection.no || '';
      form.elements['group'].value = inspection.group || '';
      form.elements['inspection_date'].value = inspection.inspection_date || '';
      form.elements['factory_name'].value = inspection.factory_name || '';
      form.elements['sector'].value = inspection.sector || '';
      form.elements['case_subject'].value = inspection.case_subject || '';
      form.elements['village'].value = inspection.village || '';
      form.elements['commune'].value = inspection.commune || '';
      form.elements['district'].value = inspection.district || '';
      form.elements['province'].value = inspection.province || '';
      form.elements['remarks'].value = inspection.remarks || '';
      
      // Handle penalty section
      if (inspection.has_penalty === 'á˜á¶á“') {
        togglePenaltyDetails(true);
        form.elements['penalty_format'].value = inspection.penalty_format || '';
        form.elements['penalty_condition'].value = inspection.penalty_condition || '';
        form.elements['penalty_health'].value = inspection.penalty_health || '';
        form.elements['penalty_professional'].value = inspection.penalty_professional || '';
      } else {
        togglePenaltyDetails(false);
      }
      
      // Handle fine section
      if (inspection.has_fine === 'á˜á¶á“') {
        toggleFineDetails(true);
        form.elements['fine_amount'].value = inspection.fine_amount || '';
        form.elements['fine_type'].value = inspection.fine_type || '';
        form.elements['fine_reason'].value = inspection.fine_reason || '';
      } else {
        toggleFineDetails(false);
      }
      
      openModal('inspectionModal');
    }

    function deleteInspectionConfirm(id) {
      openMessageModal(
        'á›á»á”á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™', 
        'áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™á“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteInspection(id);
          }
        }
      );
    }

    async function deleteInspection(id) {
      try {
        // Remove from local array
        allInspections = allInspections.filter(i => i.id.toString() !== id.toString());
        renderInspections();
        populateOriginalInspections();
        showMessage('Inspection deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete inspection', 'Error');
      }
    }

    // Follow-up CRUD Functions
    function viewFollowup(id) {
      const followup = allFollowups.find(f => f.id.toString() === id.toString());
      if (!followup) {
        showMessage('Follow-up not found', 'Error');
        return;
      }
      
      const original = followup.original_inspection_data || {};
      const detailDiv = document.getElementById('followupDetail');
      detailDiv.innerHTML = `
        <p><strong>á›áŸáá…á¼á›:</strong> <span>${followup.no || ''}</span></p>
        <p><strong>á€á¶á›á”ášá·á…áŸ’á†áŸá‘áá¶á˜áŠá¶á“:</strong> <span>${followup.followup_date || ''}</span></p>
        <p><strong>á€á¶ášááŸ’ášá½áá–á·á“á·ááŸ’á™áŠá¾á˜:</strong> <span>${original.no || ''} - ${original.factory_name || ''}</span></p>
        <p><strong>á›á‘áŸ’á’á•á›áá¶á˜áŠá¶á“:</strong> <span>${followup.penalty_implemented || ''}</span></p>
        ${followup.penalty_implemented === 'á˜á·á“á¢á“á»áœááŸ’á' ? `
          <p><strong>á”áŸ‚á”á”á‘:</strong> <span>${followup.followup_format || ''}</span></p>
          <p><strong>á›á€áŸ’ááááŸ’áŒ:</strong> <span>${followup.followup_condition || ''}</span></p>
          <p><strong>áŸá»áá—á¶á–á“á·á„áŸá»áœááŸ’áá—á¶á–:</strong> <span>${followup.followup_health || ''}</span></p>
          <p><strong>áœá·á‡áŸ’á‡á¶á‡á¸áœáŸˆ:</strong> <span>${followup.followup_professional || ''}</span></p>
        ` : ''}
        <p><strong>áŸáŸá…á€áŸ’áá¸áŸá“áŸ’á“á·áŠáŸ’á‹á¶á“:</strong> <span>${followup.conclusion || ''}</span></p>
      `;
      
      openModal('viewFollowupModal');
    }

    function editFollowup(id) {
      const followup = allFollowups.find(f => f.id.toString() === id.toString());
      if (!followup) {
        showMessage('Follow-up not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('followupModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›áá¶á˜áŠá¶á“á€áŸ†á á·á';
      
      // Populate form with followup data
      const form = document.getElementById('followupForm');
      form.elements['no'].value = followup.no || '';
      form.elements['original_inspection'].value = followup.original_inspection || '';
      form.elements['followup_date'].value = followup.followup_date || '';
      form.elements['conclusion'].value = followup.conclusion || '';
      
      // Handle follow-up result section
      if (followup.penalty_implemented === 'á˜á·á“á¢á“á»áœááŸ’á') {
        toggleFollowupDetails(true);
        form.elements['followup_format'].value = followup.followup_format || '';
        form.elements['followup_condition'].value = followup.followup_condition || '';
        form.elements['followup_health'].value = followup.followup_health || '';
        form.elements['followup_professional'].value = followup.followup_professional || '';
      } else {
        toggleFollowupDetails(false);
      }
      
      // Load original inspection data
      loadOriginalInspectionData();
      
      openModal('followupModal');
    }

    function deleteFollowupConfirm(id) {
      openMessageModal(
        'á›á»á”áá¶á˜áŠá¶á“á€áŸ†á á·á', 
        'áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á”áá¶á˜áŠá¶á“á€áŸ†á á·áá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteFollowup(id);
          }
        }
      );
    }

    async function deleteFollowup(id) {
      try {
        // Remove from local array
        allFollowups = allFollowups.filter(f => f.id.toString() !== id.toString());
        renderFollowups();
        showMessage('Follow-up deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete follow-up', 'Error');
      }
    }

    // --- Event Listeners for Modals ---
    document.getElementById('openDocForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('docModalTitle').textContent = 'á”á‰áŸ’á…á¼á›á¯á€áŸá¶ášááŸ’á˜á¸';
      document.getElementById('docForm').reset();
      openModal('docModal');
    });
    
    document.getElementById('openFactoryForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('factoryModalTitle').textContent = 'á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸';
      document.getElementById('factoryForm').reset();
      openModal('factoryModal');
    });

    document.getElementById('openUserForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('userModalTitle').textContent = 'á”á‰áŸ’á…á¼á›á¢áŸ’á“á€á”áŸ’ášá¾á”áŸ’ášá¶áŸáŸ‹ááŸ’á˜á¸';
      document.getElementById('userForm').reset();
      openModal('userModal');
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      showSection('documents');
    });
  </script>
</body>
</html>