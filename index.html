<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Office Management System</title>
  <link rel="stylesheet" href="style.css">

  <!-- Excel Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <img src="https://1000logos.net/wp-content/uploads/2017/02/Facebook-Logosu.png" alt="Logo">
    <ul>
      <li>Home</li>
      <li>Search</li>
      <li>Documents</li>
      <li>Map</li>
    </ul>
    <div class="login"><a href="#">Login</a></div>
  </nav>

  <!-- Add Document + Filter Section -->
  <section class="add-document">
    <button id="openForm">➕ បញ្ចូលឯកសារ</button>

    <div class="filter-section">
      <label>បង្ហាញចំនួន:</label>
      <select id="showCount">
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>

      <input type="search" id="searchBox" placeholder="ស្វែងរកឯកសារ...">
      <button id="exportExcelBtn">📥 ទាញយក Excel</button>
    </div>
  </section>

  <!-- Table -->
  <div class="table-container">
    <table id="documentTable">
      <thead>
        <tr>
          <th> 1 លេខចូល</th> 
          <th> 2 លេខលិខិត(IR)</th>
          <th> 3 លេខចេញ</th>
          <th> 4 ថ្ងៃ.ខែ. លិខិតចូល/ចេញ</th>
          <th>5 អង្គភាព/ប្រភពលិខិត</th>
          <th>6 ប្រភេទឯកសារ</th>
          <th>7 ថ្ងៃ.ខែ.ឆ្នាំមុខការិ.២</th>
          <th>8 មន្រ្តីទទួលមុខការ</th>
          <th>8 ថ្ងៃ.ខែ.ឆ្នាំទទួល</th>
          <th>0 មិនទាន់ធ្វើចេញ/បានធ្វើចេញរួចរាល់</th>
          <th>11 ចំនួនថ្ងៃទាន់បានធ្វើចេញ</th>
          <th>12 ចូលប្រធានការិ.</th>
          <th>13 ចូលអនុ.នាយកដ្ឋាន (លោក ព្រំ សុវណ្ណាក់)</th>
          <th>14ចូលប្រធាននាយកដ្ឋាន</th>
          <th>15 ថ្ងៃ.ខែ.ឆ្នាំចេញលិខិត</th>
          <th>16 "ចេញបញ្ជិកា/ មិនទាន់ចេញបញ្ជិកា"/th>
          <th>17 មូលហេតុ/ផ្សេងៗ</th>
          <th>18 សកម្មភាព</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Form Modal -->
  <div id="myForm">
  <h2 class="form-title">បញ្ចូលឯកសារ</h2>
  <form id="contactForm" class="styled-form">
    <div class="form-group"><label>1. លេខចូល</label><input type="text" name="no" required></div>
    <div class="form-group"><label>2. លេខលិខិត(IR)</label><input type="text" name="ir"></div>
    <div class="form-group"><label>3. លេខចេញ</label><input type="text" name="outNo"></div>
    <div class="form-group"><label>4. ថ្ងៃខែលិខិតចូល/ចេញ</label><input type="date" name="submitDate"></div>
    <div class="form-group"><label>5. អង្គភាព/ប្រភពលិខិត</label><input type="text" name="source"></div>
    <div class="form-group"><label>6. ប្រភេទឯកសារ</label><input type="text" name="doc"></div>
    <div class="form-group"><label>7. ថ្ងៃខែមុខការិ.២</label><input type="date" name="officeDate2"></div>
    <div class="form-group"><label>8. មន្រ្តីទទួលមុខការ</label><input type="text" name="officer"></div>
    <div class="form-group"><label>9. ថ្ងៃខែឆ្នាំទទួល</label><input type="date" name="receiveDate"></div>
    <div class="form-group"><label>10. មិនទាន់ធ្វើចេញ/បានធ្វើចេញរួចរាល់</label><input type="text" name="progress"></div>
    <div class="form-group"><label>11. ចំនួនថ្ងៃទាន់បានធ្វើចេញ</label><input type="text" name="duration"></div>
    <div class="form-group"><label>12. ចូលប្រធានការិ.</label><input type="text" name="toChiefOffice"></div>
    <div class="form-group"><label>13. ចូលអនុ.នាយកដ្ឋាន</label><input type="text" name="toDeputy"></div>
    <div class="form-group"><label>14. ចូលប្រធាននាយកដ្ឋាន</label><input type="text" name="toHeadDept"></div>
    <div class="form-group"><label>15. ថ្ងៃខែឆ្នាំចេញលិខិត</label><input type="date" name="outDate"></div>
    <div class="form-group"><label>16. ចេញបញ្ជិកា/មិនទាន់ចេញបញ្ជិកា</label><input type="text" name="registryStatus"></div>
    <div class="form-group"><label>17. មូលហេតុ/ផ្សេងៗ</label><textarea name="reason" rows="2"></textarea></div>

    <div class="form-buttons">
      <button type="submit" class="btn-submit">រក្សាទុក</button>
      <button type="button" id="closeForm" class="btn-close">បិទ</button>
    </div>
  </form>
</div>
  <!-- View Popup -->
  <div id="viewPopup" class="popup">
    <div class="popup-content">
      <span class="close" onclick="closeView()">&times;</span>
      <h2>Document Summary</h2>
      <p><strong>ID:</strong> <span id="vId"></span></p>
      <p><strong>Name:</strong> <span id="vName"></span></p>
      <p><strong>Description:</strong> <span id="vDesc"></span></p>
      <p><strong>Date:</strong> <span id="vDate"></span></p>
    </div>
  </div>

  <script>
  const API_URL = "http://localhost:4000/doc";
  const form = document.getElementById("contactForm");
  const tableBody = document.getElementById("tableBody");
  const formModal = document.getElementById("myForm");
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("openForm");
  const closeBtn = document.getElementById("closeForm");
  const searchInput = document.getElementById("searchBox");
  let editingId = null;
  let allDocs = [];

  // === Open / Close Form ===
  openBtn.onclick = () => {
    formModal.style.display = 'block';
    overlay.style.display = 'block';
    form.reset();
    editingId = null;
  };
  closeBtn.onclick = overlay.onclick = () => {
    formModal.style.display = 'none';
    overlay.style.display = 'none';
  };

  // === Fetch Documents ===
  async function fetchDocument() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      allDocs = data.date || [];

      // Sort newest first
      allDocs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      renderTable(allDocs);
    } catch (error) {
      console.error("Fetch Error:", error);
    }
  }

  // === Render Table ===
// === Render Table ===
function renderTable(docs) {
  tableBody.innerHTML = "";
  docs.forEach((doc) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${doc.no || ""}</td>
      <td>${doc.ir || ""}</td>
      <td>${doc.outNo || ""}</td>
      <td>${doc.submitDate || ""}</td>
      <td>${doc.source || ""}</td>
      <td>${doc.doc || ""}</td>
      <td>${doc.officeDate2 || ""}</td>
      <td>${doc.officer || ""}</td>
      <td>${doc.receiveDate || ""}</td>
      <td>${doc.progress || ""}</td>
      <td>${doc.duration || ""}</td>
      <td>${doc.toChiefOffice || ""}</td>
      <td>${doc.toDeputy || ""}</td>
      <td>${doc.toHeadDept || ""}</td>
      <td>${doc.outDate || ""}</td>
      <td>${doc.registryStatus || ""}</td>
      <td>${doc.reason || ""}</td>
      <td>
        <button class="viewBtn">👁️ View</button>
        <button class="editBtn">✏️ Edit</button>
        <button class="deleteBtn">🗑️ Delete</button>
      </td>
    `;

    // View button
    row.querySelector(".viewBtn").onclick = () => {
      viewDocument(
        doc.id,
        doc.doc,
        doc.source,
        doc.submitDate || "",
      );
    };

    // Edit button
    row.querySelector(".editBtn").onclick = () => openEditForm(doc);

    // Delete button
    row.querySelector(".deleteBtn").onclick = () => deleteDoc(doc.id);

    tableBody.appendChild(row);
  });
}

  // === Search Function ===
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = allDocs.filter((d) =>
      [d.no, d.ir, d.source, d.doc, d.officer, d.status].some(v => v?.toLowerCase().includes(q))
    );
    renderTable(filtered);
  });

  // === Submit Form ===
  form.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Collect all form data
  const formData = Object.fromEntries(new FormData(form).entries());

  const method = editingId ? "PUT" : "POST";
  const url = editingId ? `${API_URL}/${editingId}` : API_URL;

  try {
    const res = await fetch(url, {
      method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(formData),
    });

    const result = await res.json();

    if (res.ok) {
      alert(editingId ? "បានកែប្រែឯកសារ!" : "បានរក្សាទុកឯកសារថ្មី!");
      formModal.style.display = "none";
      overlay.style.display = "none";

      // Update table data
      if (editingId) {
        const i = allDocs.findIndex((d) => d.id === editingId);
        if (i !== -1) allDocs[i] = result.doc;
      } else {
        allDocs.unshift(result.doc);
      }

      renderTable(allDocs);
    } else {
      alert("បញ្ហាក្នុងការរក្សាទុកឯកសារ!");
    }
  } catch (err) {
    console.error("Save Error:", err);
  }
});
  // === Edit ===
  function openEditForm(doc) {
  editingId = doc.id;
  formModal.style.display = 'block';
  overlay.style.display = 'block';
  for (const element of form.elements) {
    if (element.name) element.value = doc[element.name] || "";
  }
}
  // === Delete ===
  async function deleteDoc(id) {
    if (!confirm("តើអ្នកពិតជាចង់លុបឯកសារនេះមែនទេ?")) return;
    try {
      const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      const data = await res.json();
      alert(data.message);
      allDocs = allDocs.filter(d => d.id !== id);
      renderTable(allDocs);
    } catch (err) {
      console.error("Delete Error:", err);
    }
  }

  // === Export to Excel ===
  document.getElementById("exportExcelBtn").onclick = () => {
    const ws = XLSX.utils.json_to_sheet(allDocs);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Documents");
    XLSX.writeFile(wb, "documents.xlsx");
  };

  // === View Popup ===
  function viewDocument(id, name, description, date) {
    document.getElementById('vId').textContent = id;
    document.getElementById('vName').textContent = name;
    document.getElementById('vDesc').textContent = description;
    document.getElementById('vDate').textContent = date;
    document.getElementById('viewPopup').style.display = 'flex';
  }
  function closeView() {
    document.getElementById('viewPopup').style.display = 'none';
  }

  window.addEventListener("DOMContentLoaded", fetchDocument);
</script>
</body>
</html>