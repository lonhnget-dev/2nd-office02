<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Office Management System</title>
  <link rel="stylesheet" href="style.css">

  <!-- Excel Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <img src="https://1000logos.net/wp-content/uploads/2017/02/Facebook-Logosu.png" alt="Logo">
    <ul>
      <li>Home</li>
      <li>Search</li>
      <li>Documents</li>
      <li>Map</li>
    </ul>
    <div class="login"><a href="#">Login</a></div>
  </nav>

  <!-- Add Document + Filter Section -->
  <section class="add-document">
    <button id="openForm">➕ បញ្ចូលឯកសារ</button>

    <div class="filter-section">
      <label>បង្ហាញចំនួន:</label>
      <select id="showCount">
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>

      <input type="search" id="searchBox" placeholder="ស្វែងរកឯកសារ...">
      <button id="exportExcelBtn">📥 ទាញយក Excel</button>
    </div>
  </section>

  <!-- Table -->
  <div class="table-container">
    <table id="documentTable">
      <thead>
        <tr>
          <th>លេខចូល</th>
          <th>លេខលិខិត(IR)</th>
          <th>លេខចេញ</th>
          <th>ថ្ងៃខែ</th>
          <th>អង្គភាព</th>
          <th>ប្រភេទឯកសារ</th>
          <th>មន្រ្តីទទួល</th>
          <th>ស្ថានភាព</th>
          <th>សកម្មភាព</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Form Modal -->
  <div id="myForm">
    <h2 class="form-title">បញ្ចូលឯកសារ</h2>
    <form id="contactForm" class="styled-form">
  <!-- 1. លេខចូល -->
  <div class="form-group">
    <label>លេខចូល</label>
    <input type="text" name="no" placeholder="បញ្ចូលលេខចូល" required>
  </div>

  <!-- 2. លេខលិខិត(IR) -->
  <div class="form-group">
    <label>លេខលិខិត (IR)</label>
    <input type="text" name="ir" placeholder="បញ្ចូលលេខលិខិត (IR)">
  </div>

  <!-- 3. លេខចេញ -->
  <div class="form-group">
    <label>លេខចេញ</label>
    <input type="text" name="outNo" placeholder="បញ្ចូលលេខចេញ">
  </div>

  <!-- 4. ថ្ងៃខែលិខិតចូល/ចេញ -->
  <div class="form-group">
    <label>ថ្ងៃខែលិខិតចូល/ចេញ</label>
    <input type="date" name="submitDate">
  </div>

  <!-- 5. អង្គភាព/ប្រភពលិខិត -->
  <div class="form-group">
    <label>អង្គភាព/ប្រភពលិខិត</label>
    <input type="text" name="source" placeholder="បញ្ចូលអង្គភាព ឬប្រភពលិខិត">
  </div>

  <!-- 6. ប្រភេទឯកសារ -->
  <div class="form-group">
    <label>ប្រភេទឯកសារ</label>
    <input type="text" name="doc" placeholder="ឧទាហរណ៍: លិខិតជាផ្លូវការ">
  </div>

  <!-- 7. ថ្ងៃខែមុខការិ.២ -->
  <div class="form-group">
    <label>ថ្ងៃខែមុខការិ.២</label>
    <input type="date" name="officeDate2">
  </div>

  <!-- 8. មន្រ្តីទទួលមុខការ -->
  <div class="form-group">
    <label>មន្រ្តីទទួលមុខការ</label>
    <input type="text" name="officer" placeholder="ឈ្មោះមន្រ្តីទទួលមុខការ">
  </div>

  <!-- 9. ថ្ងៃខែឆ្នាំទទួល -->
  <div class="form-group">
    <label>ថ្ងៃខែឆ្នាំទទួល</label>
    <input type="date" name="receiveDate">
  </div>

  <!-- 10. មិនទាន់ធ្វើចេញ/បានធ្វើចេញរួចរាល់ -->
  <div class="form-group">
    <label>ស្ថានភាពការងារ</label>
    <select name="progress">
      <option value="">ជ្រើសរើសស្ថានភាព</option>
      <option value="មិនទាន់ធ្វើចេញ">មិនទាន់ធ្វើចេញ</option>
      <option value="បានធ្វើចេញរួចរាល់">បានធ្វើចេញរួចរាល់</option>
    </select>
  </div>

  <!-- 11. ចំនួនថ្ងៃទាន់បានធ្វើចេញ -->
  <div class="form-group">
    <label>ចំនួនថ្ងៃទាន់បានធ្វើចេញ</label>
    <input type="number" name="duration" placeholder="ចំនួនថ្ងៃ">
  </div>

  <!-- 12. ចូលប្រធានការិ. -->
  <div class="form-group">
    <label>ចូលប្រធានការិ.</label>
    <input type="text" name="toChiefOffice" placeholder="ឈ្មោះប្រធានការិ.">
  </div>

  <!-- 13. ចូលអនុ.នាយកដ្ឋាន -->
  <div class="form-group">
    <label>ចូលអនុ.នាយកដ្ឋាន</label>
    <input type="text" name="toDeputy" placeholder="ឈ្មោះអនុ.នាយកដ្ឋាន">
  </div>

  <!-- 14. ចូលប្រធាននាយកដ្ឋាន -->
  <div class="form-group">
    <label>ចូលប្រធាននាយកដ្ឋាន</label>
    <input type="text" name="toHeadDept" placeholder="ឈ្មោះប្រធាននាយកដ្ឋាន">
  </div>

  <!-- 15. ថ្ងៃខែឆ្នាំចេញលិខិត -->
  <div class="form-group">
    <label>ថ្ងៃខែឆ្នាំចេញលិខិត</label>
    <input type="date" name="outDate">
  </div>

  <!-- 16. ចេញបញ្ជិកា/មិនទាន់ចេញបញ្ជិកា -->
  <div class="form-group">
    <label>ស្ថានភាពបញ្ជិកា</label>
    <select name="registryStatus">
      <option value="">ជ្រើសរើសស្ថានភាព</option>
      <option value="ចេញបញ្ជិកា">ចេញបញ្ជិកា</option>
      <option value="មិនទាន់ចេញបញ្ជិកា">មិនទាន់ចេញបញ្ជិកា</option>
    </select>
  </div>

  <!-- 17. មូលហេតុ/ផ្សេងៗ -->
  <div class="form-group">
    <label>មូលហេតុ ឬផ្សេងៗ</label>
    <textarea name="reason" placeholder="បញ្ចូលមូលហេតុ ឬព័ត៌មានបន្ថែម"></textarea>
  </div>

  <!-- Buttons -->
  <div class="form-buttons">
    <button type="submit" class="btn-submit">រក្សាទុក</button>
    <button type="button" id="closeForm" class="btn-close">បិទ</button>
  </div>
</form>
  </div>

  <!-- View Popup -->
  <div id="viewPopup" class="popup">
    <div class="popup-content">
      <span class="close" onclick="closeView()">&times;</span>
      <h2>Document Summary</h2>
      <p><strong>ID:</strong> <span id="vId"></span></p>
      <p><strong>Name:</strong> <span id="vName"></span></p>
      <p><strong>Description:</strong> <span id="vDesc"></span></p>
      <p><strong>Date:</strong> <span id="vDate"></span></p>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:4000/doc";
    const form = document.getElementById("contactForm");
    const tableBody = document.getElementById("tableBody");
    const formModal = document.getElementById("myForm");
    const overlay = document.getElementById("overlay");
    const openBtn = document.getElementById("openForm");
    const closeBtn = document.getElementById("closeForm");
    const searchInput = document.getElementById("searchBox");
    let editingId = null;
    let allDocs = [];

    // === Open / Close Form ===
    openBtn.onclick = () => {
      formModal.style.display = 'block';
      overlay.style.display = 'block';
      form.reset();
      editingId = null;
    };
    closeBtn.onclick = overlay.onclick = () => {
      formModal.style.display = 'none';
      overlay.style.display = 'none';
    };

    // === Fetch Documents ===
    async function fetchDocument() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        allDocs = data.data || [];
        renderTable(allDocs);
      } catch (error) {
        console.error("Fetch Error:", error);
      }
    }
    

    // === Render Table ===
    function renderTable(docs) {
      tableBody.innerHTML = "";
      docs.forEach((doc) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${doc.no || '-'}</td> <!-- 1. លេខចូល -->
          <td>${doc.ir || '-'}</td> <!-- 2. លេខលិខិត(IR) -->
          <td>${doc.outNo || '-'}</td> <!-- 3. លេខចេញ -->
          <td>${doc.submitDate?.split("T")[0] || ''}</td> <!-- 4. ថ្ងៃខែលិខិតចូល/ចេញ -->
          <td>${doc.source || '-'}</td> <!-- 5. អង្គភាព/ប្រភពលិខិត -->
          <td>${doc.doc || '-'}</td> <!-- 6. ប្រភេទឯកសារ -->
          <td>${doc.officeDate2?.split("T")[0] || ''}</td> <!-- 7. ថ្ងៃខែមុខការិ.២ -->
          <td>${doc.officer || '-'}</td> <!-- 8. មន្រ្តីទទួលមុខការ -->
          <td>${doc.receiveDate?.split("T")[0] || ''}</td> <!-- 9. ថ្ងៃខែឆ្នាំទទួល -->
          <td>${doc.progress || '-'}</td> <!-- 10. មិនទាន់ធ្វើចេញ/បានធ្វើចេញរួចរាល់ -->
          <td>${doc.duration || '-'}</td> <!-- 11. ចំនួនថ្ងៃទាន់បានធ្វើចេញ -->
          <td>${doc.toChiefOffice || '-'}</td> <!-- 12. ចូលប្រធានការិ. -->
          <td>${doc.toDeputy || '-'}</td> <!-- 13. ចូលអនុ.នាយកដ្ឋាន -->
          <td>${doc.toHeadDept || '-'}</td> <!-- 14. ចូលប្រធាននាយកដ្ឋាន -->
          <td>${doc.outDate?.split("T")[0] || ''}</td> <!-- 15. ថ្ងៃខែឆ្នាំចេញលិខិត -->
          <td>${doc.registryStatus || '-'}</td> <!-- 16. ចេញបញ្ជិកា/មិនទាន់ចេញបញ្ជិកា -->
          <td>${doc.reason || '-'}</td> <!-- 17. មូលហេតុ/ផ្សេងៗ -->
          <td>
            <button onclick="viewDocument(
              '${doc.id}',
              '${doc.doc}',
              '${doc.source}',
              '${doc.submitDate?.split("T")[0] || ''}'
            )">View</button>
            <button class="editBtn">Edit</button>
            <button class="deleteBtn">Delete</button>
          </td>
        `;

        // Edit
        row.querySelector(".editBtn").onclick = () => openEditForm(doc);
        // Delete
        row.querySelector(".deleteBtn").onclick = () => deleteDoc(doc.id);
        tableBody.appendChild(row);
      });
    }

    // === Search Function ===
    searchInput.addEventListener("input", () => {
      const q = searchInput.value.toLowerCase();
      const filtered = allDocs.filter((d) =>
        [d.no, d.ir, d.source, d.doc, d.officer].some(v => v?.toLowerCase().includes(q))
      );
      renderTable(filtered);
    });

    // === Submit Form ===
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = Object.fromEntries(new FormData(form));
      const method = editingId ? "PUT" : "POST";
      const url = editingId ? `${API_URL}/${editingId}` : API_URL;

      try {
        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
        });
        if (res.ok) {
          alert(editingId ? "បានកែប្រែឯកសារ!" : "បានរក្សាទុកឯកសារថ្មី!");
          formModal.style.display = 'none';
          overlay.style.display = 'none';
          fetchDocument();
        } else alert("បញ្ហាក្នុងការរក្សាទុកឯកសារ!");
      } catch (err) {
        console.error("Save Error:", err);
      }
    });

    // === Edit ===
    function openEditForm(doc) {
      editingId = doc.id;
      formModal.style.display = 'block';
      overlay.style.display = 'block';
      Object.keys(form.elements).forEach((key) => {
        if (form.elements[key]?.name) {
          form.elements[key].value = doc[form.elements[key].name] || "";
        }
      });
    }

    // === Delete ===
    async function deleteDoc(id) {
      if (!confirm("តើអ្នកពិតជាចង់លុបឯកសារនេះមែនទេ?")) return;
      try {
        const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
        const data = await res.json();
        alert(data.message);
        fetchDocument();
      } catch (err) {
        console.error("Delete Error:", err);
      }
    }

    // === Export to Excel ===
    document.getElementById("exportExcelBtn").onclick = () => {
      const ws = XLSX.utils.json_to_sheet(allDocs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Documents");
      XLSX.writeFile(wb, "documents.xlsx");
    };

    // === View Popup ===
    function viewDocument(id, name, description, date) {
      document.getElementById('vId').textContent = id;
      document.getElementById('vName').textContent = name;
      document.getElementById('vDesc').textContent = description;
      document.getElementById('vDate').textContent = date;
      document.getElementById('viewPopup').style.display = 'flex';
    }
    function closeView() {
      document.getElementById('viewPopup').style.display = 'none';
    }

    window.addEventListener("DOMContentLoaded", fetchDocument);
  </script>
</body>
</html>