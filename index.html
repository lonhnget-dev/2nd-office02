<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document & Factory Management System</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    /* Custom styles to complement Bootstrap */
    :root {
      --primary-color: #3498db;
      --sidebar-width: 260px;
    }
    
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    /* Sidebar styling */
    .sidebar {
      width: var(--sidebar-width);
      min-width: var(--sidebar-width);
      background: #fff;
      color: #2c3e50;
      box-shadow: 2px 0 10px rgba(0,0,0,0.08);
      position: fixed;
      height: 100%;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
      border-right: 1px solid #e1e5e9;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }
    
    .navbar-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e1e5e9;
      margin-bottom: 1.5rem;
    }
    
    .navbar-links a {
      color: #5d6d7e;
      text-decoration: none;
      padding: 14px 25px;
      transition: all 0.3s;
      border-left: 4px solid transparent;
      white-space: nowrap;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .navbar-links a:hover,
    .navbar-links a.active {
      background: #f8f9fa;
      color: #2c3e50;
      border-left-color: var(--primary-color);
    }
    
    .navbar-links a.active {
      font-weight: 600;
    }
    
    /* Main content area */
    .main-container {
      margin-left: var(--sidebar-width);
      transition: margin-left 0.3s ease;
    }

    .main-container.expanded {
      margin-left: 0;
    }
    
    /* Page header */
    .page-header {
      background: #fff;
      color: #2c3e50;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    /* Control section */
    .control-section {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    /* Table styling */
    .table-container {
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .table-wrapper {
      overflow-x: auto;
      max-height: 70vh;
      overflow-y: auto;
    }
    
    .table-wrapper table {
      min-width: 1200px;
    }
    
    /* Status badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b8e0e6;
    }
    
    /* Role badges */
    .role-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .role-badge-admin {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid rgba(231, 76, 60, 0.3);
    }
    
    .role-badge-officer {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }
    
    /* Inspection Management Styles */
    .inspection-tabs {
      background: #fff;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
      overflow: hidden;
    }
    
    .inspection-tab {
      flex: 1;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .inspection-tab.active {
      background: #f8f9fa;
      border-bottom-color: var(--primary-color);
      font-weight: 600;
      color: var(--primary-color);
    }
    
    .inspection-tab:hover {
      background: #f8f9fa;
    }
    
    .inspection-content {
      display: none;
    }
    
    .inspection-content.active {
      display: block;
    }
    
    .penalty-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .penalty-options {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }
    
    .penalty-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border: 2px solid #d1d9e6;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8f9fa;
    }
    
    .penalty-option.selected {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }
    
    .penalty-details {
      display: none;
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-top: 15px;
      border: 1px solid #e1e5e9;
    }
    
    .penalty-details.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    .company-info-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      border: 1px solid #e1e5e9;
    }
    
    .followup-info {
      background: #e8f5e8;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border-left: 4px solid #2ecc71;
    }
    
    /* Detail view styling */
    .detail-view p {
      margin-bottom: 14px;
      line-height: 1.7;
      border-bottom: 1px dashed #e1e5e9;
      padding-bottom: 10px;
      display: flex;
    }
    
    .detail-view strong {
      display: inline-block;
      width: 180px;
      color: #5d6d7e;
      font-weight: 600;
    }
    
    .detail-view span {
      color: #2c3e50;
      flex: 1;
    }
    
    /* Loading spinner */
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 900px) {
      .sidebar {
        width: 280px;
        transform: translateX(-280px);
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .sidebar.hidden {
        width: 280px;
        min-width: 280px;
        transform: translateX(-280px);
      }
      
      .main-container {
        margin-left: 0;
        padding-top: 70px;
      }
      
      .inspection-tabs {
        flex-direction: column;
      }
      
      .penalty-options {
        flex-direction: column;
      }
      
      .penalty-option {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="btn btn-light position-fixed d-lg-none" id="menuToggle" style="top: 20px; left: 20px; z-index: 1001;">
    <i class="bi bi-list"></i> Menu
  </button>
  
  <button class="btn btn-light position-fixed d-none" id="showSidebar" style="top: 20px; left: 20px; z-index: 10000;">
    <i class="bi bi-list"></i> Show Menu
  </button>

  <!-- Sidebar Navigation -->
  <nav class="sidebar" id="sidebar">
    <div class="navbar-header">
      <div class="navbar-brand fw-bold fs-5">
        <i class="bi bi-folder"></i> ប្រព័ន្ធគ្រប់គ្រង
      </div>
      <button class="btn btn-sm btn-outline-secondary" id="hideSidebar" title="Hide Sidebar">
        <i class="bi bi-chevron-left"></i>
      </button>
    </div>
    <div class="navbar-links">
      <a href="#" class="active" onclick="showSection('documents', event)">
        <i class="bi bi-file-earmark"></i>
        <span>ឯកសារ</span>
      </a>
      <a href="#" onclick="showSection('inspectionmanagement', event)">
        <i class="bi bi-search"></i>
        <span>គ្រប់គ្រងអធិការកិច្ច</span>
      </a>
      <a href="#" onclick="showSection('factories', event)">
        <i class="bi bi-building"></i>
        <span>រោងចក្រ</span>
      </a>
      <a href="#" onclick="showSection('users', event)">
        <i class="bi bi-people"></i>
        <span>អ្នកប្រើប្រាស់</span>
      </a>
    </div>
  </nav>

  <!-- Main Content Area -->
  <div class="main-container container-fluid p-3" id="mainContainer">
    
    <!-- Documents Section -->
    <section id="documents-section">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-folder"></i> ប្រព័ន្ធគ្រប់គ្រងឯកសារ</h1>
        <p class="text-muted mb-0">Document Management System</p>
      </header>

      <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <button class="btn btn-primary" id="openDocForm">
          <i class="bi bi-plus-circle"></i> បញ្ចូលឯកសារថ្មី
        </button>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <select class="form-select" id="showCount" style="width: auto;">
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="100">100</option>
            <option value="all">All</option>
          </select>
          <input type="search" class="form-control" id="docSearch" placeholder="ស្វែងរកឯកសារ..." style="width: auto;">
          <button class="btn btn-outline-secondary" id="exportDocExcel">
            <i class="bi bi-download"></i> ទាញយក Excel
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table class="table table-hover mb-0" id="documentTable">
            <thead class="table-light">
              <tr>
                <th>លេខចូល</th>
                <th>លេខលិខិត (IR)</th>
                <th>លេខចេញ</th>
                <th>ថ្ងៃខែលិខិត</th>
                <th>អង្គភាព</th>
                <th>ប្រភេទឯកសារ</th>
                <th>មន្រ្តីទទួល</th>
                <th>ស្ថានភាព</th>
                <th>សកម្មភាព</th>
              </tr>
            </thead>
            <tbody id="docTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Inspection Management Section -->
    <section id="inspectionmanagement-section" style="display: none;">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-search"></i> គ្រប់គ្រងអធិការកិច្ច</h1>
        <p class="text-muted mb-0">Inspection Management System</p>
      </header>

      <!-- Inspection Tabs -->
      <div class="inspection-tabs d-flex">
        <div class="inspection-tab active" onclick="showInspectionTab('initial')">
          <i class="bi bi-clipboard"></i>
          <span>ការត្រួតពិនិត្យដំបូង</span>
        </div>
        <div class="inspection-tab" onclick="showInspectionTab('followup')">
          <i class="bi bi-arrow-repeat"></i>
          <span>តាមដានកំហិត</span>
        </div>
      </div>

      <!-- Initial Inspection Tab -->
      <div class="inspection-content active" id="initial-inspection">
        <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <button class="btn btn-primary" id="openInspectionForm">
            <i class="bi bi-plus-circle"></i> ការត្រួតពិនិត្យថ្មី
          </button>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="search" class="form-control" id="inspectionSearch" placeholder="ស្វែងរកការត្រួតពិនិត្យ..." style="width: auto;">
            <button class="btn btn-outline-secondary" id="exportInspectionExcel">
              <i class="bi bi-download"></i> ទាញយក Excel
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table class="table table-hover mb-0" id="inspectionTable">
              <thead class="table-light">
                <tr>
                  <th>លេខចូល</th>
                  <th>រោងចក្រ</th>
                  <th>កាលបរិច្ឆេទ</th>
                  <th>កំហិត</th>
                  <th>ផាក</th>
                  <th>ស្ថានភាព</th>
                  <th>សកម្មភាព</th>
                </tr>
              </thead>
              <tbody id="inspectionTableBody">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Follow-up Inspection Tab -->
      <div class="inspection-content" id="followup-inspection">
        <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
          <button class="btn btn-primary" id="openFollowupForm">
            <i class="bi bi-plus-circle"></i> តាមដានកំហិតថ្មី
          </button>
          <div class="d-flex flex-wrap gap-2 align-items-center">
            <input type="search" class="form-control" id="followupSearch" placeholder="ស្វែងរកការតាមដាន..." style="width: auto;">
            <button class="btn btn-outline-secondary" id="exportFollowupExcel">
              <i class="bi bi-download"></i> ទាញយក Excel
            </button>
          </div>
        </div>

        <div class="table-container">
          <div class="table-wrapper">
            <table class="table table-hover mb-0" id="followupTable">
              <thead class="table-light">
                <tr>
                  <th>លេខចូល</th>
                  <th>រោងចក្រ</th>
                  <th>កាលបរិច្ឆេទតាមដាន</th>
                  <th>កាលបរិច្ឆេទកំហិតដើម</th>
                  <th>ស្ថានភាពតាមដាន</th>
                  <th>សកម្មភាព</th>
                </tr>
              </thead>
              <tbody id="followupTableBody">
                <!-- Data will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Factories Section -->
    <section id="factories-section" style="display: none;">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-building"></i> ប្រព័ន្ធគ្រប់គ្រងរោងចក្រ</h1>
        <p class="text-muted mb-0">Factory Management System</p>
      </header>

      <!-- Compact Import Section -->
      <div class="import-section bg-white p-3 rounded mb-3 shadow-sm border">
        <div class="import-header d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2 mb-3">
          <h5 class="mb-0"><i class="bi bi-upload"></i> នាំចូលទិន្នន័យរោងចក្រ</h5>
          <div class="import-controls d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="selectFileBtn">
              <i class="bi bi-folder"></i> ជ្រើសរើសឯកសារ
            </button>
            <button class="btn btn-sm btn-outline-secondary" id="downloadTemplateBtn">
              <i class="bi bi-download"></i> ទាញយកគំរូ
            </button>
            <button class="btn btn-sm btn-primary" id="importBtn" disabled>
              <i class="bi bi-upload"></i> នាំចូល
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" class="d-none" accept=".xlsx,.xls,.csv">
        <div class="file-info d-none alert alert-info py-2" id="fileInfo" role="alert">
          <strong>ឯកសារ:</strong> <span id="fileName">-</span> | 
          <strong>ទំហំ:</strong> <span id="fileSize">-</span>
        </div>
      </div>

      <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <button class="btn btn-primary" id="openFactoryForm">
          <i class="bi bi-plus-circle"></i> បញ្ចូលរោងចក្រថ្មី
        </button>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <input type="search" class="form-control" id="factorySearch" placeholder="ស្វែងរករោងចក្រ..." style="width: auto;">
          <button class="btn btn-outline-secondary" id="exportFactoryExcel">
            <i class="bi bi-download"></i> ទាញយក Excel
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table class="table table-hover mb-0" id="factoryTable">
            <thead class="table-light">
              <tr>
                <th>លេខចូល</th>
                <th>ឈ្មោះរោងចក្រ</th>
                <th>ឈ្មោះរោងចក្រ (EN)</th>
                <th>Sector</th>
                <th>ភូមិ</th>
                <th>ឃុំ</th>
                <th>ស្រុក</th>
                <th>ខេត្ត</th>
                <th>កម្មករសរុប</th>
                <th>កម្មករស្រី</th>
                <th>សកម្មភាព</th>
              </tr>
            </thead>
            <tbody id="factoryTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Users Section -->
    <section id="users-section" style="display: none;">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-people"></i> ការគ្រប់គ្រងអ្នកប្រើប្រាស់</h1>
        <p class="text-muted mb-0">User Management System</p>
      </header>

      <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <button class="btn btn-primary" id="openUserForm">
          <i class="bi bi-plus-circle"></i> បញ្ចូលអ្នកប្រើប្រាស់ថ្មី
        </button>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <input type="search" class="form-control" id="userSearch" placeholder="ស្វែងរកអ្នកប្រើប្រាស់..." style="width: auto;">
          <button class="btn btn-outline-secondary" id="exportUserExcel">
            <i class="bi bi-download"></i> ទាញយក Excel
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table class="table table-hover mb-0" id="userTable">
            <thead class="table-light">
              <tr>
                <th>ឈ្មោះ</th>
                <th>ទូរស័ព្ទ</th>
                <th>អ៊ីមែល</th>
                <th>តួនាទី</th>
                <th>មុខងារ</th>
                <th>សង្កាត់</th>
                <th>សកម្មភាព</th>
              </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Document Modal -->
  <div class="modal fade" id="docModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="docModalTitle">បញ្ចូលឯកសារថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="docForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">លេខលិខិត(IR) *</label>
                <input type="text" class="form-control" name="ir" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">លេខចេញ</label>
                <input type="text" class="form-control" name="outNo">
              </div>
              <div class="col-md-6">
                <label class="form-label">ថ្ងៃខែលិខិត</label>
                <input type="date" class="form-control" name="submitDate">
              </div>
              <div class="col-12">
                <label class="form-label">អង្គភាព/ប្រភពលិខិត</label>
                <input type="text" class="form-control" name="source">
              </div>
              <div class="col-md-6">
                <label class="form-label">ប្រភេទឯកសារ</label>
                <input type="text" class="form-control" name="doc">
              </div>
              <div class="col-md-6">
                <label class="form-label">មន្រ្តីទទួល</label>
                <input type="text" class="form-control" name="officer">
              </div>
              <div class="col-md-6">
                <label class="form-label">ស្ថានភាព</label>
                <select class="form-select" name="progress">
                  <option value="">ជ្រើសរើស</option>
                  <option value="មិនទាន់ធ្វើចេញ">មិនទាន់ធ្វើចេញ</option>
                  <option value="បានធ្វើចេញ">បានធ្វើចេញ</option>
                </select>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="docSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Factory Modal -->
  <div class="modal fade" id="factoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="factoryModalTitle">បញ្ចូលរោងចក្រថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="factoryForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ឈ្មោះរោងចក្រ *</label>
                <input type="text" class="form-control" name="factoryname" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ឈ្មោះរោងចក្រ (EN) *</label>
                <input type="text" class="form-control" name="factoryname_en" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">Sector *</label>
                <input type="text" class="form-control" name="sector" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ភូមិ *</label>
                <input type="text" class="form-control" name="village" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ឃុំ *</label>
                <input type="text" class="form-control" name="commune" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ស្រុក *</label>
                <input type="text" class="form-control" name="district" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ខេត្ត *</label>
                <input type="text" class="form-control" name="province" required>
              </div>
              <div class="col-12">
                <label class="form-label">អាសយដ្ឋាន *</label>
                <input type="text" class="form-control" name="address" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">កម្មករសរុប *</label>
                <input type="number" class="form-control" name="total_workers" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">កម្មករស្រី *</label>
                <input type="number" class="form-control" name="female_workers" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ឈ្មោះអ្នកគ្រប់គ្រង *</label>
                <input type="text" class="form-control" name="admin_name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">លេខទូរស័ព្ទ *</label>
                <input type="text" class="form-control" name="admin_phone" required>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="factorySubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="userModalTitle">បញ្ចូលអ្នកប្រើប្រាស់ថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">ឈ្មោះ *</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ទូរស័ព្ទ *</label>
                <input type="text" class="form-control" name="phone" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">អ៊ីមែល *</label>
                <input type="email" class="form-control" name="email" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ពាក្យសម្ងាត់ *</label>
                <input type="password" class="form-control" name="password" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">តួនាទី *</label>
                <select class="form-select" name="role" required>
                  <option value="">-- ជ្រើសរើសតួនាទី --</option>
                  <option value="admin">អ្នកគ្រប់គ្រង</option>
                  <option value="officer">មន្ត្រី</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">មុខងារ *</label>
                <input type="text" class="form-control" name="function" required>
              </div>
              <div class="col-12">
                <label class="form-label">សង្កាត់ *</label>
                <input type="text" class="form-control" name="sangkat" required>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="userSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Inspection Management Modals -->
  <!-- Initial Inspection Modal -->
  <div class="modal fade" id="inspectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="inspectionModalTitle">ការត្រួតពិនិត្យថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="inspectionForm">
            <div class="row g-3">
              <!-- Basic Information -->
              <div class="col-md-4">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ក្រុម *</label>
                <select class="form-select" name="group" required>
                  <option value="">-- ជ្រើសរើសក្រុម --</option>
                  <option value="ក្រុម ក">ក្រុម ក</option>
                  <option value="ក្រុម ខ">ក្រុម ខ</option>
                  <option value="ក្រុម គ">ក្រុម គ</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">កាលបរិច្ឆេទត្រួតពិនិត្យ *</label>
                <input type="date" class="form-control" name="inspection_date" required>
              </div>

              <!-- Company Information Section -->
              <div class="col-12">
                <div class="company-info-section">
                  <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">ឈ្មោះរោងចក្រ *</label>
                      <select class="form-select" name="factory_name" required onchange="updateFactoryInfo()">
                        <option value="">-- ជ្រើសរើសរោងចក្រ --</option>
                        <option value="រោងចក្រ ក" data-sector="វិស័យ ក" data-village="ភូមិ ក" data-commune="ឃុំ ក" data-district="ស្រុក ក" data-province="ខេត្ត ក">រោងចក្រ ក</option>
                        <option value="រោងចក្រ ខ" data-sector="វិស័យ ខ" data-village="ភូមិ ខ" data-commune="ឃុំ ខ" data-district="ស្រុក ខ" data-province="ខេត្ត ខ">រោងចក្រ ខ</option>
                        <option value="រោងចក្រ គ" data-sector="វិស័យ គ" data-village="ភូមិ គ" data-commune="ឃុំ គ" data-district="ស្រុក គ" data-province="ខេត្ត គ">រោងចក្រ គ</option>
                      </select>
                    </div>
                    
                    <div class="col-md-4">
                      <label class="form-label">វិស័យ *</label>
                      <input type="text" class="form-control" name="sector" required placeholder="បញ្ចូលវិស័យ...">
                    </div>
                    
                    <div class="col-md-4">
                      <label class="form-label">ប្រធានបទ *</label>
                      <input type="text" class="form-control" name="case_subject" required placeholder="បញ្ចូលប្រធានបទ...">
                    </div>
                  </div>
                  
                  <!-- Address Fields -->
                  <div class="row g-3 mt-2">
                    <div class="col-md-3">
                      <label class="form-label">ភូមិ *</label>
                      <input type="text" class="form-control" name="village" required placeholder="បញ្ចូលភូមិ...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ឃុំ *</label>
                      <input type="text" class="form-control" name="commune" required placeholder="បញ្ចូលឃុំ...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ស្រុក *</label>
                      <input type="text" class="form-control" name="district" required placeholder="បញ្ចូលស្រុក...">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ខេត្ត *</label>
                      <input type="text" class="form-control" name="province" required placeholder="បញ្ចូលខេត្ត...">
                    </div>
                  </div>
                </div>
              </div>

              <!-- កំហិត Section -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-exclamation-triangle"></i> កំហិត (អ្វីដែលរោងចក្រត្រូវកែលម្អ)</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="penalty_yes_option">
                      <input type="radio" name="has_penalty" value="មាន" onchange="togglePenaltyDetails(true)">
                      <span>មាន</span>
                    </label>
                    <label class="penalty-option" id="penalty_no_option">
                      <input type="radio" name="has_penalty" value="គ្មាន" onchange="togglePenaltyDetails(false)">
                      <span>គ្មាន</span>
                    </label>
                  </div>
                  
                  <div class="penalty-details" id="penalty_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">បែបបទ</label>
                        <input type="text" class="form-control" name="penalty_format" placeholder="បញ្ចូលបែបបទកំហិត...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">លក្ខខណ្ឌ</label>
                        <input type="text" class="form-control" name="penalty_condition" placeholder="បញ្ចូលលក្ខខណ្ឌកំហិត...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">សុខភាពនិងសុវត្ថភាព</label>
                        <textarea class="form-control" name="penalty_health" rows="3" placeholder="បញ្ចូលព័ត៌មានសុខភាពនិងសុវត្ថភាព..."></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">វិជ្ជាជីវៈ</label>
                        <textarea class="form-control" name="penalty_professional" rows="3" placeholder="បញ្ចូលព័ត៌មានវិជ្ជាជីវៈ..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- ផាក Section -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-cash-coin"></i> ផាក</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="fine_yes_option">
                      <input type="radio" name="has_fine" value="មាន" onchange="toggleFineDetails(true)">
                      <span>មាន</span>
                    </label>
                    <label class="penalty-option" id="fine_no_option">
                      <input type="radio" name="has_fine" value="គ្មាន" onchange="toggleFineDetails(false)">
                      <span>គ្មាន</span>
                    </label>
                  </div>
                  
                  <div class="penalty-details" id="fine_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">ចំនួនទឹកប្រាក់</label>
                        <input type="text" class="form-control" name="fine_amount" placeholder="បញ្ចូលចំនួនទឹកប្រាក់...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">ប្រភេទផាក</label>
                        <input type="text" class="form-control" name="fine_type" placeholder="បញ្ចូលប្រភេទផាក...">
                      </div>
                      <div class="col-12">
                        <label class="form-label">ហេតុផល</label>
                        <textarea class="form-control" name="fine_reason" rows="3" placeholder="បញ្ចូលហេតុផលផាក..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">ផ្សេងៗ</label>
                <textarea class="form-control" name="remarks" rows="3" placeholder="បញ្ចូលផ្សេងៗ..."></textarea>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="inspectionSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Follow-up Inspection Modal -->
  <div class="modal fade" id="followupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="followupModalTitle">តាមដានកំហិតថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="followupForm">
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">លេខចូល *</label>
                <input type="text" class="form-control" name="no" required>
              </div>
              <div class="col-md-4">
                <label class="form-label">ការត្រួតពិនិត្យដើម *</label>
                <select class="form-select" name="original_inspection" id="originalInspectionSelect" required onchange="loadOriginalInspectionData()">
                  <option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>
                </select>
              </div>
              <div class="col-md-4">
                <label class="form-label">កាលបរិច្ឆេទតាមដាន *</label>
                <input type="date" class="form-control" name="followup_date" required>
              </div>
              
              <!-- Company Information Display (Read-only) -->
              <div class="col-12">
                <div class="company-info-section d-none" id="companyInfoDisplay">
                  <h5 class="mb-3"><i class="bi bi-building"></i> ព័ត៌មានរោងចក្រ</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">ឈ្មោះរោងចក្រ</label>
                      <input type="text" class="form-control" id="display_factory_name" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">វិស័យ</label>
                      <input type="text" class="form-control" id="display_sector" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">ប្រធានបទ</label>
                      <input type="text" class="form-control" id="display_case_subject" readonly style="background: #f8f9fa;">
                    </div>
                  </div>
                  
                  <div class="row g-3 mt-2">
                    <div class="col-md-3">
                      <label class="form-label">ភូមិ</label>
                      <input type="text" class="form-control" id="display_village" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ឃុំ</label>
                      <input type="text" class="form-control" id="display_commune" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ស្រុក</label>
                      <input type="text" class="form-control" id="display_district" readonly style="background: #f8f9fa;">
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">ខេត្ត</label>
                      <input type="text" class="form-control" id="display_province" readonly style="background: #f8f9fa;">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Original Penalty Information (Read-only) -->
              <div class="col-12">
                <div id="originalPenaltyInfo" class="followup-info d-none">
                  <h5 class="mb-2">កំហិតដើម</h5>
                  <div id="penaltyDisplay"></div>
                </div>
              </div>

              <!-- Follow-up Result -->
              <div class="col-12">
                <div class="penalty-section">
                  <h5 class="mb-3"><i class="bi bi-clipboard-check"></i> លទ្ធផលតាមដាន</h5>
                  <div class="penalty-options">
                    <label class="penalty-option" id="implemented_yes_option">
                      <input type="radio" name="penalty_implemented" value="អនុវត្ត" onchange="toggleFollowupDetails(false)">
                      <span>អនុវត្ត</span>
                    </label>
                    <label class="penalty-option" id="implemented_no_option">
                      <input type="radio" name="penalty_implemented" value="មិនអនុវត្ត" onchange="toggleFollowupDetails(true)">
                      <span>មិនអនុវត្ត</span>
                    </label>
                  </div>
                  
                  <div class="penalty-details" id="followup_details">
                    <div class="row g-3">
                      <div class="col-md-6">
                        <label class="form-label">បែបបទ</label>
                        <input type="text" class="form-control" name="followup_format" placeholder="បញ្ចូលបែបបទតាមដាន...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">លក្ខខណ្ឌ</label>
                        <input type="text" class="form-control" name="followup_condition" placeholder="បញ្ចូលលក្ខខណ្ឌតាមដាន...">
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">សុខភាពនិងសុវត្ថភាព</label>
                        <textarea class="form-control" name="followup_health" rows="3" placeholder="បញ្ចូលព័ត៌មានសុខភាពនិងសុវត្ថភាពតាមដាន..."></textarea>
                      </div>
                      <div class="col-md-6">
                        <label class="form-label">វិជ្ជាជីវៈ</label>
                        <textarea class="form-control" name="followup_professional" rows="3" placeholder="បញ្ចូលព័ត៌មានវិជ្ជាជីវៈតាមដាន..."></textarea>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <label class="form-label">សេចក្តីសន្និដ្ឋាន</label>
                <textarea class="form-control" name="conclusion" rows="3" placeholder="បញ្ចូលសេចក្តីសន្និដ្ឋាន..."></textarea>
              </div>
            </div>
            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="followupSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View Modals -->
  <div class="modal fade" id="viewDocModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">ព័ត៌មានលម្អិតឯកសារ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="docDetail" class="detail-view"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewFactoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">ព័ត៌មានលម្អិតរោងចក្រ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="factoryDetail" class="detail-view"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">ព័ត៌មានលម្អិតអ្នកប្រើប្រាស់</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="userDetail" class="detail-view"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewInspectionModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">ព័ត៌មានលម្អិតការត្រួតពិនិត្យ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="inspectionDetail" class="detail-view"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="viewFollowupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title">ព័ត៌មានលម្អិតតាមដានកំហិត</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="followupDetail" class="detail-view"></div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ (Close)</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Message Box/Confirmation Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="messageTitle">Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="messageText"></p>
        </div>
        <div class="modal-footer" id="messageButtons">
          <!-- Buttons inserted by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // API URLs - Using your working server
    const DOC_API = "https://uat-api-office2.thithabirdnest.com/doc";
    const FACTORY_API = "https://uat-api-office2.thithabirdnest.com/fac";
    const USER_API = "https://uat-api-office2.thithabirdnest.com/user";
    
    // Global variables
    let allDocs = [], allFactories = [], allUsers = [];
    let allInspections = [], allFollowups = [];
    let currentEditingId = null;
    let selectedFile = null;

    // DOM Elements
    const body = document.body;
    const sidebar = document.getElementById('sidebar');
    const mainContainer = document.getElementById('mainContainer');
    const menuToggle = document.getElementById('menuToggle');
    const hideSidebarBtn = document.getElementById('hideSidebar');
    const showSidebarBtn = document.getElementById('showSidebar');
    
    // Import elements
    const fileInput = document.getElementById('fileInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const importBtn = document.getElementById('importBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    // Message/Confirmation box elements
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const messageButtons = document.getElementById('messageButtons');

    // --- Simple Sidebar Toggle Functions ---
    function hideSidebar() {
      sidebar.classList.add('hidden');
      mainContainer.classList.add('expanded');
      showSidebarBtn.classList.remove('d-none');
    }

    function showSidebar() {
      sidebar.classList.remove('hidden');
      mainContainer.classList.remove('expanded');
      showSidebarBtn.classList.add('d-none');
    }

    // Event listeners for sidebar buttons
    hideSidebarBtn.addEventListener('click', hideSidebar);
    showSidebarBtn.addEventListener('click', showSidebar);

    // Mobile menu toggle
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // --- Navigation and Section Switching ---
    function showSection(section, event) {
      if (event) event.preventDefault();
      
      // Hide sidebar on mobile
      if (sidebar.classList.contains('open') && window.innerWidth <= 900) {
          sidebar.classList.remove('open');
      }
      
      // Hide all main content sections
      document.getElementById('documents-section').style.display = 'none';
      document.getElementById('inspectionmanagement-section').style.display = 'none';
      document.getElementById('factories-section').style.display = 'none';
      document.getElementById('users-section').style.display = 'none';

      // Update active nav link
      document.querySelectorAll('.navbar-links a').forEach(a => a.classList.remove('active'));
      const activeLink = document.querySelector(`.navbar-links a[onclick*="${section}"]`);
      if (activeLink) activeLink.classList.add('active');

      // Show selected section
      if (section === 'documents') {
        document.getElementById('documents-section').style.display = 'block';
        fetchDocuments();
      } else if (section === 'inspectionmanagement') {
        document.getElementById('inspectionmanagement-section').style.display = 'block';
        loadSampleInspectionData();
      } else if (section === 'factories') {
        document.getElementById('factories-section').style.display = 'block';
        fetchFactories();
      } else if (section === 'users') {
        document.getElementById('users-section').style.display = 'block';
        fetchUsers();
      }
    }

    // Modal functions
    function openModal(modalId) {
      const modalElement = document.getElementById(modalId);
      const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
      modal.show();
    }

    function closeModal(modalId) {
      const modalElement = document.getElementById(modalId);
      const modal = bootstrap.Modal.getInstance(modalElement);
      modal.hide();
      currentEditingId = null; // Reset editing state on close
    }

    // --- Custom Message/Confirmation Functions ---
    function openMessageModal(title, text, type, callback) {
      messageTitle.textContent = title;
      messageText.textContent = text;
      messageButtons.innerHTML = '';
      
      if (type === 'confirm') {
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.innerHTML = '<i class="bi bi-check-lg"></i> Yes';
        confirmBtn.onclick = () => {
          callback(true);
          messageModal.hide();
        };
        messageButtons.appendChild(confirmBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn btn-secondary';
        cancelBtn.innerHTML = '<i class="bi bi-x-lg"></i> Cancel';
        cancelBtn.onclick = () => {
          callback(false);
          messageModal.hide();
        };
        messageButtons.appendChild(cancelBtn);
        
      } else {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn btn-primary';
        closeBtn.innerHTML = '<i class="bi bi-check-lg"></i> OK';
        closeBtn.onclick = () => messageModal.hide();
        messageButtons.appendChild(closeBtn);
      }
      
      messageModal.show();
    }
    
    function showMessage(message, title = 'Information') {
        openMessageModal(title, message, 'info', () => {});
    }

    // --- Inspection Management Functions ---
    function showInspectionTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.inspection-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Remove active class from all tabs
      document.querySelectorAll('.inspection-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      
      // Show selected tab content
      document.getElementById(`${tabName}-inspection`).classList.add('active');
      
      // Activate selected tab
      event.target.classList.add('active');
      
      // Load appropriate data
      if (tabName === 'initial') {
        renderInspections();
      } else if (tabName === 'followup') {
        renderFollowups();
      }
    }

    // Penalty Management Functions
    function togglePenaltyDetails(showDetails) {
      const detailsElement = document.getElementById('penalty_details');
      const yesOption = document.getElementById('penalty_yes_option');
      const noOption = document.getElementById('penalty_no_option');
      
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
        clearPenaltyDetails();
      }
    }
    
    function toggleFineDetails(showDetails) {
      const detailsElement = document.getElementById('fine_details');
      const yesOption = document.getElementById('fine_yes_option');
      const noOption = document.getElementById('fine_no_option');
      
      if (showDetails) {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.remove('active');
        clearFineDetails();
      }
    }
    
    function toggleFollowupDetails(showDetails) {
      const detailsElement = document.getElementById('followup_details');
      const yesOption = document.getElementById('implemented_yes_option');
      const noOption = document.getElementById('implemented_no_option');
      
      if (showDetails) {
        yesOption.classList.remove('selected');
        noOption.classList.add('selected');
        detailsElement.classList.add('active');
      } else {
        yesOption.classList.add('selected');
        noOption.classList.remove('selected');
        detailsElement.classList.remove('active');
        clearFollowupDetails();
      }
    }
    
    function clearPenaltyDetails() {
      const form = document.getElementById('inspectionForm');
      const fields = ['penalty_format', 'penalty_condition', 'penalty_health', 'penalty_professional'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }
    
    function clearFineDetails() {
      const form = document.getElementById('inspectionForm');
      const fields = ['fine_amount', 'fine_type', 'fine_reason'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }
    
    function clearFollowupDetails() {
      const form = document.getElementById('followupForm');
      const fields = ['followup_format', 'followup_condition', 'followup_health', 'followup_professional'];
      fields.forEach(field => {
        if (form.elements[field]) form.elements[field].value = '';
      });
    }

    // Function to update factory information when company is selected
    function updateFactoryInfo() {
      const select = document.querySelector('select[name="factory_name"]');
      const selectedOption = select.options[select.selectedIndex];
      
      if (selectedOption.value) {
        // Auto-fill the address fields from data attributes
        document.querySelector('input[name="sector"]').value = selectedOption.getAttribute('data-sector') || '';
        document.querySelector('input[name="village"]').value = selectedOption.getAttribute('data-village') || '';
        document.querySelector('input[name="commune"]').value = selectedOption.getAttribute('data-commune') || '';
        document.querySelector('input[name="district"]').value = selectedOption.getAttribute('data-district') || '';
        document.querySelector('input[name="province"]').value = selectedOption.getAttribute('data-province') || '';
      }
    }

    // Enhanced function to load original inspection data for follow-up
    function loadOriginalInspectionData() {
      const select = document.getElementById('originalInspectionSelect');
      const inspectionId = select.value;
      const infoDiv = document.getElementById('originalPenaltyInfo');
      const companyInfoDiv = document.getElementById('companyInfoDisplay');
      const penaltyDisplay = document.getElementById('penaltyDisplay');
      
      if (inspectionId) {
        const inspection = allInspections.find(i => i.id.toString() === inspectionId);
        if (inspection) {
          // Display company information
          document.getElementById('display_factory_name').value = inspection.factory_name || '';
          document.getElementById('display_sector').value = inspection.sector || '';
          document.getElementById('display_case_subject').value = inspection.case_subject || '';
          document.getElementById('display_village').value = inspection.village || '';
          document.getElementById('display_commune').value = inspection.commune || '';
          document.getElementById('display_district').value = inspection.district || '';
          document.getElementById('display_province').value = inspection.province || '';
          companyInfoDiv.classList.remove('d-none');
          
          // Display penalty information if exists
          if (inspection.has_penalty === 'មាន') {
            penaltyDisplay.innerHTML = `
              <p><strong>បែបបទ:</strong> ${inspection.penalty_format || 'N/A'}</span></p>
              <p><strong>លក្ខខណ្ឌ:</strong> ${inspection.penalty_condition || 'N/A'}</span></p>
              <p><strong>សុខភាពនិងសុវត្ថភាព:</strong> ${inspection.penalty_health || 'N/A'}</span></p>
              <p><strong>វិជ្ជាជីវៈ:</strong> ${inspection.penalty_professional || 'N/A'}</span></p>
            `;
            infoDiv.classList.remove('d-none');
          } else {
            infoDiv.classList.add('d-none');
            showMessage('ការត្រួតពិនិត្យដើមនេះមិនមានកំហិតទេ', 'Info');
          }
        }
      } else {
        companyInfoDiv.classList.add('d-none');
        infoDiv.classList.add('d-none');
      }
    }

    // Populate original inspection dropdown
    function populateOriginalInspections() {
      const select = document.getElementById('originalInspectionSelect');
      select.innerHTML = '<option value="">-- ជ្រើសរើសការត្រួតពិនិត្យដើម --</option>';
      
      allInspections.filter(inspection => inspection.has_penalty === 'មាន').forEach(inspection => {
        const option = document.createElement('option');
        option.value = inspection.id;
        option.textContent = `${inspection.no} - ${inspection.factory_name} (${inspection.inspection_date})`;
        select.appendChild(option);
      });
    }

    // Enhanced inspection rendering with new fields
    function renderInspections() {
      const tbody = document.getElementById('inspectionTableBody');
      tbody.innerHTML = allInspections.map(inspection => `
        <tr>
          <td>${inspection.no || ''}</td>
          <td>
            <div>
              <strong>${inspection.factory_name || ''}</strong>
              <div class="text-muted small">
                <div>វិស័យ: ${inspection.sector || ''}</div>
                <div>ប្រធានបទ: ${inspection.case_subject || ''}</div>
              </div>
            </div>
          </td>
          <td>${inspection.inspection_date || ''}</td>
          <td>
            <span class="status-badge ${inspection.has_penalty === 'មាន' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_penalty || 'គ្មាន'}
            </span>
          </td>
          <td>
            <span class="status-badge ${inspection.has_fine === 'មាន' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_fine || 'គ្មាន'}
            </span>
          </td>
          <td>
            <span class="status-badge ${inspection.has_penalty === 'មាន' ? 'status-pending' : 'status-completed'}">
              ${inspection.has_penalty === 'មាន' ? 'ត្រូវតាមដាន' : 'បានបញ្ចប់'}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewInspection('${inspection.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-secondary" onclick="editInspection('${inspection.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteInspectionConfirm('${inspection.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function renderFollowups() {
      const tbody = document.getElementById('followupTableBody');
      tbody.innerHTML = allFollowups.map(followup => {
        const original = followup.original_inspection_data || {};
        return `
        <tr>
          <td>${followup.no || ''}</td>
          <td>${original.factory_name || ''}</td>
          <td>${followup.followup_date || ''}</td>
          <td>${original.inspection_date || ''}</td>
          <td>
            <span class="status-badge ${followup.penalty_implemented === 'អនុវត្ត' ? 'status-completed' : 'status-pending'}">
              ${followup.penalty_implemented || 'N/A'}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewFollowup('${followup.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-secondary" onclick="editFollowup('${followup.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteFollowupConfirm('${followup.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `}).join('');
    }

    // Form Submission Handlers for Inspection Management
    document.getElementById('inspectionForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.factory_name || !data.group || !data.inspection_date || !data.sector || !data.case_subject) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('inspectionSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allInspections.findIndex(i => i.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allInspections[index] = { ...allInspections[index], ...data, id: currentEditingId };
          }
          showMessage('ការត្រួតពិនិត្យត្រូវបានកែសម្រួលដោយជោគជ័យ!', 'Success');
        } else {
          const newInspection = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allInspections.push(newInspection);
          showMessage('ការត្រួតពិនិត្យត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
        }
        
        closeModal('inspectionModal');
        renderInspections();
        populateOriginalInspections();
      } catch (error) {
        console.error('Save error:', error);
        showMessage('មានបញ្ហាក្នុងការរក្សាទុកការត្រួតពិនិត្យ', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    document.getElementById('followupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.original_inspection || !data.followup_date) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('followupSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allFollowups.findIndex(i => i.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allFollowups[index] = { ...allFollowups[index], ...data, id: currentEditingId };
          }
          showMessage('ការតាមដានត្រូវបានកែសម្រួលដោយជោគជ័យ!', 'Success');
        } else {
          const originalInspection = allInspections.find(i => i.id.toString() === data.original_inspection);
          const newFollowup = {
            id: Date.now(),
            ...data,
            original_inspection_data: originalInspection,
            created_at: new Date().toISOString()
          };
          allFollowups.push(newFollowup);
          showMessage('ការតាមដានត្រូវបានបង្កើតដោយជោគជ័យ!', 'Success');
        }
        
        closeModal('followupModal');
        renderFollowups();
      } catch (error) {
        console.error('Save error:', error);
        showMessage('មានបញ្ហាក្នុងការរក្សាទុកការតាមដាន', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Event Listeners for Inspection Modals
    document.getElementById('openInspectionForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('inspectionModalTitle').textContent = 'ការត្រួតពិនិត្យថ្មី';
      document.getElementById('inspectionForm').reset();
      resetAllSelections();
      openModal('inspectionModal');
    });

    document.getElementById('openFollowupForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('followupModalTitle').textContent = 'តាមដានកំហិតថ្មី';
      document.getElementById('followupForm').reset();
      resetAllSelections();
      populateOriginalInspections();
      openModal('followupModal');
    });

    function resetAllSelections() {
      document.querySelectorAll('.penalty-option').forEach(option => {
        option.classList.remove('selected');
      });
      document.querySelectorAll('.penalty-details').forEach(details => {
        details.classList.remove('active');
      });
    }

    // Update sample data with new fields
    function loadSampleInspectionData() {
      allInspections = [
        {
          id: 1,
          no: 'INS001',
          factory_name: 'រោងចក្រ ក',
          sector: 'វិស័យ ក',
          case_subject: 'ការបំពានលើស្តង់ដារសុវត្ថិភាព',
          group: 'ក្រុម ក',
          inspection_date: '2024-01-15',
          village: 'ភូមិ ក',
          commune: 'ឃុំ ក',
          district: 'ស្រុក ក',
          province: 'ខេត្ត ក',
          has_penalty: 'មាន',
          penalty_format: 'ត្រូវកែលម្អប្រព័ន្ធអគ្គិសនី',
          penalty_condition: 'មិនបំពេញស្តង់ដារសុវត្ថិភាព',
          penalty_health: 'ខ្សែភ្លើងមិនមានសុវត្ថិភាព',
          penalty_professional: 'បុគ្គលិកគ្មានការបណ្តុះបណ្តាល',
          has_fine: 'គ្មាន',
          remarks: 'ត្រូវកែលម្អក្នុងរយៈពេល ៣០ថ្ងៃ'
        }
      ];
      
      allFollowups = [
        {
          id: 1,
          no: 'FLW001',
          original_inspection: '1',
          original_inspection_data: allInspections[0],
          followup_date: '2024-02-15',
          penalty_implemented: 'អនុវត្ត',
          conclusion: 'រោងចក្របានកែលម្អតាមតម្រូវការគ្រប់ចំនុច'
        }
      ];
      
      renderInspections();
      renderFollowups();
      populateOriginalInspections();
    }

    // --- Document Management Functions ---
    async function fetchDocuments() {
      try {
        const res = await fetch(DOC_API);
        const data = await res.json();
        allDocs = data.date || []; 
        renderDocuments(allDocs);
      } catch (error) {
        console.error("Document fetch error:", error);
        showMessage("Failed to fetch documents from server.", "Error");
      }
    }

    function renderDocuments(docs) {
      const tbody = document.getElementById('docTableBody');
      tbody.innerHTML = docs.map(doc => `
        <tr>
          <td>${doc.no || ''}</td>
          <td>${doc.ir || ''}</td>
          <td>${doc.outNo || ''}</td>
          <td>${doc.submitDate?.split('T')[0] || ''}</td>
          <td>${doc.source || ''}</td>
          <td>${doc.doc || ''}</td>
          <td>${doc.officer || ''}</td>
          <td>
            <span class="status-badge ${doc.progress === 'បានធ្វើចេញ' ? 'status-completed' : 'status-pending'}">
              ${doc.progress || ''}
            </span>
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewDocument('${doc.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-secondary" onclick="editDocument('${doc.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteDocumentConfirm('${doc.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Document CRUD Functions
    function viewDocument(id) {
      const doc = allDocs.find(d => d.id.toString() === id.toString());
      if (!doc) {
        showMessage('Document not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('docDetail');
      detailDiv.innerHTML = `
        <p><strong>លេខចូល:</strong> <span>${doc.no || ''}</span></p>
        <p><strong>លេខលិខិត (IR):</strong> <span>${doc.ir || ''}</span></p>
        <p><strong>លេខចេញ:</strong> <span>${doc.outNo || ''}</span></p>
        <p><strong>ថ្ងៃខែលិខិត:</strong> <span>${doc.submitDate?.split('T')[0] || ''}</span></p>
        <p><strong>អង្គភាព:</strong> <span>${doc.source || ''}</span></p>
        <p><strong>ប្រភេទឯកសារ:</strong> <span>${doc.doc || ''}</span></p>
        <p><strong>មន្រ្តីទទួល:</strong> <span>${doc.officer || ''}</span></p>
        <p><strong>ស្ថានភាព:</strong> <span>${doc.progress || ''}</span></p>
      `;
      
      openModal('viewDocModal');
    }

    function editDocument(id) {
      const doc = allDocs.find(d => d.id.toString() === id.toString());
      if (!doc) {
        showMessage('Document not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('docModalTitle').textContent = 'កែសម្រួលឯកសារ';
      
      // Populate form with document data
      const form = document.getElementById('docForm');
      form.elements['no'].value = doc.no || '';
      form.elements['ir'].value = doc.ir || '';
      form.elements['outNo'].value = doc.outNo || '';
      form.elements['submitDate'].value = doc.submitDate?.split('T')[0] || '';
      form.elements['source'].value = doc.source || '';
      form.elements['doc'].value = doc.doc || '';
      form.elements['officer'].value = doc.officer || '';
      form.elements['progress'].value = doc.progress || '';
      
      openModal('docModal');
    }

    function deleteDocumentConfirm(id) {
      openMessageModal(
        'លុបឯកសារ', 
        'តើអ្នកប្រាកដថាចង់លុបឯកសារនេះមែនទេ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteDocument(id);
          }
        }
      );
    }

    async function deleteDocument(id) {
      try {
        // Remove from local array
        allDocs = allDocs.filter(d => d.id.toString() !== id.toString());
        renderDocuments(allDocs);
        showMessage('Document deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete document', 'Error');
      }
    }

    // Document form submission
    document.getElementById('docForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.ir) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('docSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allDocs.findIndex(d => d.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allDocs[index] = { ...allDocs[index], ...data, id: currentEditingId };
          }
          showMessage('Document updated successfully', 'Success');
        } else {
          const newDoc = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allDocs.push(newDoc);
          showMessage('Document created successfully', 'Success');
        }
        
        closeModal('docModal');
        renderDocuments(allDocs);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save document', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- Factory Management Functions ---
    async function fetchFactories() {
      try {
        const res = await fetch(FACTORY_API);
        const data = await res.json();
        allFactories = data.data || [];
        renderFactories(allFactories);
        return allFactories;
      } catch (error) {
        console.error("Factory fetch error:", error);
        showMessage("Failed to fetch factories from server.", "Error");
        return [];
      }
    }

    function renderFactories(factories) {
      const tbody = document.getElementById('factoryTableBody');
      tbody.innerHTML = factories.map(factory => `
        <tr>
          <td>${factory.no || ''}</td>
          <td>${factory.factoryname || ''}</td>
          <td>${factory.factoryname_en || ''}</td>
          <td>${factory.sector || ''}</td>
          <td>${factory.village || ''}</td>
          <td>${factory.commune || ''}</td>
          <td>${factory.district || ''}</td>
          <td>${factory.province || ''}</td>
          <td>${factory.total_workers || ''}</td>
          <td>${factory.female_workers || ''}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewFactory('${factory.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-secondary" onclick="editFactory('${factory.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteFactoryConfirm('${factory.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    // Factory CRUD Functions
    function viewFactory(id) {
      const factory = allFactories.find(f => f.id.toString() === id.toString());
      if (!factory) {
        showMessage('Factory not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('factoryDetail');
      detailDiv.innerHTML = `
        <p><strong>លេខចូល:</strong> <span>${factory.no || ''}</span></p>
        <p><strong>ឈ្មោះរោងចក្រ:</strong> <span>${factory.factoryname || ''}</span></p>
        <p><strong>ឈ្មោះរោងចក្រ (EN):</strong> <span>${factory.factoryname_en || ''}</span></p>
        <p><strong>Sector:</strong> <span>${factory.sector || ''}</span></p>
        <p><strong>ភូមិ:</strong> <span>${factory.village || ''}</span></p>
        <p><strong>ឃុំ:</strong> <span>${factory.commune || ''}</span></p>
        <p><strong>ស្រុក:</strong> <span>${factory.district || ''}</span></p>
        <p><strong>ខេត្ត:</strong> <span>${factory.province || ''}</span></p>
        <p><strong>អាសយដ្ឋាន:</strong> <span>${factory.address || ''}</span></p>
        <p><strong>កម្មករសរុប:</strong> <span>${factory.total_workers || ''}</span></p>
        <p><strong>កម្មករស្រី:</strong> <span>${factory.female_workers || ''}</span></p>
        <p><strong>ឈ្មោះអ្នកគ្រប់គ្រង:</strong> <span>${factory.admin_name || ''}</span></p>
        <p><strong>លេខទូរស័ព្ទ:</strong> <span>${factory.admin_phone || ''}</span></p>
      `;
      
      openModal('viewFactoryModal');
    }

    function editFactory(id) {
      const factory = allFactories.find(f => f.id.toString() === id.toString());
      if (!factory) {
        showMessage('Factory not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('factoryModalTitle').textContent = 'កែសម្រួលរោងចក្រ';
      
      // Populate form with factory data
      const form = document.getElementById('factoryForm');
      form.elements['no'].value = factory.no || '';
      form.elements['factoryname'].value = factory.factoryname || '';
      form.elements['factoryname_en'].value = factory.factoryname_en || '';
      form.elements['sector'].value = factory.sector || '';
      form.elements['village'].value = factory.village || '';
      form.elements['commune'].value = factory.commune || '';
      form.elements['district'].value = factory.district || '';
      form.elements['province'].value = factory.province || '';
      form.elements['address'].value = factory.address || '';
      form.elements['total_workers'].value = factory.total_workers || '';
      form.elements['female_workers'].value = factory.female_workers || '';
      form.elements['admin_name'].value = factory.admin_name || '';
      form.elements['admin_phone'].value = factory.admin_phone || '';
      
      openModal('factoryModal');
    }

    function deleteFactoryConfirm(id) {
      openMessageModal(
        'លុបរោងចក្រ', 
        'តើអ្នកប្រាកដថាចង់លុបរោងចក្រនេះមែនទេ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteFactory(id);
          }
        }
      );
    }

    async function deleteFactory(id) {
      try {
        // Remove from local array
        allFactories = allFactories.filter(f => f.id.toString() !== id.toString());
        renderFactories(allFactories);
        showMessage('Factory deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete factory', 'Error');
      }
    }

    // Factory form submission
    document.getElementById('factoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.no || !data.factoryname || !data.factoryname_en || !data.sector) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('factorySubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allFactories.findIndex(f => f.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allFactories[index] = { ...allFactories[index], ...data, id: currentEditingId };
          }
          showMessage('Factory updated successfully', 'Success');
        } else {
          const newFactory = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allFactories.push(newFactory);
          showMessage('Factory created successfully', 'Success');
        }
        
        closeModal('factoryModal');
        renderFactories(allFactories);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save factory', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- User Management Functions ---
    async function fetchUsers() {
      try {
        const res = await fetch(USER_API);
        const data = await res.json();
        allUsers = data.data || [];
        renderUsers(allUsers);
      } catch (error) {
        console.error("User fetch error:", error);
        showMessage("Failed to fetch users from server.", "Error");
      }
    }

    function renderUsers(users) {
      const tbody = document.getElementById('userTableBody');
      tbody.innerHTML = users.map(user => `
        <tr>
          <td>${user.name || ''}</td>
          <td>${user.phone || ''}</td>
          <td>${user.email || ''}</td>
          <td>
            <span class="role-badge ${getRoleBadgeClass(user.role)}">
              ${getRoleDisplayName(user.role)}
            </span>
          </td>
          <td>${user.function || ''}</td>
          <td>${user.sangkat || ''}</td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-primary" onclick="viewUser('${user.id}')"><i class="bi bi-eye"></i></button>
              <button class="btn btn-outline-secondary" onclick="editUser('${user.id}')"><i class="bi bi-pencil"></i></button>
              <button class="btn btn-outline-danger" onclick="deleteUserConfirm('${user.id}')"><i class="bi bi-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
    }

    function getRoleBadgeClass(role) {
      switch(role) {
        case 'admin': return 'role-badge-admin';
        case 'officer': return 'role-badge-officer';
        default: return 'role-badge-officer';
      }
    }

    function getRoleDisplayName(role) {
      switch(role) {
        case 'admin': return 'អ្នកគ្រប់គ្រង';
        case 'officer': return 'មន្ត្រី';
        default: return role;
      }
    }

    // User CRUD Functions
    function viewUser(id) {
      const user = allUsers.find(u => u.id.toString() === id.toString());
      if (!user) {
        showMessage('User not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('userDetail');
      detailDiv.innerHTML = `
        <p><strong>ឈ្មោះ:</strong> <span>${user.name || ''}</span></p>
        <p><strong>ទូរស័ព្ទ:</strong> <span>${user.phone || ''}</span></p>
        <p><strong>អ៊ីមែល:</strong> <span>${user.email || ''}</span></p>
        <p><strong>តួនាទី:</strong> <span>${getRoleDisplayName(user.role)}</span></p>
        <p><strong>មុខងារ:</strong> <span>${user.function || ''}</span></p>
        <p><strong>សង្កាត់:</strong> <span>${user.sangkat || ''}</span></p>
      `;
      
      openModal('viewUserModal');
    }

    function editUser(id) {
      const user = allUsers.find(u => u.id.toString() === id.toString());
      if (!user) {
        showMessage('User not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('userModalTitle').textContent = 'កែសម្រួលអ្នកប្រើប្រាស់';
      
      // Populate form with user data
      const form = document.getElementById('userForm');
      form.elements['name'].value = user.name || '';
      form.elements['phone'].value = user.phone || '';
      form.elements['email'].value = user.email || '';
      form.elements['password'].value = ''; // Don't populate password for security
      form.elements['role'].value = user.role || '';
      form.elements['function'].value = user.function || '';
      form.elements['sangkat'].value = user.sangkat || '';
      
      openModal('userModal');
    }

    function deleteUserConfirm(id) {
      openMessageModal(
        'លុបអ្នកប្រើប្រាស់', 
        'តើអ្នកប្រាកដថាចង់លុបអ្នកប្រើប្រាស់នេះមែនទេ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteUser(id);
          }
        }
      );
    }

    async function deleteUser(id) {
      try {
        // Remove from local array
        allUsers = allUsers.filter(u => u.id.toString() !== id.toString());
        renderUsers(allUsers);
        showMessage('User deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete user', 'Error');
      }
    }

    // User form submission
    document.getElementById('userForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      if (!data.name || !data.phone || !data.email || !data.password || !data.role) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
      }
      
      const submitBtn = document.getElementById('userSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
      submitBtn.disabled = true;
      
      try {
        if (currentEditingId) {
          const index = allUsers.findIndex(u => u.id.toString() === currentEditingId.toString());
          if (index !== -1) {
            allUsers[index] = { ...allUsers[index], ...data, id: currentEditingId };
          }
          showMessage('User updated successfully', 'Success');
        } else {
          const newUser = {
            id: Date.now(),
            ...data,
            created_at: new Date().toISOString()
          };
          allUsers.push(newUser);
          showMessage('User created successfully', 'Success');
        }
        
        closeModal('userModal');
        renderUsers(allUsers);
      } catch (error) {
        console.error('Save error:', error);
        showMessage('Failed to save user', 'Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // Inspection CRUD Functions
    function viewInspection(id) {
      const inspection = allInspections.find(i => i.id.toString() === id.toString());
      if (!inspection) {
        showMessage('Inspection not found', 'Error');
        return;
      }
      
      const detailDiv = document.getElementById('inspectionDetail');
      detailDiv.innerHTML = `
        <p><strong>លេខចូល:</strong> <span>${inspection.no || ''}</span></p>
        <p><strong>ក្រុម:</strong> <span>${inspection.group || ''}</span></p>
        <p><strong>កាលបរិច្ឆេទត្រួតពិនិត្យ:</strong> <span>${inspection.inspection_date || ''}</span></p>
        <p><strong>ឈ្មោះរោងចក្រ:</strong> <span>${inspection.factory_name || ''}</span></p>
        <p><strong>វិស័យ:</strong> <span>${inspection.sector || ''}</span></p>
        <p><strong>ប្រធានបទ:</strong> <span>${inspection.case_subject || ''}</span></p>
        <p><strong>ភូមិ:</strong> <span>${inspection.village || ''}</span></p>
        <p><strong>ឃុំ:</strong> <span>${inspection.commune || ''}</span></p>
        <p><strong>ស្រុក:</strong> <span>${inspection.district || ''}</span></p>
        <p><strong>ខេត្ត:</strong> <span>${inspection.province || ''}</span></p>
        <p><strong>កំហិត:</strong> <span>${inspection.has_penalty || ''}</span></p>
        ${inspection.has_penalty === 'មាន' ? `
          <p><strong>បែបបទ:</strong> <span>${inspection.penalty_format || ''}</span></p>
          <p><strong>លក្ខខណ្ឌ:</strong> <span>${inspection.penalty_condition || ''}</span></p>
          <p><strong>សុខភាពនិងសុវត្ថភាព:</strong> <span>${inspection.penalty_health || ''}</span></p>
          <p><strong>វិជ្ជាជីវៈ:</strong> <span>${inspection.penalty_professional || ''}</span></p>
        ` : ''}
        <p><strong>ផាក:</strong> <span>${inspection.has_fine || ''}</span></p>
        ${inspection.has_fine === 'មាន' ? `
          <p><strong>ចំនួនទឹកប្រាក់:</strong> <span>${inspection.fine_amount || ''}</span></p>
          <p><strong>ប្រភេទផាក:</strong> <span>${inspection.fine_type || ''}</span></p>
          <p><strong>ហេតុផល:</strong> <span>${inspection.fine_reason || ''}</span></p>
        ` : ''}
        <p><strong>ផ្សេងៗ:</strong> <span>${inspection.remarks || ''}</span></p>
      `;
      
      openModal('viewInspectionModal');
    }

    function editInspection(id) {
      const inspection = allInspections.find(i => i.id.toString() === id.toString());
      if (!inspection) {
        showMessage('Inspection not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('inspectionModalTitle').textContent = 'កែសម្រួលការត្រួតពិនិត្យ';
      
      // Populate form with inspection data
      const form = document.getElementById('inspectionForm');
      form.elements['no'].value = inspection.no || '';
      form.elements['group'].value = inspection.group || '';
      form.elements['inspection_date'].value = inspection.inspection_date || '';
      form.elements['factory_name'].value = inspection.factory_name || '';
      form.elements['sector'].value = inspection.sector || '';
      form.elements['case_subject'].value = inspection.case_subject || '';
      form.elements['village'].value = inspection.village || '';
      form.elements['commune'].value = inspection.commune || '';
      form.elements['district'].value = inspection.district || '';
      form.elements['province'].value = inspection.province || '';
      form.elements['remarks'].value = inspection.remarks || '';
      
      // Handle penalty section
      if (inspection.has_penalty === 'មាន') {
        togglePenaltyDetails(true);
        form.elements['penalty_format'].value = inspection.penalty_format || '';
        form.elements['penalty_condition'].value = inspection.penalty_condition || '';
        form.elements['penalty_health'].value = inspection.penalty_health || '';
        form.elements['penalty_professional'].value = inspection.penalty_professional || '';
      } else {
        togglePenaltyDetails(false);
      }
      
      // Handle fine section
      if (inspection.has_fine === 'មាន') {
        toggleFineDetails(true);
        form.elements['fine_amount'].value = inspection.fine_amount || '';
        form.elements['fine_type'].value = inspection.fine_type || '';
        form.elements['fine_reason'].value = inspection.fine_reason || '';
      } else {
        toggleFineDetails(false);
      }
      
      openModal('inspectionModal');
    }

    function deleteInspectionConfirm(id) {
      openMessageModal(
        'លុបការត្រួតពិនិត្យ', 
        'តើអ្នកប្រាកដថាចង់លុបការត្រួតពិនិត្យនេះមែនទេ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteInspection(id);
          }
        }
      );
    }

    async function deleteInspection(id) {
      try {
        // Remove from local array
        allInspections = allInspections.filter(i => i.id.toString() !== id.toString());
        renderInspections();
        populateOriginalInspections();
        showMessage('Inspection deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete inspection', 'Error');
      }
    }

    // Follow-up CRUD Functions
    function viewFollowup(id) {
      const followup = allFollowups.find(f => f.id.toString() === id.toString());
      if (!followup) {
        showMessage('Follow-up not found', 'Error');
        return;
      }
      
      const original = followup.original_inspection_data || {};
      const detailDiv = document.getElementById('followupDetail');
      detailDiv.innerHTML = `
        <p><strong>លេខចូល:</strong> <span>${followup.no || ''}</span></p>
        <p><strong>កាលបរិច្ឆេទតាមដាន:</strong> <span>${followup.followup_date || ''}</span></p>
        <p><strong>ការត្រួតពិនិត្យដើម:</strong> <span>${original.no || ''} - ${original.factory_name || ''}</span></p>
        <p><strong>លទ្ធផលតាមដាន:</strong> <span>${followup.penalty_implemented || ''}</span></p>
        ${followup.penalty_implemented === 'មិនអនុវត្ត' ? `
          <p><strong>បែបបទ:</strong> <span>${followup.followup_format || ''}</span></p>
          <p><strong>លក្ខខណ្ឌ:</strong> <span>${followup.followup_condition || ''}</span></p>
          <p><strong>សុខភាពនិងសុវត្ថភាព:</strong> <span>${followup.followup_health || ''}</span></p>
          <p><strong>វិជ្ជាជីវៈ:</strong> <span>${followup.followup_professional || ''}</span></p>
        ` : ''}
        <p><strong>សេចក្តីសន្និដ្ឋាន:</strong> <span>${followup.conclusion || ''}</span></p>
      `;
      
      openModal('viewFollowupModal');
    }

    function editFollowup(id) {
      const followup = allFollowups.find(f => f.id.toString() === id.toString());
      if (!followup) {
        showMessage('Follow-up not found', 'Error');
        return;
      }
      
      currentEditingId = id;
      document.getElementById('followupModalTitle').textContent = 'កែសម្រួលតាមដានកំហិត';
      
      // Populate form with followup data
      const form = document.getElementById('followupForm');
      form.elements['no'].value = followup.no || '';
      form.elements['original_inspection'].value = followup.original_inspection || '';
      form.elements['followup_date'].value = followup.followup_date || '';
      form.elements['conclusion'].value = followup.conclusion || '';
      
      // Handle follow-up result section
      if (followup.penalty_implemented === 'មិនអនុវត្ត') {
        toggleFollowupDetails(true);
        form.elements['followup_format'].value = followup.followup_format || '';
        form.elements['followup_condition'].value = followup.followup_condition || '';
        form.elements['followup_health'].value = followup.followup_health || '';
        form.elements['followup_professional'].value = followup.followup_professional || '';
      } else {
        toggleFollowupDetails(false);
      }
      
      // Load original inspection data
      loadOriginalInspectionData();
      
      openModal('followupModal');
    }

    function deleteFollowupConfirm(id) {
      openMessageModal(
        'លុបតាមដានកំហិត', 
        'តើអ្នកប្រាកដថាចង់លុបតាមដានកំហិតនេះមែនទេ?', 
        'confirm', 
        (confirmed) => {
          if (confirmed) {
            deleteFollowup(id);
          }
        }
      );
    }

    async function deleteFollowup(id) {
      try {
        // Remove from local array
        allFollowups = allFollowups.filter(f => f.id.toString() !== id.toString());
        renderFollowups();
        showMessage('Follow-up deleted successfully', 'Success');
      } catch (error) {
        console.error('Delete error:', error);
        showMessage('Failed to delete follow-up', 'Error');
      }
    }

    // --- Event Listeners for Modals ---
    document.getElementById('openDocForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('docModalTitle').textContent = 'បញ្ចូលឯកសារថ្មី';
      document.getElementById('docForm').reset();
      openModal('docModal');
    });
    
    document.getElementById('openFactoryForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('factoryModalTitle').textContent = 'បញ្ចូលរោងចក្រថ្មី';
      document.getElementById('factoryForm').reset();
      openModal('factoryModal');
    });

    document.getElementById('openUserForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('userModalTitle').textContent = 'បញ្ចូលអ្នកប្រើប្រាស់ថ្មី';
      document.getElementById('userForm').reset();
      openModal('userModal');
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      showSection('documents');
    });
  </script>
</body>
</html>