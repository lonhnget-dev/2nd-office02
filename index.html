<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document & Factory Management System</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
      background-color: #f8f9fa; 
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      color: #2c3e50;
      line-height: 1.6;
    }
    
    /* --- Sidebar (Navbar) --- */
    .sidebar { 
      width: 260px; 
      min-width: 260px;
      background: #fff; 
      color: #2c3e50; 
      padding: 25px 0;
      box-shadow: 2px 0 10px rgba(0,0,0,0.08);
      position: fixed;
      height: 100%;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
      border-right: 1px solid #e1e5e9;
    }

    .sidebar.hidden {
      transform: translateX(-100%);
    }
    
    .navbar-header { 
      padding: 0 25px 25px 25px;
      border-bottom: 1px solid #e1e5e9;
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .navbar-brand { 
      font-size: 1.4rem; 
      font-weight: 600; 
      white-space: nowrap;
      overflow: hidden;
      letter-spacing: 0.5px;
    }

    /* Hide Button - Inside Navbar */
    #hideSidebar {
        background: none;
        border: 1px solid #d1d9e6;
        color: #5d6d7e;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s;
        z-index: 101; 
        font-size: 0.85rem;
    }
    #hideSidebar:hover {
        background: #f8f9fa;
        border-color: #a6b1c2;
    }
    
    /* Show Button - When sidebar is hidden */
    #showSidebar {
        position: fixed;
        top: 20px;
        left: 20px;
        background: #fff;
        color: #2c3e50;
        border: 1px solid #d1d9e6;
        padding: 10px 14px;
        border-radius: 6px;
        cursor: pointer;
        z-index: 10000;
        font-size: 16px;
        display: none;
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    #showSidebar:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .navbar-links { 
      display: flex; 
      flex-direction: column; 
      overflow: hidden;
    }
    .navbar-links a { 
      color: #5d6d7e; 
      text-decoration: none; 
      padding: 14px 25px; 
      transition: all 0.3s; 
      border-left: 4px solid transparent;
      white-space: nowrap;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .navbar-links a:hover { 
      background: #f8f9fa; 
      color: #2c3e50;
      border-left-color: #a6b1c2;
    }
    .navbar-links a.active { 
      background: #f0f3f7; 
      color: #2c3e50;
      border-left-color: #3498db;
      font-weight: 600;
    }
    
    /* --- Main Content Area --- */
    .main-container {
      flex-grow: 1;
      margin-left: 260px;
      padding: 25px;
      max-width: calc(100% - 260px);
      width: 100%;
      transition: margin-left 0.3s ease, max-width 0.3s ease;
    }

    .main-container.expanded {
      margin-left: 0;
      max-width: 100%;
    }
    
    .page-header { 
      background: #fff; 
      color: #2c3e50; 
      padding: 30px; 
      border-radius: 10px; 
      margin-bottom: 25px; 
      text-align: center;
      position: sticky; 
      top: 0; 
      z-index: 50; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    .page-header h1 {
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }
    .page-header p {
      color: #7b8a9b;
      font-size: 1.1rem;
    }
    
    .control-section { 
      background: #fff; 
      padding: 25px; 
      border-radius: 10px; 
      margin-bottom: 25px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      flex-wrap: wrap; 
      gap: 15px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    /* Buttons */
    .btn { 
      padding: 10px 20px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 600; 
      transition: all 0.3s; 
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      color: #2c3e50;
      letter-spacing: 0.3px;
    }
    .btn:hover { 
      background: #f8f9fa; 
      transform: translateY(-2px); 
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
      border-color: #a6b1c2;
    }
    .btn-primary {
      background: #3498db;
      color: white;
      border-color: #3498db;
    }
    .btn-primary:hover {
      background: #2980b9;
      border-color: #2980b9;
    }
    .btn-sm {
      padding: 8px 16px;
      font-size: 0.85rem;
    }
    
    /* Action buttons container */
    .action-buttons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    /* Tables */
    .table-container { 
      background: #fff; 
      border-radius: 10px; 
      overflow: hidden; 
      margin-bottom: 25px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    .table-wrapper { 
      overflow-x: auto; 
      max-height: 70vh; 
      overflow-y: auto; 
    }
    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 1200px; 
    }
    th, td { 
      padding: 14px 16px; 
      text-align: left; 
      border-bottom: 1px solid #e1e5e9; 
    }
    th { 
      background: #f8f9fa; 
      color: #2c3e50; 
      position: sticky; 
      top: 0; 
      font-weight: 600;
      border-bottom: 2px solid #e1e5e9;
      font-size: 0.9rem;
      letter-spacing: 0.3px;
    }
    tr:hover { 
      background-color: #f8f9fa; 
    }
    
    /* Forms & Modals */
    .modal { 
        display: none; 
        position: fixed; 
        top: 0; 
        left: 0; 
        width: 100%; 
        height: 100%; 
        background: rgba(0,0,0,0.5); 
        z-index: 1000; 
        justify-content: center; 
        align-items: center; 
        padding: 20px;
        backdrop-filter: blur(4px);
    }
    .modal-content { 
        background: white; 
        border-radius: 12px; 
        max-width: 800px; 
        width: 95%; 
        max-height: 90vh; 
        overflow: hidden; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        border: 1px solid #e1e5e9;
        animation: modalFadeIn 0.3s ease;
    }
    @keyframes modalFadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .modal-header { 
        background: #f8f9fa; 
        color: #2c3e50; 
        padding: 25px; 
        border-bottom: 1px solid #e1e5e9;
    }
    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 600;
    }
    .modal-body { 
        padding: 25px; 
        max-height: calc(90vh - 120px); 
        overflow-y: auto; 
    }
    .form-grid { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 20px; 
        margin-bottom: 20px; 
    }
    .form-group { 
        margin-bottom: 8px; 
    }
    .form-group.full-width { 
        grid-column: 1 / -1; 
    }
    .form-group label { 
        display: block; 
        margin-bottom: 8px; 
        font-weight: 600; 
        color: #5d6d7e;
        font-size: 0.95rem;
    }
    .form-group input, .form-group select, .form-group textarea { 
        width: 100%; 
        padding: 12px 14px; 
        border: 1px solid #d1d9e6; 
        border-radius: 8px; 
        background: #fff;
        color: #2c3e50;
        font-size: 0.95rem;
        transition: all 0.3s;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .form-buttons { 
        display: flex; 
        gap: 12px; 
        justify-content: flex-end; 
        margin-top: 25px; 
        padding-top: 25px;
        border-top: 1px solid #e1e5e9;
    }
    
    /* Compact Import Section */
    .import-section {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .import-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .import-header h3 {
      color: #2c3e50;
      font-size: 1.1rem;
      margin: 0;
    }
    
    .import-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .file-input {
      display: none;
    }
    
    .file-info {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e3f2fd;
      border-radius: 6px;
      border-left: 4px solid #3498db;
      font-size: 0.9rem;
    }
    
    .file-info.hidden {
      display: none;
    }
    
    /* Detail View Styling */
    .detail-view p { 
        margin-bottom: 14px; 
        line-height: 1.7; 
        border-bottom: 1px dashed #e1e5e9;
        padding-bottom: 10px;
        display: flex;
    }
    .detail-view strong { 
        display: inline-block; 
        width: 180px;
        color: #5d6d7e; 
        font-weight: 600;
    }
    .detail-view span {
        color: #2c3e50;
        flex: 1;
    }
    
    .search-box { 
      padding: 12px 16px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      min-width: 220px; 
      background: #fff;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .search-box:focus {
        outline: none;
        border-color: #3498db;
        box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
    }
    .count-select { 
      padding: 12px 16px; 
      border: 1px solid #d1d9e6; 
      border-radius: 8px; 
      background: #fff;
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .count-select:focus {
        outline: none;
        border-color: #3498db;
    }

    .menu-toggle {
      display: none;
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1001;
      background: #fff;
      color: #2c3e50;
      border: 1px solid #d1d9e6;
      padding: 12px 16px;
      border-radius: 8px;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }
    .menu-toggle:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* Loading Spinner */
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: #3498db;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Status badges */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .status-completed {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b8e0e6;
    }
    
    /* --- Responsive Styles --- */
    @media (max-width: 900px) {
      body {
        display: block;
      }

      .menu-toggle {
        display: block;
      }
      
      .sidebar {
        width: 280px;
        transform: translateX(-280px); 
        box-shadow: 0 0 20px rgba(0,0,0,0.15);
      }
      .sidebar.open {
        transform: translateX(0);
      }
      .sidebar.hidden { 
          width: 280px;
          min-width: 280px;
          transform: translateX(-280px);
          padding: 25px 0;
      }

      .main-container {
        margin-left: 0;
        padding-top: 70px;
        max-width: 100%;
      }

      .control-section { 
        flex-direction: column; 
        align-items: stretch; 
      }
      .form-grid { 
        grid-template-columns: 1fr; 
      }
      .form-buttons { 
        flex-direction: column; 
        justify-content: center;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        margin-bottom: 5px;
        justify-content: center;
      }
      
      #showSidebar {
        display: block !important;
      }
      
      .page-header {
        padding: 20px;
      }
      
      .page-header h1 {
        font-size: 1.6rem;
      }
      
      .import-header {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      
      .import-controls {
        width: 100%;
        justify-content: space-between;
      }
    }
  </style>
</head>
<body>
  <button class="menu-toggle" id="menuToggle">â˜° Menu</button>
  <button id="showSidebar">â˜° Show Menu</button>

  <nav class="sidebar" id="sidebar">
    <div class="navbar-header">
      <div class="navbar-brand">ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„</div>
      <button id="hideSidebar" title="Hide Sidebar">â—€</button>
    </div>
    <div class="navbar-links">
      <a href="#" class="active" onclick="showSection('documents', event)">
        <span>ğŸ“„</span>
        <span>á¯á€áŸá¶áš</span>
      </a>
      <a href="#" onclick="showSection('factories', event)">
        <span>ğŸ­</span>
        <span>ášáŸ„á„á…á€áŸ’áš</span>
      </a>
    </div>
  </nav>

  <div class="main-container" id="mainContainer"> 
    
    <!-- Documents Section -->
    <section id="documents-section">
      <header class="page-header">
        <h1>ğŸ“ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á¯á€áŸá¶áš</h1>
        <p>Document Management System</p>
      </header>

      <div class="control-section">
        <button class="btn" id="openDocForm">
          <span>â•</span>
          <span>á”á‰áŸ’á…á¼á›á¯á€áŸá¶ášááŸ’á˜á¸</span>
        </button>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <select class="count-select" id="showCount">
            <option value="15">15</option>
            <option value="30">30</option>
            <option value="60">60</option>
            <option value="100">100</option>
            <option value="all">All</option>
          </select>
          <input type="search" class="search-box" id="docSearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€á¯á€áŸá¶áš...">
          <button class="btn" id="exportDocExcel">
            <span>ğŸ“¥</span>
            <span>á‘á¶á‰á™á€ Excel</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table id="documentTable">
            <thead>
              <tr>
                <th>á›áŸáá…á¼á›</th>
                <th>á›áŸáá›á·áá·á (IR)</th>
                <th>á›áŸáá…áŸá‰</th>
                <th>ááŸ’á„áŸƒááŸ‚á›á·áá·á</th>
                <th>á¢á„áŸ’á‚á—á¶á–</th>
                <th>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</th>
                <th>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</th>
                <th>áŸáŸ’áá¶á“á—á¶á–</th>
                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
              </tr>
            </thead>
            <tbody id="docTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Factories Section -->
    <section id="factories-section" style="display: none;">
      <header class="page-header">
        <h1>ğŸ­ á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ášáŸ„á„á…á€áŸ’áš</h1>
        <p>Factory Management System</p>
      </header>

      <!-- Compact Import Section -->
      <div class="import-section">
        <div class="import-header">
          <h3>ğŸ“¤ á“á¶áŸ†á…á¼á›á‘á·á“áŸ’á“á“áŸá™ášáŸ„á„á…á€áŸ’áš</h3>
          <div class="import-controls">
            <button class="btn btn-sm" id="selectFileBtn">
              <span>ğŸ“‚</span>
              <span>á‡áŸ’ášá¾áŸášá¾áŸá¯á€áŸá¶áš</span>
            </button>
            <button class="btn btn-sm" id="downloadTemplateBtn">
              <span>ğŸ“¥</span>
              <span>á‘á¶á‰á™á€á‚áŸ†ášá¼</span>
            </button>
            <button class="btn btn-sm btn-primary" id="importBtn" disabled>
              <span>ğŸ“¤</span>
              <span>á“á¶áŸ†á…á¼á›</span>
            </button>
          </div>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls,.csv">
        <div class="file-info hidden" id="fileInfo">
          <strong>á¯á€áŸá¶áš:</strong> <span id="fileName">-</span> | 
          <strong>á‘áŸ†á áŸ†:</strong> <span id="fileSize">-</span>
        </div>
      </div>

      <div class="control-section">
        <button class="btn" id="openFactoryForm">
          <span>â•</span>
          <span>á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸</span>
        </button>
        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
          <input type="search" class="search-box" id="factorySearch" placeholder="áŸáŸ’áœáŸ‚á„ášá€ášáŸ„á„á…á€áŸ’áš...">
          <button class="btn" id="exportFactoryExcel">
            <span>ğŸ“¥</span>
            <span>á‘á¶á‰á™á€ Excel</span>
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table id="factoryTable">
            <thead>
              <tr>
                <th>á›áŸáá…á¼á›</th>
                <th>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš</th>
                <th>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN)</th>
                <th>Sector</th>
                <th>á—á¼á˜á·</th>
                <th>áƒá»áŸ†</th>
                <th>áŸáŸ’ášá»á€</th>
                <th>ááŸááŸ’á</th>
                <th>á€á˜áŸ’á˜á€ášáŸášá»á”</th>
                <th>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸</th>
                <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
              </tr>
            </thead>
            <tbody id="factoryTableBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- Document Modal (Used for both New and Edit) -->
  <div class="modal" id="docModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á”á‰áŸ’á…á¼á› / á€áŸ‚áŸá˜áŸ’ášá½á›á¯á€áŸá¶áš</h2>
      </div>
      <div class="modal-body">
        <form id="docForm">
          <div class="form-grid">
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá›á·áá·á(IR) *</label>
              <input type="text" name="ir" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá…áŸá‰</label>
              <input type="text" name="outNo">
            </div>
            <div class="form-group">
              <label>ááŸ’á„áŸƒááŸ‚á›á·áá·á</label>
              <input type="date" name="submitDate">
            </div>
            <div class="form-group full-width">
              <label>á¢á„áŸ’á‚á—á¶á–/á”áŸ’ášá—á–á›á·áá·á</label>
              <input type="text" name="source">
            </div>
            <div class="form-group">
              <label>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</label>
              <input type="text" name="doc">
            </div>
            <div class="form-group">
              <label>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</label>
              <input type="text" name="officer">
            </div>
            <div class="form-group">
              <label>áŸáŸ’áá¶á“á—á¶á–</label>
              <select name="progress">
                <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
                <option value="á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰">á˜á·á“á‘á¶á“áŸ‹á’áŸ’áœá¾á…áŸá‰</option>
                <option value="á”á¶á“á’áŸ’áœá¾á…áŸá‰">á”á¶á“á’áŸ’áœá¾á…áŸá‰</option>
              </select>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="docSubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('docModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Factory Modal (Used for both New and Edit) -->
  <div class="modal" id="factoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="factoryModalTitle">á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸</h2>
      </div>
      <div class="modal-body">
        <form id="factoryForm">
          <div class="form-grid">
            <div class="form-group">
              <label>á›áŸáá…á¼á› *</label>
              <input type="text" name="no" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš *</label>
              <input type="text" name="factoryname" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN) *</label>
              <input type="text" name="factoryname_en" required>
            </div>
            <div class="form-group">
              <label>Sector *</label>
              <input type="text" name="sector" required>
            </div>
            <div class="form-group">
              <label>á—á¼á˜á· *</label>
              <input type="text" name="village" required>
            </div>
            <div class="form-group">
              <label>áƒá»áŸ† *</label>
              <input type="text" name="commune" required>
            </div>
            <div class="form-group">
              <label>áŸáŸ’ášá»á€ *</label>
              <input type="text" name="district" required>
            </div>
            <div class="form-group">
              <label>ááŸááŸ’á *</label>
              <input type="text" name="province" required>
            </div>
            <div class="form-group">
              <label>á¢á¶áŸá™áŠáŸ’á‹á¶á“ *</label>
              <input type="text" name="address" required>
            </div>
            <div class="form-group">
              <label>á€á˜áŸ’á˜á€ášáŸášá»á” *</label>
              <input type="number" name="total_workers" required>
            </div>
            <div class="form-group">
              <label>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸ *</label>
              <input type="number" name="female_workers" required>
            </div>
            <div class="form-group">
              <label>áˆáŸ’á˜áŸ„áŸ‡á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ *</label>
              <input type="text" name="admin_name" required>
            </div>
            <div class="form-group">
              <label>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘ *</label>
              <input type="text" name="admin_phone" required>
            </div>
          </div>
          <div class="form-buttons">
            <button type="submit" class="btn" id="factorySubmitBtn">
              <span>ğŸ’¾</span>
              <span>ášá€áŸ’áŸá¶á‘á»á€</span>
            </button>
            <button type="button" class="btn" onclick="closeModal('factoryModal')">á”á·á‘</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- View Modals -->
  <div class="modal" id="viewDocModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áá¯á€áŸá¶áš</h2>
      </div>
      <div class="modal-body">
        <div id="docDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewDocModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="viewFactoryModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>á–áŸááŸŒá˜á¶á“á›á˜áŸ’á¢á·áášáŸ„á„á…á€áŸ’áš</h2>
      </div>
      <div class="modal-body">
        <div id="factoryDetail" class="detail-view"></div>
        <div class="form-buttons" style="justify-content: center; margin-top: 30px;">
          <button type="button" class="btn" onclick="closeModal('viewFactoryModal')">á”á·á‘ (Close)</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Message Box/Confirmation Modal -->
  <div class="modal" id="messageModal">
    <div class="modal-content" style="max-width: 450px;">
      <div class="modal-header">
        <h2 id="messageTitle">Information</h2>
      </div>
      <div class="modal-body">
        <p id="messageText"></p>
        <div class="form-buttons" id="messageButtons" style="justify-content: center;">
          <!-- Buttons inserted by JS -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // API URLs - Using your working server
    const DOC_API = "https://uat-api-office2.thithabirdnest.com/doc";
    const FACTORY_API = "https://uat-api-office2.thithabirdnest.com/fac";
    
    // Global variables
    let allDocs = [], allFactories = [];
    let currentEditingId = null;
    let selectedFile = null;

    // DOM Elements
    const body = document.body;
    const sidebar = document.getElementById('sidebar');
    const mainContainer = document.getElementById('mainContainer');
    const menuToggle = document.getElementById('menuToggle');
    const hideSidebarBtn = document.getElementById('hideSidebar');
    const showSidebarBtn = document.getElementById('showSidebar');
    
    // Import elements
    const fileInput = document.getElementById('fileInput');
    const selectFileBtn = document.getElementById('selectFileBtn');
    const importBtn = document.getElementById('importBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    
    // Message/Confirmation box elements
    const messageModal = document.getElementById('messageModal');
    const messageTitle = document.getElementById('messageTitle');
    const messageText = document.getElementById('messageText');
    const messageButtons = document.getElementById('messageButtons');

    // --- Simple Sidebar Toggle Functions ---
    function hideSidebar() {
      sidebar.classList.add('hidden');
      mainContainer.classList.add('expanded');
      showSidebarBtn.style.display = 'block';
    }

    function showSidebar() {
      sidebar.classList.remove('hidden');
      mainContainer.classList.remove('expanded');
      showSidebarBtn.style.display = 'none';
    }

    // Event listeners for sidebar buttons
    hideSidebarBtn.addEventListener('click', hideSidebar);
    showSidebarBtn.addEventListener('click', showSidebar);

    // Mobile menu toggle
    menuToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // --- Import Functionality ---
    selectFileBtn.addEventListener('click', () => {
      fileInput.click();
    });

    fileInput.addEventListener('change', handleFileSelect);
    importBtn.addEventListener('click', importData);
    downloadTemplateBtn.addEventListener('click', downloadTemplate);

    function handleFileSelect(e) {
      const files = e.target.files;
      if (files.length > 0) {
        selectedFile = files[0];
        displayFileInfo(selectedFile);
        importBtn.disabled = false;
      }
    }

    function displayFileInfo(file) {
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      fileInfo.classList.remove('hidden');
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    async function importData() {
      if (!selectedFile) return;

      const submitBtn = importBtn;
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„á“á¶áŸ†á…á¼á›...';
      submitBtn.disabled = true;

      try {
        const data = await readFile(selectedFile);
        const factories = parseData(data, selectedFile.name);
        
        if (factories.length === 0) {
          showMessage('No valid factory data found in the file.', 'Import Error');
          return;
        }

        // Show preview before importing
        openMessageModal(
          'Confirm Import', 
          `Found ${factories.length} factories to import. Do you want to continue?`,
          'confirm',
          async (confirmed) => {
            if (confirmed) {
              await saveFactories(factories);
            }
          }
        );

      } catch (error) {
        console.error('Import error:', error);
        showMessage('Failed to import data: ' + error.message, 'Import Error');
      } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    }

    function readFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          resolve(e.target.result);
        };
        
        reader.onerror = function() {
          reject(new Error('Failed to read file'));
        };

        if (file.name.endsWith('.csv')) {
          reader.readAsText(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
      });
    }

    function parseData(data, filename) {
      let factories = [];
      
      if (filename.endsWith('.csv')) {
        // Parse CSV
        const lines = data.split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        
        for (let i = 1; i < lines.length; i++) {
          if (lines[i].trim() === '') continue;
          
          const values = lines[i].split(',').map(v => v.trim());
          const factory = {};
          
          headers.forEach((header, index) => {
            if (values[index]) {
              factory[header] = values[index];
            }
          });
          
          if (factory.factoryname && factory.address) {
            factories.push(factory);
          }
        }
      } else {
        // Parse Excel
        const workbook = XLSX.read(data, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);
        
        factories = jsonData.filter(row => row.factoryname && row.address);
      }
      
      return factories;
    }

    async function saveFactories(factories) {
      try {
        let successCount = 0;
        let errorCount = 0;
        
        for (const factory of factories) {
          try {
            // Generate a simple ID if not provided
            if (!factory.no) {
              factory.no = 'FAC' + Date.now() + Math.random().toString(36).substr(2, 5);
            }
            
            const res = await fetch(FACTORY_API, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(factory)
            });
            
            if (res.ok) {
              successCount++;
            } else {
              errorCount++;
            }
          } catch (error) {
            errorCount++;
            console.error('Error saving factory:', error);
          }
        }
        
        showMessage(
          `Import completed! Success: ${successCount}, Failed: ${errorCount}`,
          'Import Result'
        );
        
        // Refresh the factory list
        fetchFactories();
        
        // Reset import
        resetImport();
        
      } catch (error) {
        console.error('Save factories error:', error);
        showMessage('Failed to save factories to server.', 'Import Error');
      }
    }

    function resetImport() {
      selectedFile = null;
      fileInput.value = '';
      fileInfo.classList.add('hidden');
      importBtn.disabled = true;
    }

    function downloadTemplate() {
      // Create template data
      const templateData = [
        {
          no: 'FAC001',
          factoryname: 'ášáŸ„á„á…á€áŸ’áš á€',
          factoryname_en: 'Factory A',
          sector: 'Manufacturing',
          address: 'á•áŸ’á›á¼áœá‡á¶áá·á›áŸá áŸ¥, á—á¼á˜á· á€',
          village: 'á—á¼á˜á· á€',
          commune: 'áƒá»áŸ† á€',
          district: 'áŸáŸ’ášá»á€ á€',
          province: 'ááŸááŸ’á á€',
          total_workers: 150,
          female_workers: 80,
          admin_name: 'á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ á€',
          admin_phone: '012345678'
        },
        {
          no: 'FAC002', 
          factoryname: 'ášáŸ„á„á…á€áŸ’áš á',
          factoryname_en: 'Factory B',
          sector: 'Services',
          address: 'á•áŸ’á›á¼áœá‡á¶áá·á›áŸá áŸ¦, á—á¼á˜á· á',
          village: 'á—á¼á˜á· á',
          commune: 'áƒá»áŸ† á',
          district: 'áŸáŸ’ášá»á€ á',
          province: 'ááŸááŸ’á á',
          total_workers: 200,
          female_workers: 120,
          admin_name: 'á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„ á',
          admin_phone: '098765432'
        }
      ];
      
      const ws = XLSX.utils.json_to_sheet(templateData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Factories Template");
      XLSX.writeFile(wb, "factory_template.xlsx");
    }

    // --- Custom Message/Confirmation Functions ---
    function openMessageModal(title, text, type, callback) {
      messageTitle.textContent = title;
      messageText.textContent = text;
      messageButtons.innerHTML = '';
      
      if (type === 'confirm') {
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'btn btn-primary';
        confirmBtn.textContent = 'Yes, Delete';
        confirmBtn.onclick = () => {
          callback(true);
          closeModal('messageModal');
        };
        messageButtons.appendChild(confirmBtn);

        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'btn';
        cancelBtn.textContent = 'Cancel';
        cancelBtn.onclick = () => {
          callback(false);
          closeModal('messageModal');
        };
        messageButtons.appendChild(cancelBtn);
        
      } else {
        const closeBtn = document.createElement('button');
        closeBtn.className = 'btn';
        closeBtn.textContent = 'OK';
        closeBtn.onclick = () => closeModal('messageModal');
        messageButtons.appendChild(closeBtn);
      }
      
      messageModal.style.display = 'flex';
    }
    
    function showMessage(message, title = 'Information') {
        openMessageModal(title, message, 'info', () => {});
    }

    // --- Navigation and Section Switching ---
    function showSection(section, event) {
      if (event) event.preventDefault();
      
      // Hide sidebar on mobile
      if (sidebar.classList.contains('open') && window.innerWidth <= 900) {
          sidebar.classList.remove('open');
      }
      
      // Hide all main content sections
      document.getElementById('documents-section').style.display = 'none';
      document.getElementById('factories-section').style.display = 'none';

      // Update active nav link
      document.querySelectorAll('.navbar-links a').forEach(a => a.classList.remove('active'));
      const activeLink = document.querySelector(`.navbar-links a[onclick*="${section}"]`);
      if (activeLink) activeLink.classList.add('active');

      // Show selected section
      if (section === 'documents') {
        document.getElementById('documents-section').style.display = 'block';
        fetchDocuments();
      } else if (section === 'factories') {
        document.getElementById('factories-section').style.display = 'block';
        fetchFactories();
      }
    }

    // Modal functions
    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      currentEditingId = null; // Reset editing state on close
    }

    // --- Document Management Functions ---
    
    async function fetchDocuments() {
      try {
        const res = await fetch(DOC_API);
        const data = await res.json();
        allDocs = data.date || []; 
        renderDocuments(allDocs);
      } catch (error) {
        console.error("Document fetch error:", error);
        showMessage("Failed to fetch documents from server.", "Error");
      }
    }

    function renderDocuments(docs) {
      const tbody = document.getElementById('docTableBody');
      tbody.innerHTML = docs.map(doc => `
        <tr>
          <td>${doc.no || ''}</td>
          <td>${doc.ir || ''}</td>
          <td>${doc.outNo || ''}</td>
          <td>${doc.submitDate?.split('T')[0] || ''}</td>
          <td>${doc.source || ''}</td>
          <td>${doc.doc || ''}</td>
          <td>${doc.officer || ''}</td>
          <td>
            <span class="status-badge ${doc.progress === 'á”á¶á“á’áŸ’áœá¾á…áŸá‰' ? 'status-completed' : 'status-pending'}">
              ${doc.progress || ''}
            </span>
          </td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewDocument('${doc.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editDocument('${doc.id}')">âœï¸ Edit</button>
              <button class="btn" onclick="deleteDocumentConfirm('${doc.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    async function editDocument(id) {
        const doc = allDocs.find(d => d.id && d.id.toString() === id.toString());
        if (doc) {
            currentEditingId = id;
            const form = document.getElementById('docForm');
            
            Object.keys(doc).forEach(key => {
              if (form.elements[key]) {
                 let value = doc[key] || '';
                 if (key === 'submitDate' && value) {
                    value = value.split('T')[0];
                 }
                 form.elements[key].value = value;
              }
            });
            openModal('docModal');
        } else {
            console.error('Document data not found for editing:', id);
            showMessage('Document data not found for editing.', 'Error');
        }
    }

    function viewDocument(id) {
        const doc = allDocs.find(d => d.id && d.id.toString() === id.toString());
        const detailDiv = document.getElementById('docDetail');
        if (doc) {
            detailDiv.innerHTML = `
                <p><strong>á›áŸáá…á¼á›:</strong> <span>${doc.no || 'N/A'}</span></p>
                <p><strong>á›áŸáá›á·áá·á (IR):</strong> <span>${doc.ir || 'N/A'}</span></p>
                <p><strong>á›áŸáá…áŸá‰:</strong> <span>${doc.outNo || 'N/A'}</span></p>
                <p><strong>ááŸ’á„áŸƒááŸ‚á›á·áá·á:</strong> <span>${doc.submitDate ? doc.submitDate.split('T')[0] : 'N/A'}</span></p>
                <p><strong>á¢á„áŸ’á‚á—á¶á–/á”áŸ’ášá—á–:</strong> <span>${doc.source || 'N/A'}</span></p>
                <p><strong>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš:</strong> <span>${doc.doc || 'N/A'}</span></p>
                <p><strong>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›:</strong> <span>${doc.officer || 'N/A'}</span></p>
                <p><strong>áŸáŸ’áá¶á“á—á¶á–:</strong> <span>${doc.progress || 'N/A'}</span></p>
            `;
            openModal('viewDocModal');
        } else {
             showMessage('Document data not found.', 'Error');
        }
    }
    
    function deleteDocumentConfirm(id) {
        openMessageModal(
            'Confirm Deletion', 
            'Are you sure you want to delete this document?', 
            'confirm', 
            (confirmed) => {
                if (confirmed) deleteDocument(id);
            }
        );
    }
    
    async function deleteDocument(id) {
        try {
          const res = await fetch(`${DOC_API}/${id.toString()}`, { method: 'DELETE' });
           if (res.ok) {
                showMessage('Document deleted successfully.', 'Success');
                fetchDocuments();
            } else {
                showMessage('Failed to delete document. Check server logs.', 'Error');
            }
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('An error occurred during deletion.', 'Error');
        }
    }

    // --- Factory Management Functions ---
    
    async function fetchFactories() {
      try {
        const res = await fetch(FACTORY_API);
        const data = await res.json();
        allFactories = data.data || [];
        renderFactories(allFactories);
        return allFactories;
      } catch (error) {
        console.error("Factory fetch error:", error);
        showMessage("Failed to fetch factories from server.", "Error");
        return [];
      }
    }

    function renderFactories(factories) {
      const tbody = document.getElementById('factoryTableBody');
      tbody.innerHTML = factories.map(factory => `
        <tr>
          <td>${factory.no || ''}</td>
          <td>${factory.factoryname || ''}</td>
          <td>${factory.factoryname_en || ''}</td>
          <td>${factory.sector || ''}</td>
          <td>${factory.village || ''}</td>
          <td>${factory.commune || ''}</td>
          <td>${factory.district || ''}</td>
          <td>${factory.province || ''}</td>
          <td>${factory.total_workers || ''}</td>
          <td>${factory.female_workers || ''}</td>
          <td>
            <div class="action-buttons">
              <button class="btn" onclick="viewFactory('${factory.id}')">ğŸ‘ï¸ View</button>
              <button class="btn" onclick="editFactory('${factory.id}')">âœï¸ Edit</button> 
              <button class="btn" onclick="deleteFactoryConfirm('${factory.id}')">ğŸ—‘ï¸ Delete</button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    // FIXED: Factory Edit Function
    function editFactory(id) {
        const factory = allFactories.find(f => f.id && f.id.toString() === id.toString());
        if (factory) {
            currentEditingId = id;
            const form = document.getElementById('factoryForm');
            
            // Reset form first
            form.reset();
            
            // Update modal title
            document.getElementById('factoryModalTitle').textContent = 'á€áŸ‚áŸá˜áŸ’ášá½á›ášáŸ„á„á…á€áŸ’áš';
            
            // Populate form with factory data
            Object.keys(factory).forEach(key => {
                if (form.elements[key]) {
                    let value = factory[key] || '';
                    form.elements[key].value = value;
                }
            });
            
            openModal('factoryModal');
        } else {
            console.error('Factory data not found for editing:', id);
            showMessage('Factory data not found for editing.', 'Error');
        }
    }

    function viewFactory(id) {
        const factory = allFactories.find(f => f.id && f.id.toString() === id.toString());
        const detailDiv = document.getElementById('factoryDetail');
        if (factory) {
            detailDiv.innerHTML = `
                <p><strong>á›áŸáá…á¼á›:</strong> <span>${factory.no || 'N/A'}</span></p>
                <p><strong>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (KH):</strong> <span>${factory.factoryname || 'N/A'}</span></p>
                <p><strong>áˆáŸ’á˜áŸ„áŸ‡ášáŸ„á„á…á€áŸ’áš (EN):</strong> <span>${factory.factoryname_en || 'N/A'}</span></p>
                <p><strong>Sector:</strong> <span>${factory.sector || 'N/A'}</span></p>
                <p><strong>á¢á¶áŸá™áŠáŸ’á‹á¶á“:</strong> <span>${factory.address || 'N/A'}</span></p>
                <p><strong>á—á¼á˜á·:</strong> <span>${factory.village || 'N/A'}</span></p>
                <p><strong>áƒá»áŸ†:</strong> <span>${factory.commune || 'N/A'}</span></p>
                <p><strong>áŸáŸ’ášá»á€:</strong> <span>${factory.district || 'N/A'}</span></p>
                <p><strong>ááŸááŸ’á:</strong> <span>${factory.province || 'N/A'}</span></p>
                <p><strong>á€á˜áŸ’á˜á€ášáŸášá»á”:</strong> <span>${factory.total_workers || 0}</span></p>
                <p><strong>á€á˜áŸ’á˜á€ášáŸáŸ’ášá¸:</strong> <span>${factory.female_workers || 0}</span></p>
                <p><strong>á¢áŸ’á“á€á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„:</strong> <span>${factory.admin_name || 'N/A'}</span></p>
                <p><strong>á›áŸáá‘á¼ášáŸáŸá–áŸ’á‘:</strong> <span>${factory.admin_phone || 'N/A'}</span></p>
            `;
            openModal('viewFactoryModal');
        } else {
             showMessage('Factory data not found.', 'Error');
        }
    }
    
    function deleteFactoryConfirm(id) {
        openMessageModal(
            'Confirm Deletion', 
            'Are you sure you want to delete this factory?', 
            'confirm', 
            (confirmed) => {
                if (confirmed) deleteFactory(id);
            }
        );
    }
    
    // FIXED: Factory Delete Function - Using query parameter as shown in network log
    async function deleteFactory(id) {
        try {
            console.log('Deleting factory with ID:', id);
            
            // Use query parameter as shown in your network log: fac?id=6
            const res = await fetch(`${FACTORY_API}?id=${id}`, { 
                method: 'DELETE'
            });
            
            console.log('Delete response status:', res.status);
            
            if (res.ok || res.status === 204) {
                showMessage('Factory deleted successfully.', 'Success');
                // Remove from local array and re-render
                allFactories = allFactories.filter(factory => factory.id.toString() !== id.toString());
                renderFactories(allFactories);
            } else {
                showMessage(`Failed to delete factory. Server returned: ${res.status}`, 'Error');
            }
            
        } catch (error) {
            console.error('Delete error:', error);
            showMessage('An error occurred during deletion: ' + error.message, 'Error');
        }
    }

    // --- Form Submission Handlers ---
    document.getElementById('docForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Show loading state
      const submitBtn = document.getElementById('docSubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      try {
        const url = currentEditingId ? `${DOC_API}/${currentEditingId}` : DOC_API;
        const method = currentEditingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showMessage(currentEditingId ? 'Document updated!' : 'Document saved!', 'Success');
          closeModal('docModal');
          fetchDocuments();
        } else {
           const errorText = await res.text();
           showMessage(`Failed to save/update document. Server response: ${errorText}`, 'Error');
        }
      } catch (error) {
        console.error('Save error:', error);
        showMessage('An error occurred while communicating with the server.', 'Error');
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // FIXED: Factory Form Submission
    document.getElementById('factoryForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData);
      
      // Show loading state
      const submitBtn = document.getElementById('factorySubmitBtn');
      const originalText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<span class="loading"></span> á€áŸ†á–á»á„ášá€áŸ’áŸá¶á‘á»á€...';
      submitBtn.disabled = true;
      
      // Use the same pattern as documents
      const isEditing = !!currentEditingId;
      
      // Ensure numeric conversions
      data.total_workers = parseInt(data.total_workers, 10) || 0;
      data.female_workers = parseInt(data.female_workers, 10) || 0;
      
      try {
        const url = isEditing ? `${FACTORY_API}/${currentEditingId}` : FACTORY_API;
        const method = isEditing ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        if (res.ok) {
          showMessage(isEditing ? 'Factory updated successfully!' : 'Factory saved successfully!', 'Success');
          closeModal('factoryModal');
          fetchFactories();
        } else {
           const errorText = await res.text();
           showMessage(`Failed to ${isEditing ? 'update' : 'save'} factory. Server response: ${errorText}`, 'Error');
        }
      } catch (error) {
        console.error('Save error:', error);
        showMessage('An error occurred while communicating with the server.', 'Error');
      } finally {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
      }
    });

    // --- Search functionality ---
    document.getElementById('docSearch').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allDocs.filter(doc => 
        Object.values(doc).some(val => 
          val?.toString().toLowerCase().includes(term)
        )
      );
      renderDocuments(filtered);
    });

    document.getElementById('factorySearch').addEventListener('input', (e) => {
      const term = e.target.value.toLowerCase();
      const filtered = allFactories.filter(factory => 
        Object.values(factory).some(val => 
          val?.toString().toLowerCase().includes(term)
        )
      );
      renderFactories(filtered);
    });
    
    // Event Listeners for Modals
    document.getElementById('openDocForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('docForm').reset();
      openModal('docModal');
    });
    
    document.getElementById('openFactoryForm').addEventListener('click', () => {
      currentEditingId = null;
      document.getElementById('factoryModalTitle').textContent = 'á”á‰áŸ’á…á¼á›ášáŸ„á„á…á€áŸ’ášááŸ’á˜á¸';
      document.getElementById('factoryForm').reset();
      openModal('factoryModal');
    });

    // Excel Export Functions
    document.getElementById('exportDocExcel').addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(allDocs);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Documents");
      XLSX.writeFile(wb, "documents.xlsx");
    });

    document.getElementById('exportFactoryExcel').addEventListener('click', () => {
      const ws = XLSX.utils.json_to_sheet(allFactories);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Factories");
      XLSX.writeFile(wb, "factories.xlsx");
    });

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      showSection('documents');
    });
  </script>
</body>
</html>