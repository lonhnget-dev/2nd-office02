<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Office Management System</title>
  <link rel="stylesheet" href="style.css">

  <!-- Excel Export Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
  <!-- Navigation Bar -->
  <nav class="navbar">
    <img src="https://1000logos.net/wp-content/uploads/2017/02/Facebook-Logosu.png" alt="Logo">
    <ul>
      <li>Home</li>
      <li>Search</li>
      <li>Documents</li>
      <li>Map</li>
    </ul>
    <div class="login"><a href="#">Login</a></div>
  </nav>

  <!-- Add Document + Filter Section -->
  <section class="add-document">
    <button id="openForm">â• á”á‰áŸ’á…á¼á›á¯á€áŸá¶áš</button>

    <div class="filter-section">
      <label>á”á„áŸ’á á¶á‰á…áŸ†á“á½á“:</label>
      <select id="showCount">
        <option value="15">15</option>
        <option value="30">30</option>
        <option value="60">60</option>
        <option value="100">100</option>
        <option value="all">All</option>
      </select>

      <input type="search" id="searchBox" placeholder="áŸáŸ’áœáŸ‚á„ášá€á¯á€áŸá¶áš...">
      <button id="exportExcelBtn">ğŸ“¥ á‘á¶á‰á™á€ Excel</button>
    </div>
  </section>

  <!-- Table -->
  <div class="table-container">
    <table id="documentTable">
      <thead>
        <tr>
          <th>á›áŸáá…á¼á›</th>
          <th>á›áŸáá›á·áá·á(IR)</th>
          <th>á›áŸáá…áŸá‰</th>
          <th>ááŸ’á„áŸƒááŸ‚</th>
          <th>á¢á„áŸ’á‚á—á¶á–</th>
          <th>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</th>
          <th>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</th>
          <th>áŸáŸ’áá¶á“á—á¶á–</th>
          <th>áŸá€á˜áŸ’á˜á—á¶á–</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
  </div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Form Modal -->
  <div id="myForm">
    <h2 class="form-title">á”á‰áŸ’á…á¼á›á¯á€áŸá¶áš</h2>

    <form id="contactForm" class="styled-form">
      <div class="form-group">
        <label>á›áŸáá…á¼á›</label>
        <input type="text" name="no" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá…á¼á›" required>
      </div>

      <div class="form-group">
        <label>á›áŸáá›á·áá·á(IR)</label>
        <input type="text" name="ir" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá›á·áá·á" required>
      </div>

      <div class="form-group">
        <label>á›áŸáá…áŸá‰</label>
        <input type="text" name="outNo" placeholder="á”á‰áŸ’á…á¼á›á›áŸáá…áŸá‰">
      </div>

      <div class="form-group">
        <label>ááŸ’á„áŸƒááŸ‚</label>
        <input type="date" name="submitDate">
      </div>

      <div class="form-group">
        <label>á¢á„áŸ’á‚á—á¶á–</label>
        <input type="text" name="source" placeholder="á”á‰áŸ’á…á¼á›á¢á„áŸ’á‚á—á¶á–">
      </div>

      <div class="form-group">
        <label>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš</label>
        <input type="text" name="doc" placeholder="á§á‘á¶á ášááŸ: á›á·áá·áá‡á¶á•áŸ’á›á¼áœá€á¶áš">
      </div>

      <div class="form-group">
        <label>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›</label>
        <input type="text" name="officer" placeholder="áˆáŸ’á˜áŸ„áŸ‡á˜á“áŸ’ášáŸ’áá¸">
      </div>

      <div class="form-group">
        <label>áŸáŸ’áá¶á“á—á¶á–</label>
        <select name="status">
          <option value="">á‡áŸ’ášá¾áŸášá¾áŸáŸáŸ’áá¶á“á—á¶á–</option>
          <option value="á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš">á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš</option>
          <option value="á”á¶á“á”á‰áŸ’á…á”áŸ‹">á”á¶á“á”á‰áŸ’á…á”áŸ‹</option>
          <option value="á˜á·á“á‘á¶á“áŸ‹á…á¶á”áŸ‹á•áŸ’áá¾á˜">á˜á·á“á‘á¶á“áŸ‹á…á¶á”áŸ‹á•áŸ’áá¾á˜</option>
        </select>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-submit">ášá€áŸ’áŸá¶á‘á»á€</button>
        <button type="button" id="closeForm" class="btn-close">á”á·á‘</button>
      </div>
    </form>
  </div>
  <!-- ===== View Document Modal ===== -->
<div id="viewModal">
  <div class="view-content">
    <h2>Document Summary</h2>
    <div id="viewDetails"></div>
    <button id="closeViewBtn">Close</button>
  </div>
</div>

  <script>
  const API_URL = "http://localhost:4000/doc";
  const form = document.getElementById("contactForm");
  const tableBody = document.getElementById("tableBody");
  const formModal = document.getElementById("myForm");
  const overlay = document.getElementById("overlay");
  const openBtn = document.getElementById("openForm");
  const closeBtn = document.getElementById("closeForm");
  const searchInput = document.getElementById("searchBox");
  let editingId = null;
  let allDocs = [];

  // === Open / Close Form ===
  openBtn.onclick = () => {
    formModal.style.display = 'block';
    overlay.style.display = 'block';
    form.reset();
    editingId = null;
  };
  closeBtn.onclick = overlay.onclick = () => {
    formModal.style.display = 'none';
    overlay.style.display = 'none';
  };

  // === Fetch Documents ===
  async function fetchDocument() {
    try {
      const res = await fetch(API_URL);
      const data = await res.json();
      allDocs = data.date || [];
      renderTable(allDocs);
    } catch (error) {
      console.error("Fetch Error:", error);
    }
  }

  // === Render Table ===
  function renderTable(docs) {
    tableBody.innerHTML = "";
    docs.forEach((doc) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${doc.no}</td>
        <td>${doc.ir}</td>
        <td>${doc.outNo}</td>
        <td>${doc.submitDate?.split("T")[0] || ""}</td>
        <td>${doc.source}</td>
        <td>${doc.doc}</td>
        <td>${doc.officer || '-'}</td>
        <td>${doc.status || '-'}</td>
<td>
  <button class="viewBtn" data-id="${doc.id}">View</button>
  <button class="editBtn" data-id="${doc.id}">Edit</button>
  <button class="deleteBtn" data-id="${doc.id}">Delete</button>
</td>
      `;

      // Edit
      row.querySelector(".editBtn").onclick = () => openEditForm(doc);
      // Delete
      row.querySelector(".deleteBtn").onclick = () => deleteDoc(doc.id);
      tableBody.appendChild(row);
    });
  }

  // === Search Function ===
  searchInput.addEventListener("input", () => {
    const q = searchInput.value.toLowerCase();
    const filtered = allDocs.filter((d) =>
      [d.no, d.ir, d.source, d.doc, d.officer]
        .some(v => v?.toLowerCase().includes(q))
    );
    renderTable(filtered);
  });

  // === Submit Form ===
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = Object.fromEntries(new FormData(form));
    const method = editingId ? "PUT" : "POST";
    const url = editingId ? `${API_URL}/${editingId}` : API_URL;

    try {
      const res = await fetch(url, {
        method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(formData),
      });
      if (res.ok) {
        alert(editingId ? "á”á¶á“á€áŸ‚á”áŸ’ášáŸ‚á¯á€áŸá¶áš!" : "á”á¶á“ášá€áŸ’áŸá¶á‘á»á€á¯á€áŸá¶ášááŸ’á˜á¸!");
        formModal.style.display = 'none';
        overlay.style.display = 'none';
        fetchDocument();
      } else alert("á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€á¯á€áŸá¶áš!");
    } catch (err) {
      console.error("Save Error:", err);
    }
  });

  // === Edit ===
  function openEditForm(doc) {
    editingId = doc.id;
    formModal.style.display = 'block';
    overlay.style.display = 'block';
    Object.keys(form.elements).forEach((key) => {
      if (form.elements[key]?.name) {
        form.elements[key].value = doc[form.elements[key].name] || "";
      }
    });
  }

  // === Delete ===
  async function deleteDoc(id) {
    if (!confirm("áá¾á¢áŸ’á“á€á–á·áá‡á¶á…á„áŸ‹á›á»á”á¯á€áŸá¶ášá“áŸáŸ‡á˜áŸ‚á“á‘áŸ?")) return;
    try {
      const res = await fetch(`${API_URL}/${id}`, { method: "DELETE" });
      const data = await res.json();
      alert(data.message);
      fetchDocument();
    } catch (err) {
      console.error("Delete Error:", err);
    }
  }
  // ===== View Document Function =====
document.addEventListener("click", async (e) => {
  if (e.target.classList.contains("viewBtn")) {
    const id = e.target.getAttribute("data-id");

    try {
      const res = await fetch(`http://localhost:4000/doc/${id}`);
      const data = await res.json();

      if (data.doc) {
        const d = data.doc;
        const viewDetails = document.getElementById("viewDetails");
        viewDetails.innerHTML = `
          <p><strong>á›áŸáá…á¼á›:</strong> ${d.no}</p>
          <p><strong>á›áŸáá›á·áá·á (IR):</strong> ${d.ir}</p>
          <p><strong>á›áŸáá…áŸá‰:</strong> ${d.outNo || '-'}</p>
          <p><strong>ááŸ’á„áŸƒááŸ‚:</strong> ${d.submitDate ? new Date(d.submitDate).toLocaleDateString() : '-'}</p>
          <p><strong>á¢á„áŸ’á‚á—á¶á–:</strong> ${d.source || '-'}</p>
          <p><strong>á”áŸ’ášá—áŸá‘á¯á€áŸá¶áš:</strong> ${d.doc || '-'}</p>
          <p><strong>á˜á“áŸ’ášáŸ’áá¸á‘á‘á½á›:</strong> ${d.officer || '-'}</p>
          <p><strong>áŸáŸ’áá¶á“á—á¶á–:</strong> ${d.status || '-'}</p>
        `;

        document.getElementById("viewModal").style.display = "flex";
      } else {
        alert("Document not found.");
      }
    } catch (err) {
      console.error("View error:", err);
      alert("Failed to fetch document details.");
    }
  }
});

// ===== Close View Modal =====
document.getElementById("closeViewBtn").addEventListener("click", () => {
  document.getElementById("viewModal").style.display = "none";
});

  // === Export to Excel ===
  document.getElementById("exportExcelBtn").onclick = () => {
    const table = document.getElementById("documentTable");
    const ws = XLSX.utils.table_to_sheet(table);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Documents");
    XLSX.writeFile(wb, "documents.xlsx");
  };

  window.addEventListener("DOMContentLoaded", fetchDocument);
  </script>
</body>
</html>