<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management System</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root {
      --primary-color: #3498db;
    }
    
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f8f9fa;
      color: #2c3e50;
      line-height: 1.6;
      margin: 0;
      padding: 20px;
    }
    
    .page-header {
      background: #fff;
      color: #2c3e50;
      padding: 30px;
      border-radius: 10px;
      margin-bottom: 25px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    /* Statistics Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .stat-card {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 0.9rem;
      color: #6c757d;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .stat-icon {
      font-size: 2rem;
      color: var(--primary-color);
      margin-bottom: 10px;
    }
    
    .control-section {
      background: #fff;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .table-container {
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      margin-bottom: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      border: 1px solid #e1e5e9;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    /* Role badges */
    .role-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .role-badge-admin {
      background: rgba(231, 76, 60, 0.2);
      color: #e74c3c;
      border: 1px solid rgba(231, 76, 60, 0.3);
    }
    
    .role-badge-officer {
      background: rgba(52, 152, 219, 0.2);
      color: #3498db;
      border: 1px solid rgba(52, 152, 219, 0.3);
    }
    
    .role-badge-manager {
      background: rgba(46, 204, 113, 0.2);
      color: #2ecc71;
      border: 1px solid rgba(46, 204, 113, 0.3);
    }
    
    .loading {
      display: inline-block;
      width: 18px;
      height: 18px;
      border: 2px solid rgba(52, 152, 219, 0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* User status */
    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-active {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #b8e0e6;
    }
    
    .status-inactive {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    
    <!-- Users Section -->
    <section id="users-section">
      <header class="page-header">
        <h1 class="mb-2"><i class="bi bi-people"></i> ការគ្រប់គ្រងអ្នកប្រើប្រាស់</h1>
        <p class="text-muted mb-0">User Management System</p>
      </header>

      <!-- Statistics Cards -->
      <div class="stats-container">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-people"></i>
          </div>
          <div class="stat-number" id="totalUsers">0</div>
          <div class="stat-label">អ្នកប្រើប្រាស់សរុប</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-person-gear"></i>
          </div>
          <div class="stat-number" id="totalAdmins">0</div>
          <div class="stat-label">អ្នកគ្រប់គ្រង</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-person-check"></i>
          </div>
          <div class="stat-number" id="totalOfficers">0</div>
          <div class="stat-label">មន្ត្រី</div>
        </div>
        
        <div class="stat-card">
          <div class="stat-icon">
            <i class="bi bi-person"></i>
          </div>
          <div class="stat-number" id="totalManagers">0</div>
          <div class="stat-label">អ្នកគ្រប់គ្រងរង</div>
        </div>
      </div>

      <div class="control-section d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
        <button class="btn btn-primary" id="openUserForm">
          <i class="bi bi-plus-circle"></i> បញ្ចូលអ្នកប្រើប្រាស់ថ្មី
        </button>
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <input type="search" class="form-control" id="userSearch" placeholder="ស្វែងរកអ្នកប្រើប្រាស់..." style="width: auto;">
          <button class="btn btn-outline-secondary" id="exportUserExcel">
            <i class="bi bi-download"></i> ទាញយក Excel
          </button>
        </div>
      </div>

      <div class="table-container">
        <div class="table-wrapper">
          <table class="table table-hover mb-0" id="userTable">
            <thead class="table-light">
              <tr>
                <th>#</th>
                <th>ឈ្មោះ</th>
                <th>ទូរស័ព្ទ</th>
                <th>អ៊ីមែល</th>
                <th>តួនាទី</th>
                <th>មុខងារ</th>
                <th>សង្កាត់</th>
                <th>ស្ថានភាព</th>
                <th>សកម្មភាព</th>
              </tr>
            </thead>
            <tbody id="userTableBody">
              <tr>
                <td colspan="9" class="text-center text-muted py-4">
                  <div class="loading"></div> កំពុងផ្ទុកទិន្នន័យ...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

  </div>

  <!-- User Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="userModalTitle">បញ្ចូលអ្នកប្រើប្រាស់ថ្មី</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="userForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">ឈ្មោះ *</label>
                <input type="text" class="form-control" name="name" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ទូរស័ព្ទ *</label>
                <input type="text" class="form-control" name="phone" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">អ៊ីមែល *</label>
                <input type="email" class="form-control" name="email" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">ពាក្យសម្ងាត់ *</label>
                <input type="password" class="form-control" name="password" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">តួនាទី *</label>
                <select class="form-select" name="role" required>
                  <option value="">-- ជ្រើសរើសតួនាទី --</option>
                  <option value="admin">អ្នកគ្រប់គ្រង</option>
                  <option value="officer">មន្ត្រី</option>
                  <option value="manager">អ្នកគ្រប់គ្រងរង</option>
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">មុខងារ *</label>
                <input type="text" class="form-control" name="function" required>
              </div>
              <div class="col-md-6">
                <label class="form-label">សង្កាត់ *</label>
                <select id="sangkatSelect" class="form-control" name="sangkat" multiple="multiple" required>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="col-md-6">
                <label class="form-label">ស្ថានភាព</label>
                <select class="form-select" name="status">
                  <option value="active">សកម្ម</option>
                  <option value="inactive">មិនសកម្ម</option>
                </select>
              </div>
              <div class="col-12">
                <label class="form-label">អាសយដ្ឋាន</label>
                <textarea class="form-control" name="address" rows="2" placeholder="បញ្ចូលអាសយដ្ឋាន..."></textarea>
              </div>

            <div class="modal-footer mt-4">
              <button type="submit" class="btn btn-primary" id="userSubmitBtn">
                <i class="bi bi-save"></i> រក្សាទុក
              </button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">បិទ</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Message Modal -->
  <div class="modal fade" id="messageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-light">
          <h5 class="modal-title" id="messageTitle">Information</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p id="messageText"></p>
        </div>
        <div class="modal-footer" id="messageButtons">
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- JavaScript for User Management -->
  <script>
    // Configuration
    const USER_API = "https://uat-api-office2.thithabirdnest.com/user";
    
    // Global variables
    let allUsers = [];
    let currentEditingId = null;

    // Utility functions
    function showMessage(message, title = 'Information') {
      const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
      document.getElementById('messageTitle').textContent = title;
      document.getElementById('messageText').textContent = message;
      messageModal.show();
    }

    function formatNumber(num) {
      return new Intl.NumberFormat().format(num);
    }

    function getRoleDisplayName(role) {
      switch(role) {
        case 'admin': return 'អ្នកគ្រប់គ្រង';
        case 'officer': return 'មន្ត្រី';
        case 'manager': return 'អ្នកគ្រប់គ្រងរង';
        default: return role;
      }
    }

    function getRoleBadgeClass(role) {
      switch(role) {
        case 'admin': return 'role-badge-admin';
        case 'officer': return 'role-badge-officer';
        case 'manager': return 'role-badge-manager';
        default: return 'role-badge-officer';
      }
    }

    function getStatusDisplayName(status) {
      switch(status) {
        case 'active': return 'សកម្ម';
        case 'inactive': return 'មិនសកម្ម';
        default: return status;
      }
    }

    function getStatusBadgeClass(status) {
      switch(status) {
        case 'active': return 'status-active';
        case 'inactive': return 'status-inactive';
        default: return 'status-active';
      }
    }

    function validateEmail(email) {
      const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return re.test(email);
    }

    function validatePhone(phone) {
      const re = /^[0-9+\-\s()]+$/;
      return re.test(phone);
    }

    // User Management functionality
    class UsersManager {
      constructor() {
        this.allUsers = [];
      }

      init() {
        this.bindEvents();
        this.fetchUsers();
      }

      bindEvents() {
        // Add user button
        document.getElementById('openUserForm').addEventListener('click', () => {
          this.openUserForm();
        });

        // Export button
        document.getElementById('exportUserExcel').addEventListener('click', () => {
          this.exportToExcel();
        });

        // Search functionality
        document.getElementById('userSearch').addEventListener('input', (e) => {
          this.searchUsers(e.target.value);
        });

        // Form submission
        document.getElementById('userForm').addEventListener('submit', (e) => {
          this.handleFormSubmit(e);
        });

        // Event delegation for action buttons
        document.getElementById('userTableBody').addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          if (!row) return;

          const id = row.getAttribute('data-id');
          if (!id) return;

          if (e.target.closest('.btn-outline-primary')) {
            this.viewUser(id);
          } else if (e.target.closest('.btn-outline-secondary')) {
            this.editUser(id);
          } else if (e.target.closest('.btn-outline-danger')) {
            this.deleteUserConfirm(id);
          }
        });
      }

      async fetchUsers() {
        try {
          const res = await fetch(USER_API);
          const data = await res.json();
          this.allUsers = data.data || [];
          this.renderUsers(this.allUsers);
          this.updateStatistics();
        } catch (error) {
          console.error("User fetch error:", error);
          showMessage("Failed to fetch users from server.", "Error");
          // Load sample data if API fails
          this.loadSampleData();
        }
      }

    

      updateStatistics() {
        const totalUsers = this.allUsers.length;
        const totalAdmins = this.allUsers.filter(user => user.role === 'admin').length;
        const totalOfficers = this.allUsers.filter(user => user.role === 'officer').length;
        const totalManagers = this.allUsers.filter(user => user.role === 'manager').length;

        document.getElementById('totalUsers').textContent = formatNumber(totalUsers);
        document.getElementById('totalAdmins').textContent = formatNumber(totalAdmins);
        document.getElementById('totalOfficers').textContent = formatNumber(totalOfficers);
        document.getElementById('totalManagers').textContent = formatNumber(totalManagers);
      }

      renderUsers(users) {
        const tbody = document.getElementById('userTableBody');

        if (users.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="9" class="text-center text-muted py-4">
                មិនមានទិន្នន័យ
              </td>
            </tr>
          `;
          return;
        }

        tbody.innerHTML = users.map((user, index) => `
          <tr data-id="${user.id}">
            <td class="text-muted">${index + 1}</td>
            <td>
              <div class="fw-semibold">${user.name || ''}</div>
              <div class="text-muted small">${user.email || ''}</div>
            </td>
            <td>${user.phone || ''}</td>
            <td>${user.email || ''}</td>
            <td>
              <span class="role-badge ${getRoleBadgeClass(user.role)}">
                ${getRoleDisplayName(user.role)}
              </span>
            </td>
            <td>${user.function || ''}</td>
            <td>${user.commune || ''}</td>
            <td>
              <span class="status-badge ${getStatusBadgeClass(user.status || 'active')}">
                ${getStatusDisplayName(user.status || 'active')}
              </span>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" title="View">
                  <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-outline-secondary" title="Edit">
                  <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-outline-danger" title="Delete">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
            </td>
          </tr>
        `).join('');

        this.updateStatistics();
      }

      searchUsers(query) {
        if (!query.trim()) {
          this.renderUsers(this.allUsers);
          return;
        }

        const filteredUsers = this.allUsers.filter(user =>
          Object.values(user).some(value =>
            value && value.toString().toLowerCase().includes(query.toLowerCase())
          )
        );
        this.renderUsers(filteredUsers);
      }

      openUserForm(editId = null) {
        currentEditingId = editId;
        const modal = new bootstrap.Modal(document.getElementById('userModal'));
        const modalTitle = document.getElementById('userModalTitle');
        const form = document.getElementById('userForm');

        modalTitle.textContent = editId ? 'កែសម្រួលអ្នកប្រើប្រាស់' : 'បញ្ចូលអ្នកប្រើប្រាស់ថ្មី';
        form.reset();

        if (editId) {
          this.populateForm(editId);
        }

        modal.show();
      }

      populateForm(id) {
        const user = this.allUsers.find(u => u.id.toString() === id.toString());
        if (!user) return;

        const form = document.getElementById('userForm');
        form.elements['name'].value = user.name || '';
        form.elements['phone'].value = user.phone || '';
        form.elements['email'].value = user.email || '';
        form.elements['password'].value = ''; // Don't populate password for security
        form.elements['role'].value = user.role || '';
        form.elements['function'].value = user.function || '';
        form.elements['sangkat'].value = user.sangkat || '';
        form.elements['status'].value = user.status || 'active';
        form.elements['address'].value = user.address || '';
      }
// create and edit user
      async handleFormSubmit(e) {
    e.preventDefault();
    const formData = new FormData(e.target);

    // Convert FormData to object
    const data = Object.fromEntries(formData);

    // Get multiple selected sangkat values
    const sangkatSelect = e.target.elements['sangkat'];
const selectedSangkats = Array.from(sangkatSelect.selectedOptions)
    .map(opt => Number(opt.value));  // Convert each ID to number

data.communeIds = selectedSangkats;

    // Validation
    if (!data.name || !data.phone || !data.email || !data.password || !data.role || !data.function || selectedSangkats.length === 0) {
        showMessage('សូមបំពេញព័ត៌មានចាំបាច់ទាំងអស់', 'Error');
        return;
    }

    if (!validateEmail(data.email)) {
        showMessage('សូមបញ្ចូលអ៊ីមែលដែលត្រឹមត្រូវ', 'Error');
        return;
    }

    if (!validatePhone(data.phone)) {
        showMessage('សូមបញ្ចូលលេខទូរស័ព្ទដែលត្រឹមត្រូវ', 'Error');
        return;
    }

    const submitBtn = document.getElementById('userSubmitBtn');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="loading"></span> កំពុងរក្សាទុក...';
    submitBtn.disabled = true;

    try {
        let response;
        let apiUrl;

        // Use the same API endpoint for both create and update
        if (currentEditingId) {
            // Update existing user (PUT request)
            apiUrl = `${USER_API}/${currentEditingId}`;
            response = await fetch(apiUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        } else {
            // Create new user (POST request)
            apiUrl = USER_API;
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        const result = await response.json();

        if (!response.ok) throw new Error(result.message || 'Server error');

        // Update local list and UI
        if (currentEditingId) {
            const index = this.allUsers.findIndex(u => u.id.toString() === currentEditingId.toString());
            if (index !== -1) {
                this.allUsers[index] = { ...this.allUsers[index], ...data, id: currentEditingId };
            }
            showMessage('User updated successfully', 'Success');
        } else {
            // Add the new user with the ID from the response
            const newUser = { ...data, id: result.data.id || Date.now() };
            this.allUsers.push(newUser);
            showMessage('User created successfully', 'Success');
        }

        const modal = bootstrap.Modal.getInstance(document.getElementById('userModal'));
        modal.hide();
        this.renderUsers(this.allUsers);

    } catch (error) {
        console.error('Save error:', error);
        showMessage(error.message || 'Failed to save user', 'Error');
    } finally {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    }
}
      viewUser(id) {
        const user = this.allUsers.find(u => u.id.toString() === id.toString());
        if (!user) {
          showMessage('User not found', 'Error');
          return;
        }
        
        let detailHTML = `
          <strong>ឈ្មោះ:</strong> ${user.name || ''}<br>
          <strong>ទូរស័ព្ទ:</strong> ${user.phone || ''}<br>
          <strong>អ៊ីមែល:</strong> ${user.email || ''}<br>
          <strong>តួនាទី:</strong> ${getRoleDisplayName(user.role)}<br>
          <strong>មុខងារ:</strong> ${user.function || ''}<br>
          <strong>សង្កាត់:</strong> ${user.sangkat || ''}<br>
          <strong>ស្ថានភាព:</strong> ${getStatusDisplayName(user.status || 'active')}<br>
        `;
        
        if (user.address) {
          detailHTML += `<strong>អាសយដ្ឋាន:</strong> ${user.address}<br>`;
        }
        
        if (user.start_date) {
          detailHTML += `<strong>កាលបរិច្ឆេទចាប់ផ្តើម:</strong> ${user.start_date}<br>`;
        }
        
        if (user.end_date) {
          detailHTML += `<strong>កាលបរិច្ឆេទបញ្ចប់:</strong> ${user.end_date}<br>`;
        }
        
        detailHTML += `<strong>កាលបរិច្ឆេទបង្កើត:</strong> ${user.created_at ? new Date(user.created_at).toLocaleDateString('km-KH') : ''}`;
        
        showMessage(detailHTML, 'ព័ត៌មានលម្អិតអ្នកប្រើប្រាស់');
      }

      editUser(id) {
        this.openUserForm(id);
      }

      deleteUserConfirm(id) {
        if (confirm('តើអ្នកប្រាកដថាចង់លុបអ្នកប្រើប្រាស់នេះមែនទេ?')) {
          this.deleteUser(id);
        }
      }

      deleteUser(id) {
        try {
          this.allUsers = this.allUsers.filter(u => u.id.toString() !== id.toString());
          this.renderUsers(this.allUsers);
          showMessage('User deleted successfully', 'Success');
        } catch (error) {
          console.error('Delete error:', error);
          showMessage('Failed to delete user', 'Error');
        }
      }

      exportToExcel() {
        try {
          // Prepare data for export
          const exportData = this.allUsers.map(user => ({
            'ឈ្មោះ': user.name,
            'ទូរស័ព្ទ': user.phone,
            'អ៊ីមែល': user.email,
            'តួនាទី': getRoleDisplayName(user.role),
            'មុខងារ': user.function,
            'សង្កាត់': user.sangkat,
            'ស្ថានភាព': getStatusDisplayName(user.status || 'active'),
            'អាសយដ្ឋាន': user.address || '',
          }));

          const ws = XLSX.utils.json_to_sheet(exportData);
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Users");
          XLSX.writeFile(wb, "users.xlsx");
          showMessage('Excel file downloaded successfully', 'Success');
        } catch (error) {
          console.error('Export error:', error);
          showMessage('Failed to export to Excel', 'Error');
        }
      }
    }


//
document.addEventListener("DOMContentLoaded", async () => {
  const sangkatSelect = document.getElementById("sangkatSelect");

  try {
    const response = await fetch("https://uat-api-office2.thithabirdnest.com/get_commune");
    const data = await response.json();
    const communes = data.data;
    // Assuming your backend returns an array of communes like:
    // [{ id: 1, name: "Commune A" }, { id: 2, name: "Commune B" }]
    communes.forEach(commune => {
      const option = document.createElement("option");
      option.value = commune.id;
      option.textContent = commune.name;
      sangkatSelect.appendChild(option);
    });


  } catch (error) {
    console.error("Failed to load communes:", error);
  }
});






    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      window.usersManager = new UsersManager();
      window.usersManager.init();
    });
  </script>
</body>
</html>