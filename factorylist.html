<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Factory List</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Khmer:wght@300;400;500&display=swap" rel="stylesheet"/>

  <!-- XLSX Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: "Noto Sans Khmer", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }

    .container {
      width: 95%;
      margin: auto;
      margin-top: 20px;
    }

    h2 {
      font-weight: 500;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .search-box input {
      padding: 8px 12px;
      width: 250px;
      border-radius: 5px;
      border: 1px solid #aaa;
    }

    .btn {
      padding: 8px 12px;
      background: #1a73e8;
      border: none;
      border-radius: 5px;
      color: white;
      cursor: pointer;
    }

    .btn:hover {
      background: #0e57b5;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 6px;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    /* Modal */
    #factoryModal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
      background: white;
      margin: 8% auto;
      padding: 20px;
      width: 40%;
      border-radius: 8px;
    }

    .close-btn {
      float: right;
      font-size: 18px;
      cursor: pointer;
      padding: 4px 8px;
      background: #d9534f;
      color: white;
      border-radius: 4px;
    }

    .action-buttons button, .action-buttons a {
      margin-right: 4px;
    }

    .view-btn {
      background: #4caf50;
      border: none;
      padding: 6px 10px;
      color: white;
      border-radius: 4px;
      cursor: pointer;
    }

    .btn-link {
      background: #007bff;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      text-decoration: none;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>Factory List</h2>

  <div class="top-bar">
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search factory name..." />
    </div>
    <button id="exportExcel" class="btn">Export Excel</button>
  </div>

  <table id="factoryTable">
    <thead>
      <tr>
        <th>ល.រ</th>
        <th>ឈ្មោះរោងចក្រ</th>
        <th>Factory Name (EN)</th>
        <th>Sector</th>
        <th>Village</th>
        <th>Commune</th>
        <th>District</th>
        <th>Province</th>
        <th>Total Workers</th>
        <th>Female Workers</th>
        <th>Admin Name</th>
        <th>Admin Phone</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="factoryTableBody"></tbody>
  </table>
</div>

<!-- Modal -->
<div id="factoryModal">
  <div class="modal-content">
    <span class="close-btn">X</span>
    <h3>Factory Detail</h3>
    <div id="factoryDetail"></div>
  </div>
</div>

<script>
// =============================
// Load factories from backend
// =============================
async function loadFactories() {
  try {
    const res = await fetch("http://localhost:4000/fac"); // API endpoint
    const factories = await res.json();
    window.allFactories = factories.data;
    renderFactoryTable(factories.data);
  } catch (err) {
    console.error("Error loading factories:", err);
  }
}

// Render into table
function renderFactoryTable(list) {
  const tbody = document.getElementById("factoryTableBody");
  tbody.innerHTML = "";

  list.forEach((f, index) => {
    const row = `
      <tr>
        <td>${index + 1}</td>
        <td>${f.factoryname || "-"}</td>
        <td>${f.factoryname_en || "-"}</td>
        <td>${f.sector || "-"}</td>
        <td>${f.village || "-"}</td>
        <td>${f.commune || "-"}</td>
        <td>${f.district || "-"}</td>
        <td>${f.province || "-"}</td>
        <td>${f.total_workers || "-"}</td>
        <td>${f.female_workers || "-"}</td>
        <td>${f.admin_name || "-"}</td>
        <td>${f.admin_phone || "-"}</td>
        <td class="action-buttons">
          <button class="view-btn" data-id="${f.id}">View</button>
          <a href="editpage.html?id=${f.id}" class="btn-link" target="_blank">Editing Link</a>
        </td>
      </tr>
    `;
    tbody.insertAdjacentHTML("beforeend", row);
  });
}

// =============================
// Search
// =============================
document.getElementById("searchInput").addEventListener("input", function () {
  const q = this.value.toLowerCase();
  const filtered = window.allFactories.filter(f =>
    (f.factoryname || "").toLowerCase().includes(q)
  );
  renderFactoryTable(filtered);
});

// =============================
// View Modal
// =============================
document.addEventListener("click", async function (e) {
  if (e.target.classList.contains("view-btn")) {
    const id = e.target.getAttribute("data-id");
    const res = await fetch(`http://localhost:4000/fac/${id}`);
    const f = await res.json();

    const detail = `
      <p><strong>លេខចូល:</strong> ${f.no}</p>
      <p><strong>ឈ្មោះរោងចក្រ:</strong> ${f.factoryname}</p>
      <p><strong>អាសយដ្ឋាន:</strong> ${f.address}</p>
    `;
    document.getElementById("factoryDetail").innerHTML = detail;
    document.getElementById("factoryModal").style.display = "block";
  }
});

document.addEventListener("click", function (e) {
  if (e.target.classList.contains("close-btn") || e.target.id === "factoryModal") {
    document.getElementById("factoryModal").style.display = "none";
  }
});

// =============================
// Export Excel
// =============================
document.getElementById("exportExcel").addEventListener("click", function () {
  var wb = XLSX.utils.table_to_book(document.getElementById("factoryTable"));
  XLSX.writeFile(wb, "Factory_List.xlsx");
});

// Load data on page start
loadFactories();

</script>
</body>
</html>